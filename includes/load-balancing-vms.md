<properties  writer="josephd" editor="tysonn" manager="dongill" />

# 負載平衡虛擬機器

您在 Azure 中建立的所有虛擬機器都可以自動使用私人網路通道，與相同雲端服務或虛擬網路中的其他虛擬機器進行通訊。所有其他輸入通訊，例如來自網際網路主機或其他雲端服務或虛擬網路的虛擬機器起始的流量，都需要端點。

端點可用於不同的目的。您使用 Azure 管理入口網站建立的虛擬機器上端點的預設用途和組態，可供遠端桌面通訊協定 (RDP) 和遠端 Windows PowerShell 工作階段流量使用。這些端點可讓您透過網際網路從遠端管理虛擬機器。

端點的另一個用途是 Azure 負載平衡器的組態，該組態可在多個虛擬機器或服務之間散發特定類型的流量。例如，您可以將 Web 要求的流量負載分散在多個 Web 伺服器或 Web 角色。

針對虛擬機器定義的每個端點都會被指派公用連接埠和私人連接埠，即 TCP 或 UDP。網際網路主機會將連入的流量傳送至雲端服務的公用 IP 位址和公用連接埠。雲端服務內的虛擬機器和服務便會在其私人 IP 位址和私人連接埠上接聽。負載平衡器將連入流量的公用 IP 位址和連接埠號碼對應至虛擬機器的私人 IP 位址和連接埠號碼，來自虛擬機器的回應流量也是如此。

當您在多個虛擬機器或服務間設定流量的負載平衡時，Azure 可為連入流量提供隨機的散發。

對於包含 Web 角色或背景工作角色執行個體的雲端服務，您可以在服務定義中定義公用端點。對於包含虛擬機器的雲端服務，您可以在建立端點時將其加入至虛擬機器，也可以稍後將端點加入。

下圖顯示在三部虛擬機器中共用，且公用和私人 TCP 連接埠均為 80 的標準 (未加密) Web 流量負載平衡端點。這三部虛擬機器均位在負載平衡集合中。

![loadbalancing](./media/load-balancing-vms/LoadBalancing.png)

當網際網路用戶端傳送網頁要求至雲端服務的公用 IP 位址與 TCP 連接埠 80 時，負載平衡器會對負載平衡集合中，介於這三部虛擬機器之間的要求執行隨機的平衡。

若要建立 Azure 虛擬機器的負載平衡集合，請使用下列步驟：

* [步驟 1：建立第一部虛擬機器](#firstmachine)
* [步驟 2：在相同雲端服務中建立其他虛擬機器](#addmachines)
* [步驟 3：使用第一部虛擬機器建立負載平衡集合](#loadbalance)
* [步驟 4：將虛擬機器加入至負載平衡集合](#addtoset)

## <a id="firstmachine"> </a>步驟 1：建立第一部虛擬機器

如果您尚未登入，請登入 [Azure 管理入口網站][1]。您可以使用 [從組件庫] 或 [快速建立] 方法，建立第一部虛擬機器。

* **從組件庫** - **從組件庫**
  方法可讓您在建立虛擬機器時建立端點，還可讓您指定在建立虛擬機器時所建立之雲端服務的名稱。如需相關指示，請參閱[建立執行 Linux   的虛擬機器](../virtual-machines-linux-tutorial)或[建立執行 Windows Server   的虛擬機器](../virtual-machines-windows-tutorial)。

* **快速建立** -
  選擇映像庫中的映像並提供基本資訊，即可建立虛擬機器。當您使用此方法時，您必須在建立虛擬機器後加入端點。此方法還可使用預設名稱建立雲端服務。如需詳細資訊，請參閱[如何快速建立虛擬機器](../virtual-machines-quick-create)。

**注意**：使用「快速建立」來建立虛擬機器後，管理入口網站的 [雲端服務] 頁面會列出新雲端服務名稱以及此服務的其他相關資訊。

## <a id="addmachines"> </a>步驟 2：在相同雲端服務中建立其他虛擬機器

使用「從組件庫」方法，在相同雲端服務中建立您的其他虛擬機器，做為第一部虛擬機器。

## <a id="loadbalance"> </a>步驟 3：使用第一部虛擬機器建立負載平衡集合

1.  在 Azure 管理入口網站中，按一下 **虛擬機器**，然後按一下第一部虛擬機器的名稱。

2.  選取 **端點**，然後按一下 **新增**。

3.  在 Add an endpoint to a virtual machine 頁面上，按一下向右箭頭。

4.  在 Specify the details of the endpoint 頁面上：
    
    * 在 **名稱** 中輸入端點的名稱，或從常見通訊協定的預先定義端點清單中選取。
    * 在 **通訊協定** 中，選取端點類型所需的通訊協定 (視需要選擇 TCP 或 UDP)。
    * 在 **公用連接埠** 和 **私人連接埠** 中，視需要輸入要虛擬機器使用的連接埠號碼。您可以在虛擬機器上使用私人連接埠和防火牆規則，以適合應用程式的方式來重新導向流量。私人連接埠可與公用連接埠相同。例如，對於 Web (HTTP) 端點的流量，您可以將連接埠 80 同時指派給公用和私人連接埠。

5.  選取 **Create a load-balanced set**，然後按一下向右箭頭。

6.  在 Configure the load-balanced set 頁面上，輸入負載平衡集合的名稱，然後指派 Azure 負載平衡器探查行為的值。負載平衡器會使用探查，來判斷負載平衡集合中的虛擬機器是否可用於接收連入流量。

7.  按一下核取記號以建立負載平衡端點。您會在虛擬機器的 **端點** 頁面的 **Load-balanced set name** 欄中看見 **是**。

## <a id="addtoset"> </a>步驟 4：將虛擬機器加入至負載平衡集合

建立負載平衡集合後，請將其他虛擬機器加入至集合。對於相同雲端服務中的每一部虛擬機器：

1.  在管理入口網站中，依序按一下 **虛擬機器**、虛擬機器的名稱、**端點**，然後按一下 **新增**。

2.  在 [Add an endpoint to a virtual machine] 頁面上，按一下 **Add endpoint to an existing load-balanced set**，選取負載平衡集合的名稱，然後按一下向右箭頭。

3.  在 [Specify the details of the endpoint] 頁面上，輸入端點的名稱，然後按一下核取記號。

<!-- LINKS -->



[1]: http://manage.windowsazure.com