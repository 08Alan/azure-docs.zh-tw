
<properties title="API basics for Azure Batch" pageTitle="Azure 批次的 API 基本概念" description="Concepts to introduce developers to the Azure Batch APIs and Batch service" metaKeywords="" services="batch" solutions="" documentationCenter=".NET" authors="yidingz, karran.batta" videoId="" scriptId="" manager="timlt" />

<tags ms.service="batch" ms.devlang="multiple" ms.topic="article" ms.tgt_pltfrm="na" ms.workload="big-compute" ms.date="10/27/2014" ms.author="yidingz, karran.batta" />


<!--The next line, with one pound sign at the beginning, is the page title--> 
# Azure 批次的 API 基本概念

Azure 批次服務為可調整和分散式計算提供作業排程架構。批次服務會維護一組位在 Azure 中不同叢集和資料中心的虛擬機器。批次服務會在指定的一組 VM 上，隨需求或排定在特定時間執行一個或多個程式，以完成分散式計算。批次服務會根據您所提供的資源需求、規格和條件約束，管理這些 VM 來執行您的計算工作。

藉由使用批次服務，您不需要自行撰寫程式碼來佇列、排程、配置及管理計算資源。這可讓您專注於特定的應用程式，而且不需要擔心基礎平台的作業排程及資源管理的複雜性。這也可讓批次服務最佳化這些作業的位置，以及它們如何存取需要處理的資料。

下列是批次服務可派上用場的一些案例：

- 密集運算的平行處理

- 每日清除檔案

- 批次處理

請參閱下列各節來進一步了解批次服務：

- [批次服務的資源](#resource)

- [批次服務的工作流程](#workflow)

- [檔案和目錄](#file)

- [調整應用程式](#scaling)

- [應用程式的憑證](#cert)

- [排程優先順序](#scheduling)

- [工作的環境設定](#environment)

## <a name="resource"></a> 批次服務的資源

當您使用批次服務時，您可以利用下列資源：

- [帳戶](#account)

- [工作虛擬機器](#taskvm)

- [集區](#pool)

- [工作項目](#workitem)

- [Job](#job)

- [工作](#task)

### <a name="account"></a>帳戶

批次帳戶是批次服務內唯一識別的實體。所有處理都是都透過批次帳戶執行。當您使用批次服務執行作業時，您需要帳戶的名稱和帳戶的金鑰。目前，您必須連絡 Azure 批次小組建立新的帳戶。建立帳戶之後會提供金鑰給您。

### <a name="taskvm"></a>工作虛擬機器

工作虛擬機器 (TVM) 是專門為您的應用程式處理特定工作負載的 Azure VM。TVM 大小決定 CPU 核心數目、記憶體容量，以及配置給 TVM 的本機檔案系統大小。TVM 可以是小型、大型或超大型虛擬機器，如 [Azure 的虛擬機器和雲端服務大小](http://msdn.microsoft.com/zh-tw/library/dn197896.aspx)中所述。

TVM 可以執行的程式類型包括可執行檔 (.exe)、命令檔 (.cmd)、批次檔 (.bat) 和指令碼檔案。TVM 也有下列屬性：

- 工作專用和共用的檔案系統資料夾

- 寫入至工作專用資料夾的Stdout.txt 和 stderr.txt 檔案

- 處理的環境變數

- 設定來控制存取的防火牆設定

### <a name="pool"></a>集區

集區是執行應用程式的TVM 集合。集區可以是您所建立，或當您指定要完成的工作時，由批次服務自動建立集區。您可以建立和管理符合您應用程式需求的集區。集區只能由建立它的批次帳戶使用。批次帳戶可以有多個集區。

系統會指派唯一的名稱及關聯的 IP 位址給加入至集區的每個 TVM。當 TVM 從集區移除時，就會失去對作業系統、其所有本機檔案、名稱及其 IP 位址所做的變更。當 TVM 離開集區時，其存留期就結束。

您可以設定集區來允許其中 TVM 之間的通訊。如果集區需要集區內的通訊，批次服務可讓集區中每個 TVM 上使用大於 1100 的連接埠。集區中的每個 TVM 都設定為允許與限制只接受這個連接埠範圍，且來自集區中其他 TVM 的連入連線。如果您的應用程式不需要 TVM 之間的通訊，批次服務可以將不同叢集或資料中心上的大量 TVM 配置給集區，以啟用更平行的處理。

當您建立集區時，您可以指定下列屬性：

- 集區中的 TVM 大小。

- TVM 上執行的作業系統系列和版本。

- 應該可供集區使用的 TVM 目標數目。

- 集區的調整原則。

- 集區中 TVM 的通訊狀態。

- 集區中 TVM 的啟動工作。

當您建立集區時，您可以指定應該與集區相關聯的儲存體帳戶。批次服務會從網路連線和頻寬容量較佳的資料中心，配置 TVM 給指定的儲存體帳戶。這樣可讓工作負載更有效率地存取資料。

### <a name="workitem"></a>工作項目

工作項目指定集區中的 TVM 上執行計算的方式。工作項目包含下列組態項目：

1.在 TVM 執行處理的程式。

2.程式的命令列參數。

3.計算的優先順序。

4.計算的排程，包括定義計算是否應該重複執行。

工作項目一律指派給集區，集區可以已存在，或在建立工作項目時自動建立。

### <a name="job"></a>Job

作業是工作項目的執行中執行個體，由一組工作所組成。批次服務會根據工作項目的設定來具現化作業。作業會使用與工作項目相關聯的集區中的 TVM。

### <a name="task"></a>工作

工作是與作業相關聯的計算單位且在 TVM 上執行。工作會使用下列資源：

- 工作項目中所指定的程式。

- 包含要處理之資料的資源檔。這些檔案會自動從 Blob 儲存體複製到 TVM。如需詳細資訊，請參閱「檔案和目錄」。

- 程式所需的環境設定。如需詳細資訊，請參閱「工作的環境設定」。

- 執行計算所根據的條件約束。例如，允許執行工作的最長時間、工作無法執行時應該重試的次數上限，以及檔案保留在工作目錄中的最長時間。

除了您可以定義在 TVM 上執行計算的工作以外，您還可以使用批次服務所提供的下列特殊工作：

- [啟動工作](#starttask)

- [作業管理員工作](#jobmanagertask)

#### <a name="starttask"></a>啟動工作

您可以將啟動工作與集區產生關聯，以設定集區中 TVM 的作業系統。安裝軟體和啟動背景處理序都是啟動工作可以執行的動作。啟動工作會在TVM 每次啟動時執行，且只要留在集區中就會持續執行。

啟動工作的定義方式是將 XML 區段加入至「加入集區」作業的要求內容。下列範例示範啟動工作的基本定義：

	{
		"commandLine":"mypoolsetup.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"mypoolsetup.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"maxTaskRetryCount":0
	}


#### <a name="jobmanagertask"></a>作業管理員工作

作業管理員工作會在所有其他工作之前啟動。作業管理員工作提供下列優點：

- 建立作業時由批次服務自動建立。

- 排程在作業中的其他工作之前。

- 縮小集區時，相關聯的 TVM 最後才會從集區移除。

- 需要重新啟動時，它有最高的優先順序。如果找不到閒置的 TVM，批次服務可能會終止集區中正在執行的其中一個工作，以便挪出空間供它執行。

- 此終止可能完全取決於作業中的所有工作終止。

作業中的作業管理員工作的優先順序不高於其他作業中的工作。不同作業之間，只注重作業層級優先順序。作業管理員工作的定義方式是將 XML 區段加入至「加入工作項目」作業的要求內容。下列範例示範作業管理員工作的基本定義：

	{
		"name":"jmTask",
		"commandLine":"myapp1.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp1.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"taskConstraints":
		{
			"maxWallClockTime":"PT1H",
			"maxTaskRetryCount":0,
			"retentionTime":"PT1H"
		},
		"killJobOnCompletion":true,
		"runElevated":false,
		"runExclusive":true
	}




## <a name="workflow"></a>批次服務的工作流程

您需要批次帳戶才能使用批次服務，您可以使用服務的多個資源來排程計算。當您使用批次服務建立分散式計算案例時，您可以使用下列的基本工作流程：

1.將您要在分散式計算案例中使用的檔案，上傳至 Azure 儲存體帳戶。這些檔案必須在儲存體帳戶中，批次服務才能夠存取它們。執行工作時，批次服務會將檔案載入至 TVM。

2.將相依的二進位檔案上傳至儲存體帳戶。二進位檔案包含工作所執行的程式及相依組件。這些檔案也必須從儲存體中存取，並載入至 TVM。

3.建立 TVM 集區。建立集區時，您可以指派要使用的工作虛擬機器大小。工作執行時，系統會從這個集區指派 TVM 給它。

4.建立工作項目。當您建立工作項目時會自動建立作業。工作項目可讓您管理工作的作業。

5.將工作加入至工作項目。每個工作會使用您已上傳的程式，以處理您上傳的檔案中的資訊。

6.監視輸出的結果。

## <a name="files"></a>檔案和目錄

每個工作會在其工作目錄下建立零個或多個目錄和檔案，以儲存工作執行的程式、工作處理的資料，以及工作執行之處理的輪出。這些目錄和檔案可供作業執行期間的其他工作使用。TVM 上的所有工作、檔案和目錄由單一使用者帳戶擁有。

批次服務會在 TVM 上公開檔案系統的一部分作為根目錄。TVM 的根目錄是透過 WATASK\_TVM\_ROOT\_DIR 環境變數提供給工作使用。如需有關如何使用環境變數的詳細資訊，請參閱「工作的環境設定」。

根目錄包含下列子目錄：

- **工作** - 此位置是屬於 TVM 上執行的工作的所有檔案的儲存位置。對於每個工作，批次服務會建立具有唯一路徑的工作目錄，格式為 %WATASK\_TVM\_ROOT\_DIR%/tasks/workitemName/jobName/taskName/。這個目錄可供讀取/寫入工作。工作可以建立、讀取、更新和刪除此目錄下的檔案，此目錄會根據工作指定的 RetentionTime 條件約束而保留。

- **共用** - 此位置是帳戶下所有工作的共用目錄。在 TVM 上，共用目錄位於 %WATASK\_TVM\_ROOT\_DIR%/shared。這個目錄可供讀取/寫入工作。工作可以建立、讀取、更新和刪除此目錄下的檔案。

- **啟動** - 啟動工作使用這個位置做為它的工作目錄。由批次服務下載來執行啟動工作的所有檔案，也儲存在此目錄下。在 TVM 上，啟動目錄位於 %WATASK\_TVM\_ROOT\_DIR%/start。工作可以建立、讀取、更新和刪除此目錄下的檔案，啟動工作可以使用此目錄來設定作業系統。

當 TVM 從集區移除時，也會移除所有儲存在 TVM 上的檔案。

## <a name="scaling"></a>調整應用程式

您的應用程式可以輕易地自動相應放大或縮少，以配合您需要的計算。您可以根據目前的工作負載和資源使用量統計資料，動態調整集區中的 TVM 數目。您也可以將您的應用程式設定成自動調整，以最佳化執行應用程式的整體成本。您可以在建立集區時指定調整設定，也可以隨時更新組態。

您可以使用一組調整公式來指定自動調整應用程式。這些公式可以用來決定下一個調整間隔在集區中的 TVM 數目。例如，您需要提交大量要在的集區上排定的工作。您可以指派調整公式給集區，以根據目前的暫止工作數目和工作的完成率來指定集區大小。批次服務會定期評估公式，並根據工作負載來調整集區大小。

公式可以根據下列度量資訊：

- **時間度量** - 根據指定的時數內每隔五分鐘收集的統計資料。

- **資源度量** - 根據 CPU 使用量、頻寬使用量、記憶體使用量和 TVM 的數目。

- **工作度量** - 根據狀態的工作，例如使用中、暫止和已完成。

如需自動調整應用程式的詳細資訊，請參閱「設定自動調整工作虛擬機器」。

## <a name="cert"></a>應用程式的憑證

當您加密機密資訊時，您通常需要使用憑證。憑證可以安裝在 TVM 上。加密機密資料會透過命令列參數或內嵌在其中一個資源中而傳遞至工作，已安裝的憑證可用來解密機密資料。儲存體帳戶的金鑰就是機密資訊。

您可以使用「加入憑證」作業將憑證加入至批次帳戶。然後，您可以將憑證與新的或現有的集區產生關聯。當憑證與集區相關聯時，批次服務會在集區中的每個 TVM 上安裝憑證。當 TVM 啟動時，在啟動任何工作之前，包括啟動工作和作業管理員工作，批次服務會安裝適當的憑證。

## <a name="scheduling"></a>排程優先順序

當您建立工作項目時，您可以指派優先順序給它。工作項目底下的每個工作都以此優先順序建立。批次服務會使用作業的優先順序值，以決定帳戶內的作業排程順序。優先順序值可以介於 -1000 到 1000，-1000 表示最低優先順序，1000 表示最高優先順序。您可以使用 UpdateJob 作業來更新作業的優先順序。

在相同的帳戶內，較高優先順序的作業具有比低優先順序作業更高的排程優先順序。一個帳戶中具有較高優先順序值的作業，其排程優先順序並不高於不同帳戶中較低優先順序值的另一項作業。

不同集區的作業排程各自獨立。在不同的集區之間，即使作業的優先順序較高，如果其相關聯的集區缺少閒置的 TVM，並不保證此作業會優先排程。在相同的集區上，相同優先順序等級的作業有相同的排程機會。

## <a name="environment"></a>工作的環境設定

您可以指定適用於工作的環境設定。對於啟動工作及作業下執行的工作，環境設定的定義方式是將 XML 區段加入至「加入工作」或「更新工作」作業的要求內文。

下列範例顯示環境設定的定義：

對於作業下排程的每項工作，批次服務會設定一組特定的環境變數。下表列出批次服務為所有工作所設定的環境變數。

<table>
  <tr>
   <th>環境變數名稱
   </th>
   <th>
   說明
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  工作所屬的帳戶名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >工作所屬的工作項目名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >工作所屬的作業名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >目前工作的名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >執行工作的集區名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >執行工作的 TVM 名稱。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >TVM 上的根目錄完整路徑。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW
  WATASK_PORTRANGE_HIGH
</td>
<td>
  啟用集區內部通訊時，可供工作用於通訊的連接埠範圍 (含首尾)。
</td>
</table>


**注意** 

您無法覆寫這些系統定義的變數。

您可以使用「取得工作」作業來擷取環境設定的值。
