<properties
	pageTitle="實作範本最佳做法的內容範例"
	description="顯示說明最佳做法的 Azure 資源管理員範本範例。"
	services="azure-resource-manager"
	documentationCenter=""
	authors="mmercuri"
	manager="georgem"
	editor="tysonn"/>

<tags
	ms.service="azure-resource-manager"
	ms.workload="multiple"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/16/2015"
	ms.author="mmercuri"/>

# 實作範本最佳做法的內容範例

本主題提供如何實作 Azure 資源管理員範本的 7 個內容範例。如需這些範例中所闡述的準則概觀，請參閱[設計 Azure 資源管理員範本的最佳做法](best-practices-resource-manager-design-templates.md)。

## 將已設定功能範圍的範本移至已設定端對端解決方案範圍的範本

我們稍早共用了開發已設定功能範圍的範本模式。您可能自問的一個問題是，若要單獨使用這個已設定功能範圍的範本，或做為已設定端對端範圍的解決方案範本一部分來使用，是否會有不同的考量。

例如，如果有一個著重於技術的範本會部署 SQL Server 做為功能，從單獨使用該範本，或是做為範圍更廣泛且已設定端對端解決方案範圍的範本 (可能使用該 SQL Server 來支援 Web 應用程式) 一部分的觀點來看，就應將其列入考量 (如果有的話)。

查看此案例時，最好一併查看可能涉及的資源數量。在健全的實作中，已設定功能範圍的範本不只是儲存體帳戶以及已安裝一部 SQL Server 的單一 VM。健全且已設定功能範圍的範本將部署多個已部署 SQL Server 的 VM，來取得高可用性。針對某些功能 (例如 Analysis Services)，您的拓撲很可能也會具備和它一起部署的 Active Directory。

針對此案例的兩個重要考量包括將如何使用 SQL Server 的週期，以及您想要套用到其中的 RBAC。具體而言，SQL Server 將會更新並在剩餘的解決方案中加以刪除，或者它的週期將因為來自解決方案或解決方案的其他部分而有所不同。如果週期將會變動，則您會想要考慮將其放置在另一個資源群組中。

另一個考量是您想要如何將 RBAC 套用到 SQL Server 已設定功能範圍的解決方案範本。您可以根據想要在拓撲內套用 RBAC 的方式，選擇不同的資源群組來配合這些細節。您可以在資源層級套用 RBAC，但若已針對 SQL Server 已設定功能範圍的解決方案範本指定資源數量，則應考量已將 RBAC 套用到其中的不同資源群組。

另一個考量是評估 SQL Server 已設定功能範圍的解決方案範本，來識別它目前是否會自行建立某些資源，以及是否允許您「自備資源」。 在「自備資源」(BYOR) 模型中，已設定功能範圍的解決方案範本可讓您的範本利用像是儲存體帳戶、虛擬網路或可用性設定組的典型範例，重複使用先前存在的資源。如果 BYOR 方法不存在於已設定功能範圍的範本中，您可以使用本文件稍早針對選擇性資源範本所定義的方法來改變它。在此情況下，已設定端對端解決方案範圍的範本必須具備含有這些常見資源的共用資源範本，而且會擴充已設定功能範圍的範本，支援這些資源成為選擇性項目。這會建立較佳的已設定功能範圍的解決方案範本，因為它現在可以單獨使用或做為組合的一部分來使用。

評估是否應該從已設定端對端解決方案範圍的範本中傳入儲存體帳戶時，也應該重新評估 RBAC。具體來說，您需要確保 RBAC 會套用到這個特定的資源嗎？ 如果是，若預期資源在傳入時應已套用此項，則不只要將信任層級放置於解決方案區塊中，而且還要為任何單獨使用時希望選擇性地為已設定功能範圍的範本提供此項的使用者提供信任層級。如果 RBAC 很重要，則您應考慮讓此項成為已設定功能範圍的解決方案範本內的選擇性範本，或者要求從已設定功能範圍的解決方案範本中使用必要的 RBAC 來建立它。

如果決定要將這些項目放置於不同的資源群組中，您也可以使用資源連結來定義資源之間的關聯性，即使資源會橫跨資源群組也一樣。

## 使用多個已設定功能範圍的範本來建立已設定端對端解決方案範圍的範本

這主要是前一個範例的超集。在此案例中，某組織擁有多個適用於一組資料技術且已設定功能範圍的解決方案範本 (例如，Kafka、Apache Hadoop、Apache Spark 及 Apache Storm)，而他們希望將它們合併在一起成為單一解決方案區塊。產生的組合將使用這些已設定功能範圍的解決方案範本，以及具有特定子網路指派的共用儲存體和虛擬網路。

在所需且特定的已設定功能範圍的範本外部，需要針對解決方案使用其他資源，即使只是使用指令碼來將已設定功能範圍的範本聯結在一起並設定它們。

在此案例中，會識別出有一個共用的虛擬網路和一個共用的儲存體帳戶。考慮到這一點，您應該在已設定端對端解決方案範圍的範本中，將這些項目新增到共用的資源範本，並確定已設定功能範圍的範本支援「自備資源」方式。如果沒有，您可以修改已設定功能範圍的範本來配合這一點，如上一個範例所述。

針對您將新增的其他資源，您將會遵循用來建立個別已設定功能範圍的範本的模式超集。在此案例下，您將會新增共用資源範本、選擇性資源範本、成員節點範本，以及適用於新資源的期望狀態組態 (指令碼、Chef、Puppet、Powershell DSC)。其中具有相依性，而您將進行最佳化來使用隱含的參考和 dependsOn，其中可能會消除偏離相依性的可能性，這類相依性可能會影響部署的平行處理原則 (及速度)。您也會考慮這些資源的週期、RBAC 考量及相依性，來判斷是否應將它們放置於不同的資源群組。

新增共用資源時 (例如，共用儲存體帳戶)，您也應該評估是否需要為它進行資源鎖定，這樣有助於避免遭到意外刪除。

新增資源時，您也應該檢查是否可將任何已新增到已設定端對端解決方案範圍範本的資源隔離出來，做為它們自己的已設定功能範圍範本。如果可以，應該將此動作強烈視為將分解進一步升級，以便同時提供重複使用和測試的優點。

在解決方案區塊中進行整合時，您的後續考量如下：就像上一個範例中所識別的，若要識別個別已設定功能範圍的解決方案範本週期是否與範圍更廣泛的解決方案週期不同，以及是否有任何 RBAC 需求必須將這些分隔成不同的資源群組。

最後，您會希望考慮是否想要能夠定義和查詢資源之間的連結。如果這樣做，則採用資源連結將可讓您跨越已設定端對端範圍的解決方案範本來執行此動作，即使是跨越多個資源群組也一樣。

## 利用部分開/關模式建立已設定端對端解決方案範圍的範本

這個案例是前一個案例的變化。在此案例中，客戶會在一天的行程中以固定間隔來從內部部署系統中擷取資料。他們具有資料管線來處理這個內送的資料，以及一律可使用資料進行查詢的關聯式資料存放區。由於雲端是一個隨收隨付模型，因此，客戶只想在這些資料顯示為可處理時，才在這些間隔中讓資料管線運作。

做為其資料管線的一部分，它們具備 SQL Server，來接收已處理的資料，並使用它來進行查詢。客戶表示，雖然他們想要在固定的排程中開啟和關閉管線的擷取和處理程序，但他們想讓 SQL Server 永遠可供使用。

在此案例中，在週期方面似乎有一些顯著的差異，而且可能有一些客戶未提及但應進行評估的其他考量。

如前所述，在將建立和刪除其他資源的同時，SQL Server 部署會保持運作。一開始會一起部署它們，但接下來會在不同的週期中終結和建立範本的其他成員。您可以將這些項目隔離到不同的資源群組，或者將它們留在與套用到 SQL Server 資源的資源鎖定相同的資源群組中。如先前範例所述，具體來說，由於 SQL Server 很可能會顯示為較大型的資源組合，因此將它從它自己的資源群組中分隔出來可能較為適當。

另一個考量是，儘管客戶表示他們想要在排程中開啟或關閉資料管線的其餘部分，但可能不會考慮採用行為不一致的報告系統。來自協力廠商的資料排程傳遞不一定準確 - 可能會有一段期間無法使用連線、在本機或雲端架構伺服器上的時鐘可能會漂移、時間變更不一定如預期般發生等等。如果您的擷取機制也應該用於開啟/關閉模式中，而且若是如此，如果它的週期大於處理元件的週期，那麼，就應該評估它。

如果您正在使用受管理的服務 (例如 Azure Data Factory 或事件中心)，當它們的作業模型與相關聯的計費方式讓它們能夠輕易地用來擷取您的資料並將它放在儲存體中，這就不是問題。如果您使用另一個已部署到虛擬機器的技術 (例如 Kafka)，則可能想要查看如何使該技術及相關聯的儲存體帳戶成為擷取所需項目的週期。這可能會根據其週期，引發放置於不同資源群組中資源的擷取和處理。

## 支援訂用帳戶內的不同環境

為了有效提供服務，許多組織都會有一組規模，其中包含必須符合的計費隔離、權責隔離，以及地理隔離需求。設計適用於 Azure 的服務時，他們會利用他們的方法來進行過去曾使用的訂用帳戶資料分割，以滿足這些需求。

資源管理員會放寬可部署於訂用帳戶內之指定類型之資源數量限制，也會引進它的資源群組、RBAC 及稽核。這些項目的組合讓組織能夠使用資源群組進行資料分割，使他們能夠符合需求，並減少他們可能必須進行的訂用帳戶資料分割的數量 (如果有的話)。

本節探討適用於這些環境類型的需求，並提供如何傳遞使用 ARM 來滿足它們之環境的相關指引。

### 隔離考量

本節將更詳細地探討適用於環境、計費及地理位置隔離的常見客戶驅動程式。

#### 環境隔離

服務擁有者想要隔離他們的不同環境。隔離每個環境讓團隊能夠對於擁有環境存取權的對象具備更細微的控制權。儘管開發環境在誰能存取它們的方面可能更開放，但當環境範圍更接近實際執行環境時，使用者的數量 (它們可以是人類或用來自動化的系統帳戶) 會減少以協助遵循相容性，並將整體風險降至最低。

#### 計費隔離 - 開發與執行服務

為了精確地反映已售出貨物成本 (COGS) 和營業費用 (OpEx)，企業擁有者想要能夠打散研究與建置服務以及執行服務的成本。

如先前所述的環境隔離超集，其目的是合併適用於個人的開發與測試和 (或) 針對前者所進行的彙總計費，而實際執行環境還能針對後者保持獨立。

#### 計費隔離 - 將透明度和權責加入服務取用成本中

計費隔離也適合用來在特定團隊用於進行與平台取用相關的成本中增加透明度，並引進適當的權責層級。

雖然雲端非常具有彈性且允許用於隨收隨付模型，但這對於來自非雲端模型且已購買並擁有硬體的某些開發人員來說是非常陌生的。在非雲端模型中，有一些關於可能已開啟之「機器」數目的實體限制，而且在資源未使用時縮小範圍或加以關閉的誘因有限。在許多情況下，此專用硬體的採購並不是由要使用它的開發人員所完成。

藉由隔離訂用帳戶並將這些訂用帳戶的權責指派給特定團隊，服務擁有者發現這類型的訂用帳戶資料分割對於驅動並強制執行所需行為是非常有幫助的。

#### 地理導向的隔離 - 特有且受到特定地理位置之法律所規範的部署

在某些內容中，有一些需求是以特定地理位置為目標的服務需要考慮它們如何部署來處理相容性考量。

雖然服務本質上可能是全域的，但位於其中的部署或提供服務給特定地理位置的部署可能會受到操作人員需求所規範。具體而言，只有特定國家/地區或國家/地區組合的居民和 (或) 傳遞特定背景檢測程序的個人能夠操作這些服務。

地理位置隔離也提供了利用新的平台服務和功能的優點。某些地理位置 (例如中國) 可能只會有平台服務子集可供使用，且 (或) 已延遲平台服務的部署。

地理位置隔離讓團隊能夠發展他們的服務，以便在新的或增強的平台服務和功能可供使用時充分使用它們。

### 相容性考量

服務可以跨多個地理位置傳遞至縱向市場。這些對象通常具有機密資料或包含在其應用程式內的處理程序，而且會有設計來保護它們以及利用它們來稽核業務開發的相關聯相容性規範。

#### 分隔角色和責任

分隔角色與責任是內部服務要與內部原則相容的主要需求。許多商業服務也會要求這一點，以便繼續遵循政府與業界法規的指導方針。在特定情況下，服務需要將對服務及其基礎資源的存取權限制為已授權的角色。許多服務已建立樣板來提供下列兩個功能：RBAC 和稽核。

#### 角色型存取控制 (RBAC) 使用案例

在相容性案例中，請務必限制某些資源的存取權。

例如，在跨多個與相容性相關的案例 (健康資訊、財務資歷及稅務記錄等) 查看機密資料時，請務必限制能夠存取、檢視或操作資料的人員數目，僅允許需要存取權來執行上層組織業務的人員。

在已識別的情況下，RBAC 可為不同的個人、系統或群組提供特定資源的存取權。

#### 稽核

除了 RBAC 所提供的存取限制之外，組織也需要稽核資源存取，以及與資源之間的互動。

### 使用 Azure 資源管理員進行實作

組織先前就曾使用訂用帳戶資料分割來達成這些目標。儘管可行，但這不理想。由於建立訂用帳戶實際上是一個商業活動，因此，服務管理 API 不會公開用來自動建立或刪除新訂用帳戶以及需要手動建立訂用帳戶的機制。產生的訂用帳戶數目可能會大幅成長 (適用於非常大型的服務，例如 Microsoft 自己提供的商業服務)，該數目可能會持續成長，因而超越一千個訂用帳戶。這樣做的結果通常是建立自訂樣板，來建立與管理組織的訂用帳戶。

使用資源管理員，在一個訂用帳戶內部署多個環境會變得更容易。它會放寬先前固定於資源上的端點 (這類資源位於先前模型中)，以大幅減少因資源限制而產生的資料分割需求。

環境可以放置於資源群組中，可將特定的 RBAC 套用到它們，讓您能夠提供環境隔離。在需要地理位置隔離的案例中，這也可以利用資源群組來達成。若資源群組可橫跨地理位置，即可針對一或多個地理位置達成特定的隔離。

您可以將標記套用到資源和資源群組，在進行帳單彙總和摘要檢視時用來提供計費隔離。您可以使用標記來定義環境類型 (研究、教育、開發、測試、生產)、權責組織或個人 (“HR”、“Finance”、“John Smith”、“Jane Jones”)。

稽核需求會當成基礎 Azure 資源管理員的一組全新功能來提供，並可在中央位置進行檢視。

客戶會擁有已在 Azure Active Directory 中登錄的帳戶，其可用來進行驗證，以及用於環境與資源的角色型存取控制。

#### 將密度最佳化

儘管已在 Azure 資源管理員中放寬資源限制，但仍會有限制。除了建立環境本身之外，您也應該查看訂用帳戶內環境的達成密度。提供環境就是為個人或組織提供容量，而您應該評估將要提供哪些相關的「T 恤尺寸」。具體來說，可根據所需的資源來找出小型、中型、大型及超大型客戶之間的變化。

您可以選擇針對不同的 T 恤尺寸使用不同的訂用帳戶來達成更高的密度。例如，您能夠在指定的訂用帳戶中，容納 1000 個小型 T 恤尺寸環境、500 個中型部署、100 個大型部署，以及 10 個超大型部署。由於不需付費就能擁有多個訂用帳戶，因此，您可能想要將不同的大小隔離為不同的訂用帳戶，以提供最大密度。您可以這樣做，同時保留相對適用且易於管理的訂用帳戶數目。

您應該思考的一個重要考量是，識別您是否願意允許客戶增加或變更他們的 T 恤尺寸，如果是，則您想要如何配合它。

其中一個方法是讓客戶可以在其現有的資源群組內取得額外容量。技術上來說，這很容易達成，但會對密度造成影響。這可引進變化性層級，為將密度最佳化的作業增添更多額外負荷，而不需為所有客戶清楚定義大小。如果每個小型環境的大小是 X，則您可以輕易地預先計算可在訂用帳戶中放置多少個小型環境，以取得最佳密度。若允許客戶自訂環境，結果就是會針對環境的變化與數量產生無法預期的數字 (可能是 X、X+1、X+2，依此類推)。使用這個變化性層級，當您需要在訂用帳戶中儲存容量以容納這些變異數時，就能達成較低密度。

儘管可行，但比起一般處理方法來說這是不盡理想的，雖然它可達成較低密度，但需要更多要管理的額外負荷。對於較大型環境，這可能是更可行的選項。由於這些可放置於訂用帳戶中的大型和超大型環境數目較少，因此，您可以選擇在訂用帳戶中放置較少數目的這類環境，以配合數量的成長。

另一種方法是刪除客戶目前大小的環境，並建立不同大小的新環境。儘管這不適合某些案例，但卻非常適合暫時使用的環境，例如開發和測試環境。

此處的下一個最簡單方法是讓客戶能夠取得較大尺寸的環境，然後自行管理移至該環境的移轉。例如，已在小型環境中部署 SQL Server 的客戶能夠購買中型環境，並各自負責傳輸資料與自訂狀態。

替代的方法是提供受管理的服務，以配合這個從某個大小到另一個大小的轉換。這顯然更為複雜，但基於工作負載和客戶，這可能是您的組織可能願意配合的事項。

## 提供含有其他客戶原則限制的環境

某些組織對於他們部署的環境具有額外的需求與原則。具體來說，他們所擁有的原則會限制已在外部公開的連接埠，而且可能會有需要監視環境的輸入和輸出流量的原則。針對支援能力和成本考量，也可能會限制使用者可以建立、更新或刪除哪些資源。針對提供環境的組織，他們通常也需要存取訂用帳戶以取得支援。

做為上一個案例的超集，這需要新增特定資源，其中含有一些額外限制，來限制能夠建立與無法建立指定資源類型的人員。

您可以使用角色型存取控制，來限制使用者建立、更新或刪除特定資源的能力。範例包括要求特定網路 VNET 的組織，以及客戶可能無法更新或刪除的子網路。

您可以實作資源鎖定來建立唯讀或無法刪除的資源。RBAC 可用來允許使用者或服務主體針對資源或資源群組執行某些活動。

如果組織需要該特定流量 (例如，應用程式中層級間的流量)，請先瀏覽媒介 (例如虛擬網路應用裝置)，接著應使用使用者定義的路由。

虛擬應用裝置無非就是一個 VM，可執行用來以某種方式處理網路流量的應用程式，例如防火牆或 NAT 裝置。有許多協力廠商會在 Azure 上提供虛擬網路應用裝置，而組織也可以自備。

「自備」應用裝置的方法讓組織能夠重複使用現有的程式碼，該程式碼可能已在其內部部署環境中使用。此虛擬應用裝置 VM 必須能夠接收未定址到本身的連入流量。若要讓 VM 接收定址到其他目的地的流量，您必須在 VM 中啟用 IP 轉送。

如同先前的範例，您應檢閱資源的週期和 RBAC 限制，並將其視為資源群組策略的一部分。

## 保護資源以防止內部的不良執行者

針對組織的其中一個考量可能是保護他們的資源，以及由不良執行者佈建它們的範本。

此情況的範例之一是，銀行希望確保惡意軟體開發人員或其 IT 人員的成員無法基於犯罪目的進行修改或擷取重要資訊，因而導致資料流向不良的執行者。

一般企業案例則是，擁有一小群受信任的操作員 (他們可以存取所部署工作負載內的重要密碼)，以及一大群可建立或更新 VM 部署的開發/操作人員。

Azure 金鑰保存庫可與 ARM 搭配使用，來協調和儲存 VM 密碼和憑證。

最佳做法是維護個別的 ARM 範本，以進行保存庫的建立 (其中將包含金鑰內容) 及 VM 的部署 (與保存庫中所包含金鑰的 URI 參考)。

金鑰保存庫中儲存的密碼受到受信任的操作員的完整 RBAC 控制。如果受信任的操作員離開公司或轉移到公司內部的新群組，他們就不能再存取他們在保存庫中建立的金鑰。

適用於部署的 ARM 範本僅包含密碼的 URI 參考，也就是說，實際的密碼不在程式碼、組態或原始程式碼儲存機制中。這樣做可降低以網路釣魚方式詐騙密碼的機會，以及限制不良執行者進行變更的能力。

如同文件稍早所述，並未提供通用的金鑰保存庫。由於金鑰保存庫永遠是地區性的，因此，密碼與 VM 永遠具有區域性 (以及主權)。

這種方法的實作範例已在＜密碼和憑證＞一節中提供，您可以在本文件稍早內容中找到此節。

## 啟用「自備訂用帳戶」模型

企業 IT、系統整合者和雲端服務廠商可能會對客戶採用「自備訂用帳戶」模型。具體來說，組織會為客戶提供服務，並以相同方式來利用該客戶的 Azure 訂用帳戶。

這個方法有各種不同變化，每個都有些微不同的需求，詳情如下。

### 讓協力廠商有權監視帳戶內的資源

具有監視應用程式的組織可能需要客戶訂用帳戶的唯讀存取權，來擷取要在該應用程式中使用的資料。此動作在持續使用期間都需要有唯讀存取權。存取必須位於客戶的控制項中，如果已提供與監視服務之提供者間的關聯性，則讓他們能夠終止存取權。

#### 使用 Azure 資源管理員進行實作

您可以在＜使用 Azure資源管理員 API 進行授權的開發人員指南＞中取得實作此動作的詳細資料 (您可以在[此處](http://www.dushyantgill.com/blog/2015/05/23/developers-guide-to-auth-with-azure-resource-manager-api/)找到該文件)。該文件提供逐步實作指示與範例程式碼。

### 讓協力廠商能夠存取一次性部署的軟體

在另一個範例中，組織可能會在客戶的帳戶中部署和設定其軟體的版本，這要求在部署期間具備寫入權限。

#### 使用 Azure 資源管理員進行實作

這會遵循類似先前範例的方法。

根據安裝的特定需求而定，指派給服務主體的特定角色應該僅允許完成安裝所需的最小存取權限等級，然後在安裝完成之後立即撤銷該存取權。

### 讓協力廠商有權使用客戶的訂用帳戶來儲存資料

在另一個範例中，組織可能想要在自己的環境中執行軟體，但使用客戶的帳戶來儲存。這樣一來，客戶隨時都能控制他們的資料，並讓他們能夠自行斟酌來運用平台上的其他技術 (例如，Azure Machine Learning 或 HDInsight)，同時不會為提供該功能的企業 IT、系統整合者或 CSV 增加成本/計費額外負擔。這需要在客戶的控制下持續存取組織的儲存體帳戶，並有權存取稽核資訊，以便存取該資訊。

#### 使用 Azure 資源管理員進行實作

這是使用與其他範例相同的模式來實作。服務主體會被授與儲存體資源的存取權。由於此案例需要角色具備儲存體帳戶的讀取和寫入權限，因此，會將內建的參與者角色指派給服務主體，以達到這個存取等級。

因為此案例涉及具有共用儲存體帳戶的第一方和第三方，所以，也想確定儲存體帳戶不會遭到意外刪除。針對這方面的案例，您會將資源鎖定套用到儲存體帳戶。

### 透過協力廠商啟用服務管理

在另一個範例中，組織想要部署、監視和管理客戶訂用帳戶中的軟體。在客戶能夠 (或更明確地無法) 為部署軟體的環境進行的變更方面可能有一些限制 。

#### 使用 Azure 資源管理員進行實作

這會遵循本節一開始所識別的模式超集。具體來說，系統會為協力廠商所使用的服務主體提供資源群組內資源的完整存取權。

此外，如果有客戶限制，就會為來自客戶的使用者或群組授與適當的權限來利用環境。這可透過範本來完成，如本節稍早內容中所提及。

最後，可能想要確保特定資源不會遭到意外刪除。如果發生這種情況，資源鎖定也應該被視為要求這類保護的資源。

## 後續步驟

- 若要了解如何建立範本，請參閱[撰寫範本](resource-group-authoring-templates.md)。
- 如需如何在 Azure 資源管理員中處理安全性的建議，請參閱 [Azure 資源管理員的安全性考量](best-practices-resource-manager-security.md)。
- 若要了解進出範本的共用狀態，請參閱 [Azure 資源管理員範本中的共用狀態](best-practices-resource-manager-state.md)

<!---HONumber=August15_HO6-->