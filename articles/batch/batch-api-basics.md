<properties 
	pageTitle="Azure 批次的 API 基本概念" 
	description="向開發人員介紹 Azure 批次 API 及批次服務的概念" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="07/14/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Azure 批次的 API 基本概念

Azure 批次服務為可調整和分散式計算提供作業排程架構。批次服務會維護一組位在 Azure 中不同叢集和資料中心的虛擬機器。批次服務會在指定的一組節點上，隨需求或排定在特定時間執行一個或多個程式，以完成分散式運算。批次服務會根據您所提供的資源需求、規格和條件約束，管理這些節點來執行您的運算工作。

藉由使用批次服務，您不需要自行撰寫程式碼來佇列、排程、配置及管理計算資源。這可讓您專注於特定的應用程式，而且不需要擔心基礎平台的作業排程及資源管理的複雜性。這也可讓批次服務最佳化這些作業的位置，以及它們如何存取需要處理的資料。

下列是批次服務可派上用場的一些案例：

- 密集運算的平行處理

- 每日清除檔案

- 批次處理

## <a name="resource"></a>批次服務的資源

當您使用批次服務時，您可以利用下列資源：

- [帳戶](#account)

- [運算節點](#computenode)

- [集區](#pool)

- [作業](#job)

- [Task](#task)

	- [啟動工作](#starttask)
	
	- [作業管理員工作](#jobmanagertask)

- [JobSchedule](#jobschedule)

### <a name="account"></a>帳戶

批次帳戶是批次服務內唯一識別的實體。所有處理都是都透過批次帳戶執行。當您使用批次服務執行作業時，您需要帳戶的名稱和帳戶的金鑰。若要建立批次帳戶，請參閱 [Azure 批次概觀][]的＜批次帳戶＞一節。


### <a name="computenode"></a>運算節點

運算節點 (節點) 是專門為您的應用程式處理特定工作負載的 Azure 節點。節點大小決定 CPU 核心數目、記憶體容量，以及配置給節點的本機檔案系統大小。節點可以是小型、大型或超大型虛擬機器，如 [Azure 的虛擬機器和雲端服務大小](http://msdn.microsoft.com/library/dn197896.aspx)中所述。

節點可以執行的程式類型包括可執行檔 (.exe)、命令檔 (.cmd)、批次檔 (.bat) 和指令碼檔案。節點也有下列屬性：

- 工作專用和共用的檔案系統資料夾。每個集區節點上都會建立一個資料夾結構和數個環境變數。系統會建立下列資料夾結構，其中包含可供工作間的應用程式和資料共用的 “shared” 資料夾，再加上每個工作的資料夾。

<pre><code> ─ %AZ_BATCH_NODE_ROOT_DIR%
   ├─shared
   ├─startup
   └─&lt;JOB_ID>
     ├─&lt;TASK_ID_1>
     │ └─wd
     └─&lt;TASK_ID_2>
       └─wd
</code></pre>


- 寫入至工作專用資料夾的Stdout.txt 和 stderr.txt 檔案

- 處理的環境變數

- 設定來控制存取的防火牆設定

>節點存取
>
>若需要存取節點 (如為了偵錯)，您可以取得 RDP 檔案並使用它透過遠端桌面存取該節點。


### <a name="pool"></a>集區

集區是您的應用程式執行所在之節點的集合。集區可以是您所建立，或當您指定要完成的工作時，由批次服務自動建立集區。您可以建立和管理符合您應用程式需求的集區。集區只能由建立它的批次帳戶使用。批次帳戶可以有多個集區。

Azure 批次集區的建置基礎為核心 Azure 運算平台；批次集區提供大規模的配置、應用程式和資料安裝、資料移動、健康狀態監控，以及節點的彈性調整。

系統會指派唯一的名稱及關聯的 IP 位址給加入至集區的每個節點。當節點從集區移除時，就會失去對作業系統、其所有本機檔案、名稱及其 IP 位址所做的變更。當節點離開集區時，其存留期就會結束。

您可以設定集區來允許其內部節點之間的通訊。如果集區需要集區內的通訊，批次服務可讓集區中每個節點上使用大於 1100 的連接埠。集區中的每個節點都設定為允許與限制只接受這個連接埠範圍，且來自集區中其他節點的連入連線。如果您的應用程式不需要節點之間的通訊，批次服務可以將不同叢集或資料中心上的大量節點配置給集區，以啟用更平行的處理。

當您建立集區時，您可以指定下列屬性：

- 集區中**節點的大小**。
	- 根據將於節點上使用的一或多個應用程式的特性和需求，來選擇適當的節點大小。挑選節點大小時通常會假設將立即在節點上執行一項工作。例如，應用程式是否為多執行緒以及需要多少記憶體將會決定最適合且具成本效益的節點大小。有可能出現已指派多項工作且平行執行多個應用程式執行個體的情況，此時通常會選擇較大的節點 – 請參閱下面的「每個節點的工作上限」。 
	- 集區中所有節點的大小必須相同。如果要以不同的系統需求和 (或) 不同的負載來執行不同的應用程式，則應建立不同的集區。
	- 除了 A0 以外，可為集區設定所有的雲端服務節點大小。

- 在節點上執行的作業系統系列和版本。
	- 如同背景工作角色一樣，可以設定作業系統系列和作業系統版本。
	- 作業系統系列也會決定哪些版本的.NET 會與作業系統一起安裝。
	- 如同背景工作角色一樣，建議對作業系統版本使用 "\*"，以便自動升級節點，而且不須為了迎合新版本而執行工作。挑選特定作業系統版本的主要使用案例是為了確保維護應用程式相容性，其方法是允許在更新版本之前執行回溯相容性測試。一旦通過驗證，即可更新集區的作業系統版本並安裝新的作業系統映像 – 將會中斷任何執行中的工作並重新排入佇列。

- 應可供集區使用的目標節點數目。

- 集區的調整原則。除了節點數目以外，您也可以指定每個集區的自動調整公式。批次服務將會執行此公式，根據集區和工作項目統計資料來調整節點數目。

- 排程組態
	- 預設組態適用於隨時要在集區節點上執行的一項工作，但在某些情況下有利於能夠同時在節點上執行一項以上的工作。其中一個範例是在應用程式必須等候 I/O 時提高節點使用率；執行多個應用程式將會提高 CPU 使用率。另一個範例是減少集區中的節點數目；這樣可以減少大型參考資料集所需的資料複本數量。如果 A1 不是正確的應用程式大小，則可選擇 A4 且組態會設定為一次執行多達 8 個工作，而每個工作使用一個核心。
	- 「每個節點的工作上限」組態決定可以平行執行的工作數目上限。
	- 還可以指定「填滿原則」，用來決定批次是否先填滿節點，還是將工作分散於所有的節點。
 
- 集區中節點的通訊狀態。
 	- 在大多數的情況下，工作會獨立運作，而且不需要與其他工作進行通訊，但有些應用程式中的工作會進行通訊 (例如使用 MPI 的應用程式)。
	- 有組態可供控制節點是否能夠進行通訊，以便設定基本網路基礎結構並影響節點的放置位置。

- 集區中節點的啟動工作。

當您建立集區時，您可以指定應該與集區相關聯的儲存體帳戶。批次服務會從網路連線和頻寬容量較佳的資料中心，配置節點給指定的儲存體帳戶。這樣可讓工作負載更有效率地存取資料。

### <a name="job"></a>作業

作業是工作的集合。它也會指定在集區中的運算節點上執行運算的方式。

- 作業會指定工作執行所在的集區。此集區可以是由許多作業使用的現有集區，但可針對與作業排程相關聯的每項作業或針對與作業排程相關聯的所有作業另外建立一個集區。
- 您可以指定選擇性優先順序。使用高於其他進行中作業的優先順序提交作業時，較高優先順序的作業工作會插入在佇列中較低優先順序的作業工作之前。已在執行中的較低優先順序工作不會先發制人。
- 條件約束。
	- 可以設定作業的最大時鐘時間。如果作業的執行時間超過指定的最大時鐘時間，則會結束此作業和所有相關聯的工作。
	- Azure 批次可以偵測失敗的工作並重試工作。可以指定預設的工作重試次數上限做為條件約束，包括指定一律重試工作，或決不重試工作。重試工作表示工作已重新排入佇列並且將會再次執行。
- 用戶端可對作業新增要為作業執行的工作，但也可選擇性指定「作業管理員」工作。作業管理員工作會使用批次 API 並含有程式碼，以便使用正在其中一個集區節點上執行的工作建立作業的必要工作。批次會特別處理此作業管理員工作 – 此工作會在作業建立後立即排入佇列，而如果因為任何原因而失敗，則會重新啟動。由作業排程建立的作業需要有作業管理員，因為它是在作業具現化之前唯一可定義工作的方法。


### <a name="task"></a>工作

工作是與作業相關聯的運算單位且在節點上執行。工作會指派給節點以便執行，或排入佇列直到節點變成可用為止。工作會使用下列資源：

- 工作項目中所指定的程式。

- 包含要處理之資料的資源檔。這些檔案會自動從 Blob 儲存體複製到節點。如需詳細資訊，請參閱「檔案和目錄」。

- 程式所需的環境設定。如需詳細資訊，請參閱「工作的環境設定」。

- 執行計算所根據的條件約束。例如，允許執行工作的最長時間、工作無法執行時應該重試的次數上限，以及檔案保留在工作目錄中的最長時間。

除了您可以定義在節點上執行運算的工作以外，您還可以使用批次服務所提供的下列特殊工作：

- [啟動工作](#starttask)

- [作業管理員工作](#jobmanagertask)

#### <a name="starttask"></a>啟動工作

您可以將啟動工作與集區產生關聯，以設定集區中節點的作業系統。安裝軟體和啟動背景處理序都是啟動工作可以執行的動作。啟動工作會在節點每次啟動時執行，且只要留在集區中就會持續執行。

如同任何批次工作，除了批次執行的命令列以外，還可以指定 Azure 儲存體中的檔案清單。Azure 批次會先從 Azure 儲存體複製檔案，然後再執行命令列。對於集區開始工作，檔案清單通常包含應用程式檔案或封裝，但也可以包含在集區節點上執行的所有工作將會使用的參考資料。命令列可執行任何 PowerShell 指令碼或 robocopy，例如，將應用程式檔案複製到 “shared” 資料夾；也可以執行 MSI。

通常批次最好能夠等待啟動工作完成，然後再考慮將工作指派給節點，但這可加以設定。

如果集區節點的啟動工作失敗，則會更新節點的狀態以反映失敗，且指派的工作將無法使用該節點。如果複製針對啟動工作指定的檔案時發生問題，或啟動工作程序傳回非零，則啟動工作可能會失敗。

已宣告設定節點和安裝應用程式所需的全部資訊，表示增加集區中的節點數目，就像指定新的所需數目一樣簡單；批次具有設定節點並讓它們準備好接受工作所需的全部資訊。

啟動工作的定義方式是將 JSON 區段加入至「加入集區」作業的要求內容。下列範例示範啟動工作的基本定義：

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

C# 介面如下所示：

	CloudPool pool = pm.CreatePool(poolId, targetDedicated: 3, virtualMachineSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>作業管理員工作

作業管理員工作會在所有其他工作之前啟動。作業管理員工作提供下列優點：

- 建立作業時由批次服務自動建立。

- 排程在作業中的其他工作之前。

- 縮小集區時，相關聯的節點最後才會從集區移除。

- 需要重新啟動時，它有最高的優先順序。如果找不到閒置的節點，批次服務可能會終止集區中正在執行的其中一個工作，以便挪出空間供它執行。

- 此終止可能完全取決於作業中的所有工作終止。

作業中的作業管理員工作的優先順序不高於其他作業中的工作。不同作業之間，只注重作業層級優先順序。作業管理員工作的定義方式是將 XML 區段加入至「加入工作項目」作業的要求內容。下列範例示範作業管理員工作的基本定義：

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}


### <a name="jobschedule"></a>作業排程

作業排程是使用排程建立多個工作的方式。作業排程建立之後，就會為每個排程建立一個作業。

## <a name="workflow"></a>批次服務的工作流程

您需要批次帳戶才能使用批次服務，您可以使用服務的多個資源來排程計算。當您使用批次服務建立分散式計算案例時，您可以使用下列的基本工作流程：

1\. 將您要在分散式計算案例中使用的檔案，上傳至 Azure 儲存體帳戶。這些檔案必須在儲存體帳戶中，批次服務才能夠存取它們。執行工作時，批次服務會將檔案載入至節點。

2\. 將相依的二進位檔案上傳至儲存體帳戶。二進位檔案包含工作所執行的程式及相依組件。這些檔案也必須從儲存體中存取，並載入節點。

3\. 建立節點集區。建立集區時，您可以指派要使用的工作虛擬機器大小。工作執行時，系統會從這個集區指派節點給它。

4\. 建立工作項目。當您建立工作項目時會自動建立作業。工作項目可讓您管理工作的作業。

5\. 將工作加入至工作項目。每個工作會使用您已上傳的程式，以處理您上傳的檔案中的資訊。

6\. 監視輸出的結果。

## <a name="files"></a>檔案和目錄

每個工作會在其工作目錄下建立零個或多個目錄和檔案，以儲存工作執行的程式、工作處理的資料，以及工作執行之處理的輪出。這些目錄和檔案可供作業執行期間的其他工作使用。節點上的所有工作、檔案和目錄由單一使用者帳戶擁有。

批次服務會在節點上公開檔案系統的一部分作為根目錄。節點的根目錄是透過 AZ\_BATCH\_NODE\_ROOT\_DIR 環境變數提供給工作使用。如需有關如何使用環境變數的詳細資訊，請參閱「工作的環境設定」。

根目錄包含下列子目錄：

- **工作** – 此位置是屬於節點上執行之工作的所有檔案的儲存位置。對於每個工作，批次服務會建立具有唯一路徑的工作目錄，格式為 %AZ\_BATCH\_TASK\_ROOT\_DIR%。這個目錄可供讀取/寫入工作。工作可以建立、讀取、更新和刪除此目錄下的檔案，此目錄會根據工作指定的 RetentionTime 條件約束而保留。

- **共用** – 此位置是帳戶下所有工作的共用目錄。在節點上，共用目錄位於 %AZ\_BATCH\_NODE\_SHARED\_DIR%。這個目錄可供讀取/寫入工作。工作可以建立、讀取、更新和刪除此目錄下的檔案。

- **啟動** – 工作使用這個位置做為它的工作目錄。由批次服務下載來執行啟動工作的所有檔案，也儲存在此目錄下。在節點上，啟動目錄位於 %AZ\_BATCH\_NODE\_START\_DIR%。工作可以建立、讀取、更新和刪除此目錄下的檔案，啟動工作可以使用此目錄來設定作業系統。

當節點從集區移除時，也會移除所有儲存在節點上的檔案。

## <a name="lifetime"></a>集區和節點存留期

基本設計決策就是何時建立集區以及節點保持可用的時間長度。

您可以在提交每項作業後對此作業建立一個集區，而節點會在工作執行完成時移除。這樣只有在絕對必要時才會配置節點，而且節點會在變成閒置時立即關閉，以便充分發揮使用率。這表示工作必須等候節點進行配置，請務必注意，工作將會在節點個別可用、配置且啟動工作完成時立即排程至節點；也就是說，批次不會等到集區中的所有節點都可用，因會這會導致使用率不佳。

如果要優先讓作業立即開始執行，則應建立集區並在提交作業前備妥節點。工作可以立即啟動，但視負載而定，節點可能會閒置以等候作業工作完成。

當進行中的負載數量不定時，常見的作法是讓多項作業提交至一個集區，但是要根據負載相應增加或相應減少節點數目；如果可以預測負載，則可以被動或主動方式處理。

## <a name="scaling"></a>調整應用程式

您的應用程式可以輕易地自動相應放大或縮少，以配合您需要的計算。您可以根據目前的工作負載和資源使用量統計資料，動態調整集區中的節點數目。您也可以將您的應用程式設定成自動調整，以最佳化執行應用程式的整體成本。您可以在建立集區時指定調整設定，也可以隨時更新組態。

如果節點的數目降低，有可能需要考量在節點上執行的工作。指定取消配置原則，用來決定是否停止執行中的工作才能立即移除節點，或者是否允許在移除節點之前先完成工作。將節點的目標數目設定成在作業結束時降為零，但允許執行中的工作完成，將會最大化使用率。

您可以使用一組調整公式來指定自動調整應用程式。這些公式可以用來決定下一個調整間隔在集區中的節點數目。例如，您需要提交大量要在的集區上排定的工作。您可以指派調整公式給集區，以根據目前的暫止工作數目和工作的完成率來指定集區大小。批次服務會定期評估公式，並根據工作負載來調整集區大小。

公式可以根據下列度量資訊：

- **時間度量** – 根據指定的時數內每隔五分鐘收集的統計資料。

- **資源度量** – 根據 CPU 使用量、頻寬使用量、記憶體使用量和節點的數目。

- **工作度量** – 根據狀態的工作，例如使用中、暫止和已完成。

如需自動調整應用程式的詳細資訊，請參閱「設定自動調整工作虛擬機器」。

>刪除節點
>
>通常不需要，但是可以指定從集區中移除個別節點。例如，如果懷疑有節點較不可靠，可予以移除。

## <a name="cert"></a>應用程式的憑證

當您加密機密資訊時，您通常需要使用憑證。憑證可以安裝在節點上。加密機密資料會透過命令列參數或內嵌在其中一個資源中而傳遞至工作，已安裝的憑證可用來解密機密資料。儲存體帳戶的金鑰就是機密資訊。

您可以使用「加入憑證」作業將憑證加入至批次帳戶。然後，您可以將憑證與新的或現有的集區產生關聯。當憑證與集區相關聯時，批次服務會在集區中的每個節點上安裝憑證。當節點啟動時，在啟動任何工作之前，包括啟動工作和作業管理員工作，批次服務會安裝適當的憑證。

## <a name="scheduling"></a>排程優先順序

當您建立工作項目時，您可以指派優先順序給它。工作項目底下的每個工作都以此優先順序建立。批次服務會使用作業的優先順序值，以決定帳戶內的作業排程順序。優先順序值可以介於 -1000 到 1000，-1000 表示最低優先順序，1000 表示最高優先順序。您可以使用 UpdateJob 作業來更新作業的優先順序。

在相同的帳戶內，較高優先順序的作業具有比低優先順序作業更高的排程優先順序。一個帳戶中具有較高優先順序值的作業，其排程優先順序並不高於不同帳戶中較低優先順序值的另一項作業。

不同集區的作業排程各自獨立。在不同的集區之間，即使作業的優先順序較高，如果其相關聯的集區缺少閒置的節點，並不保證此作業會優先排程。在相同的集區上，相同優先順序等級的作業有相同的排程機會。

## <a name="environment"></a>工作的環境設定

您可以指定適用於工作的環境設定。對於啟動工作及作業下執行的工作，環境設定的定義方式是將 XML 區段加入至「加入工作」或「更新工作」作業的要求內文。

下列範例顯示環境設定的定義：

對於作業下排程的每項工作，批次服務會設定一組特定的環境變數。下表列出批次服務為所有工作所設定的環境變數。

| 環境變數名稱 | 說明 |
|------------------------------------|--------------------------------------------------------------------------|
| AZ\_BATCH\_ACCOUNT\_NAME | 工作所屬的帳戶名稱。 |
| AZ\_BATCH\_JOB\_ID | 工作所屬的作業名稱。 |
| AZ\_BATCH\_TASK\_ID | 目前工作的名稱。 |
| AZ\_BATCH\_POOL\_ID | 執行工作的集區名稱。 |
| AZ\_BATCH\_NODE\_ID | 執行工作的節點名稱。 |
| AZ\_BATCH\_NODE\_ROOT\_DIR | 節點上根目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_SHARED\_DIR | 節點上共用目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_STARTUP\_DIR | 節點上集區節點啟動工作目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_TASK\_DIR | 節點上工作目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_TASK\_WORKING\_DIR | 節點上工作工作目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_JOB\_PREP\_DIR | 節點上作業準備工作目錄的完整路徑。 |
| AZ\_BATCH\_NODE\_JOB\_PREP\_WORKING\_DIR | 節點上作業準備工作工作目錄的完整路徑。 |

**注意**

您無法覆寫這些系統定義的變數。

您可以使用「取得工作」作業來擷取環境設定的值。

## <a name="errorhandling"></a>錯誤處理

###工作失敗處理
工作失敗可分成下列幾類：

- 排程失敗：
	- 若已針對工作指定檔案，則一或多個檔案的複本可能會失敗。這可能是因為檔案已經移動、儲存體帳戶已無法使用等等。
	- 在此情況下，對工作設定「排程錯誤」。
- 應用程式失敗：
	- 命令列所指定的工作程序也會失敗。傳回非零的結束碼時，此程序會被視為失敗。
	- 針對應用程式失敗，可以將批次設定成自動重試工作直到指定的次數為止。 
- 條件約束失敗：
	- 可以指定作業或工作可以執行的時間量上限的條件約束。這可用來終止懸置的工作。
	- 超過時間量上限時，則會將工作標示為已完成，但結束代碼將會標示為 `0xC000013A`，而 schedulingError 欄位將會標示為 `{ category:“ServerError”, code=“TaskEnded”}`。

###應用程式失敗偵錯

應用程式可能會產生診斷，以便用來排解疑難問題。通常應用程式會將資訊寫入 stdout 和 stderr 檔案或輸出到自訂檔案。在這些情況下，會指定工作或節點，以便提供 API 來取得檔案。

此外，也可以登入集區節點。API 會傳回節點的 RDP 檔案，以便使用 RDP 檔案來登入節點。

###處理工作失敗和問題

工作可能會因為下列原因而失敗或中斷。工作應用程式本身可能失敗、執行工作的節點重新開機，或由於調整集區大小而移除節點 (其取消配置原則設為不需等待工作完成便立即移除節點)。在所有的情況下，此工作均可由批次自動重新排入佇列，並且在另一個節點上執行。

也可能是間歇性問題導致工作懸置或花太長時間執行。可以設定工作的執行時間上限，而如果超過此限制，批次就會中斷工作應用程式。目前，自動重新排入佇列並不適用此種情況，但是用戶端可以偵測到此種情況並提交新的工作。

###處理「不良」節點

集區中的每個節點都有唯一的名稱，而執行工作的節點會包含在工作中繼資料中。如果節點因為某種原因而導致工作失敗，則用戶端可以判斷這種情況並從集區中刪除可疑的節點。如果在已遭刪除的節點上執行工作，則會自動將此工作重新排入佇列並在另一個節點上執行。


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[Azure 批次概觀]: batch-technical-overview.md

<!---HONumber=July15_HO5-->