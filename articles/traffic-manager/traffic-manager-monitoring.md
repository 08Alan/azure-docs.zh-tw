<properties
   pageTitle="流量管理員端點監視和容錯移轉 | Microsoft Azure"
   description="本文有助於您了解流量管理員如何使用端點監視和自動端點容錯移轉，以協助 Azure 客戶部署高可用性應用程式"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="07/01/2016"
   ms.author="jtuliani" />

# 流量管理員端點監視和容錯移轉

Azure 流量管理員包含內建的端點監視和自動端點容錯移轉。此功能可協助您提供能夠從端點故障中恢復的高可用性應用程 式，包括 Azure 區域失敗。

流量管理員會定期對每個端點提出要求，接著驗證回應。如果端點無法提供有效回應，流量管理員就會將其狀態顯示為「已降級」。不再將端點包含於 DNS 回應中，而是傳回替代的可用端點。如此一來，使用者流量就會避開失敗端點，並導向可用的端點。

針對已降級端點的端點健全狀況檢查將持續進行，因此，它們可在復原且狀況良好之後自動重新加入輪替。

## 設定端點監視

若要設定端點監視，您必須在流量管理員設定檔中指定下列設定︰

- **通訊協定**。選擇 HTTP 或 HTTPS。請務必注意，HTTPS 監視不會驗證您的 SSL 憑證是否有效，它只會檢查該憑證是否存在。
- **連接埠**。選擇要求所使用的連接埠。標準 HTTP 和 HTTPS 連接埠皆可。
- **路徑**。提供監視健全狀況檢查將嘗試存取的網頁或檔案的相對路徑和名稱。請注意，正斜線 (/) 是相對路徑的有效項目，表示檔案位於根目錄 (預設值)。

流量管理員會使用指定的通訊協定、連接埠和相對路徑，對每個端點提出 GET 要求，以檢查端點的健全狀況。

常見的做法是在您的應用程式內實作自訂頁面，例如 /health.aspx。設定此頁面以做為流量管理員端點監視路徑。在該頁面內，您可以執行任何必要的應用程式特定檢查 (例如檢查資料庫的可用性)，然後傳回 HTTP 200 (服務是否狀況良好) 或不同的狀態碼。

端點監視是在流量管理員設定檔層級上設定，而非針對個別端點來設定。因此會使用相同的設定來檢查所有端點的健全狀況。如果您需要對不同的端點使用不同的監視設定，您可以使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md#example-5-per-endpoint-monitoring-settings)來完成。

## 端點和設定檔狀態

您可以啟用和停用流量管理員設定檔和端點。不過，端點狀態中的變更也可能是因為流量管理員自動設定和程序的結果所導致。下列參數說明其運作方式。

### 端點狀態

端點狀態是一個使用者控制的設定，您可以使用此設定輕鬆地啟用或停用特定端點。這不會影響基礎服務 (此服務可能仍在執行) 的狀態。相反地，從流量管理員觀點來看，它能夠控制特定端點的可用性。當端點狀態為「已停用」時，流量管理員不會檢查其健全狀況，而且端點不會包含於 DNS 回應中。

### 設定檔狀態

設定檔狀態是一個使用者控制的設定。您可以使用它輕鬆地啟用或停用設定檔。儘管端點狀態只會影響單一端點，設定檔狀態仍會影響整個設定檔，包括所有端點。系統不會針對設定檔中處於「已停用」狀態的端點檢查健全狀況，而且不會在 DNS 回應中包含任何端點 (會傳回一個 NXDOMAIN 回應)。

### 端點監視狀態

端點監視狀態是流量管理員所產生的設定，會顯示端點目前的狀態。您無法手動變更此設定。端點監視狀態會反映持續進行的端點監視，以及其他資訊，例如端點狀態。下表顯示端點監視狀態的可能值。(如需如何計算巢狀端點的端點監視狀態詳細資訊，請參閱[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md))。

|設定檔狀態|端點狀態|端點監視狀態 (API 和入口網站)|注意事項|
|---|---|---|---|
|已停用|已啟用|非使用中|使用者已停用設定檔。儘管端點狀態仍為「已啟用」，但會優先採用設定檔狀態 (「已停用」)。已停用設定檔中的端點不會受到監視，而且不會在 DNS 回應中包含任何端點 (會傳回一個 NXDOMAIN 回應)。|
|「任何」|已停用|已停用|使用者已停用端點。「已停用」狀態的端點不會受到監視。端點不會包含於 DNS 回應中，因此不會接收流量。|
|已啟用|已啟用|線上|端點受到監視且狀況良好。端點包含於 DNS 回應中，因此可接收流量。|
|已啟用|已啟用|已降級|端點監視健全狀況檢查失敗。端點不會包含於 DNS 回應中，因此不會接收流量。|
|已啟用|已啟用|正在檢查端點|端點受到監視，但尚未收到第一次探查的結果。通常只有當您在設定檔中剛加入新端點，或者剛啟用端點或設定檔時，才會發生此暫時狀態。處於此狀態的端點會包含於 DNS 回應中，因此可接收流量。|
|已啟用|已啟用|已停止|端點指向的雲端服務或 Web 應用程式並未執行。請檢查雲端服務或 Web 應用程式設定。「已停止」狀態的端點不會受到監視。端點不會包含於 DNS 回應中，因此不會接收流量。|

### 設定檔監視狀態

設定檔監視狀態是由設定檔中所有端點的端點監視狀態值，以及您設定的設定檔狀態所形成的組合。下表說明可能的值。

|設定檔狀態 (依設定)|端點監視狀態|設定檔監視狀態 (API 和入口網站)|注意事項|
|---|---|---|---|
|已停用|「任何」或未定義端點的設定檔。|已停用|使用者已停用設定檔。|
|已啟用|至少有一個端點的狀態為「已降級」。|已降級|這是不需要客戶動作的旗標。檢閱個別端點狀態值，以判斷哪些端點需要進一步注意。|
|已啟用|至少有一個端點的狀態為「線上」。沒有狀態為「已降級」的端點。|線上|服務正在接收流量，不需要客戶動作。|
|已啟用|至少有一個端點的狀態為「正在檢查端點」。沒有狀態為「線上」或「已降級」的端點。|正在檢查端點|轉換狀態。這通常發生在剛建立或啟用設定檔，而且第一次檢查端點健全狀況時。|
|已啟用|設定檔中定義的所有端點狀態為「已停用」或「已停止」，或者設定檔並未定義任何端點。|非使用中|沒有作用中的端點，但設定檔仍為「已啟用」。|

## 端點容錯移轉和容錯回復

假設發生先前狀況良好的端點失敗的情況。流量管理員偵測到失敗，而該端點脫離輪替行列。端點在稍後復原。流量管理員偵測到此復原，並將端點帶回輪替中。

>[AZURE.NOTE] 如果傳回的訊息是 200 OK，流量管理員只會將端點視為線上。如果發生下列其中一個狀況，流量管理員就會認為這是一個失敗的端點健全狀況檢查：

>- 收到非 200 回應 (包括不同的 2xx 碼或 301/302 重新導向)
>- 要求用戶端驗證
>- 逾時 (逾時臨界值是 10 秒)
>- 無法連線

>如需疑難排解失敗檢查的詳細資訊，請參閱[疑難排解 Azure 流量管理員上的已降級狀態](traffic-manager-troubleshooting-degraded.md)。

下列時間軸詳細說明了發生的步驟順序。

![流量管理員端點容錯移轉和容錯回復順序](./media/traffic-manager-monitoring/timeline.png)

1. **GET**。流量管理員監視系統會對您在監視設定中指定的路徑和檔案執行 GET 要求。每個端點會如此重複。
2. **200 OK**。監視系統預期在 10 秒鐘內應該傳回 HTTP 200 OK 訊息。收到此回應時，就能確認服務可供使用。
3. **每次檢查之間間隔 30 秒**。每隔 30 秒重複進行端點健全狀況檢查。
4. **服務無法使用**。服務變為無法使用。流量管理員要直到下次健全狀況檢查時才會知道。
5. **嘗試存取監視檔案 (嘗試 4 次)**。監視系統執行 GET 要求，但沒有在 10 秒鐘的逾時期限內收到回應 (反而可能收到非 200 的回應)。接著每隔 30 秒嘗試一次，再嘗試三次。如果其中一次嘗試成功，會重設嘗試次數。
6. **將狀態設為已降級**。在第四次連續失敗之後，監視系統會將無法使用的端點狀態標示為「已降級」。
7. **流量轉向其他端點**。流量管理員 DNS 名稱伺服器已更新，而流量管理員在回應 DNS 查詢時不再傳回端點。新的連接會導向至其他可用的端點。不過，先前包含此端點的 DNS 回應仍可能由遞迴 DNS 伺服器和 DNS 用戶端所快取。這會導致某些用戶端嘗試連接到此端點。當這些快取過期時，用戶端會提出新的 DNS 查詢，並導向至不同的端點。快取持續時間是由流量管理員設定檔中的 TTL 設定所控制，例如 30 秒。
8. **健全狀況檢查繼續**。儘管端點處於「已降級」狀態，流量管理員還是會繼續檢查它的健全狀況。正因如此，它才能偵測端點何時恢復健全狀況。
9. **服務重新上線**。服務變為可供使用。端點會在流量管理員中維持「已降級」狀態，直到監視系統執行下一次健全狀況檢查為止。
10. **服務的流量恢復**。流量管理員傳送 GET 要求，並收到 200 OK 狀態回應。這表示服務已恢復狀況良好的狀態。流量管理員名稱伺服器會更新，並會開始在 DNS 回應中送出服務的 DNS 名稱。當傳回其他端點的快取 DNS 回應過期時，以及當其他端點的現有連接終止時，流量將再次回到端點。

>[AZURE.NOTE] 由於流量管理員是在 DNS 層級運作，所以無法影響任何端點的現有連接。在引導端點之間的流量時 (透過變更設定檔設定，或是在容錯移轉或容錯回復期間)，流量管理員會將新的連接導向至可用的端點。不過，其他端點可透過現有的連接繼續接收流量，直到這些工作階段終止為止。若要將現有連接的流量排出，應用程式應該限制每個端點使用的工作階段持續時間。

## 已降級的端點

當端點處於「已降級」狀態時，DNS 查詢的回應中就不會再傳回此端點 (關於這項規則的例外，請參閱本節結尾的附註)，而是選擇並傳回替代端點。替代端點的選擇取決於已設定的流量路由方法︰

- **優先順序**。端點會形成優先順序清單。永遠傳回清單上第一個可用的端點。如果端點狀態為「已降級」，則會傳回下一個可用的端點。
- **加權**。根據指派的加權和其他可用端點的加權進行隨機選擇，可能會傳回任何可用的端點。如果端點狀態為「已降級」，則會從其餘可用的端點集區中選擇端點。
- **效能**。傳回最靠近使用者的端點 (不包括「已停用」或「已停止」狀態的端點)。如果該端點無法使用，則會從其他所有可用端點中隨機選擇傳回的端點。(這是為了避免下一個最靠近的端點變成超載時可能發生的連鎖失敗。您可以使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region)來設定效能流量路由的替代容錯移轉計劃。)

如需詳細資訊，請參閱[流量管理員流量路由方法](traffic-manager-routing-methods.md)。

>[AZURE.NOTE] 如果所有流量管理員端點 (不包括「已停用」或「已停止」狀態的端點) 都未通過健全狀況檢查，並顯示「已降級」狀態，會發生什麼事？

>這很可能是因為服務的組態發生錯誤 (例如存取控制清單 [ACL] 封鎖了流量管理員健全狀況檢查)，或流量管理員設定檔的組態發生錯誤 (例如監視路徑不正確)。

>在此情況下，流量管理員會「竭盡所能」進行嘗試，且「彷彿所有已降級狀態的端點實際上是處於線上狀態一樣地回應」。這比在 DNS 回應中不傳回任何端點的另一種做法更好。

>此行為的結果是當流量管理員健全狀況檢查未正確設定時，從流量路由傳送看起來，流量管理員似乎運作正常。不過，在此情況下，如果端點失敗，將不會發生端點容錯移轉，而這會影響整體應用程式可用性。為了確保不會發生此情形，請務必檢查設定檔會顯示為「線上」狀態，而不是「已降級」狀態。「線上」狀態表示流量管理員的健全狀況檢查如預期般地運作。

如需健全狀況檢查失敗疑難排解的詳細資訊，請參閱[疑難排解 Azure 流量管理員上的已降級狀態](traffic-manager-troubleshooting-degraded.md)。

## 常見問題集

### 流量管理員本身有能力從 Azure 區域失敗中恢復嗎？

流量管理員是一個重要元件，提供內建的健全狀況檢查和區域之間的自動容錯移轉，能夠在 Azure 中提供高可用性應用程式，包括有能力從區域全面性 Azure 中斷運作中恢復的應用程式。

因此，流量管理員本身必須提供極高的可用性，包括從區域失敗中恢復。

雖然流量管理員的某些部分是在 Azure 中執行，但這些元件都分散於各區域，且已設計成能夠從任何 Azure 區域的全面失敗中恢復。此恢復功能適用於所有流量管理員元件︰DNS 名稱伺服器、API、儲存層及端點監視服務。

因此，即使在整個 Azure 區域完全停機的罕見情況下，也能預期流量管理員會持續正常運作，而在多個 Azure 區域中部署應用程式的客戶可以依賴流量管理員，將流量導向到其應用程式的可用執行個體。

### 資源群組位置的選擇如何影響流量管理員？

流量管理員是單一全域服務。不是區域性。如何選擇資源群組位置，對於部署在該資源群組中的流量管理員設定檔而言，並沒有差別。

Azure Resource Manager 需要所有資源群組指定位置，這會決定部署在該資源群組中資源的預設位置。當您透過 Azure 入口網站建立流量管理員設定檔時，如果您建立新的資源群組，將會要求您提供此位置。

所有流量管理員設定檔都使用**全域**當作位置。因為這是唯一接受的值，此設定無法在 Azure 入口網站、PowerShell 或 Azure CLI 中加以存取。這會覆寫資源群組預設值。

### 如何判斷每個端點目前的健全狀況？

每個端點的目前監視狀態以及整體設定檔都會顯示於 Azure 入口網站中。您也可以透過流量監視 [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx)、[PowerShell Cmdlet](https://msdn.microsoft.com/library/mt125941.aspx) 和[跨平台 Azure CLI](../xplat-cli-install.md) 取得此資訊。

您無法檢視過去端點健全狀況的歷程記錄資訊，也無法針對端點健全狀況的變更來設定警示。

### 我可以監視 HTTPS 端點嗎？

是。流量管理員支援透過 HTTPS 探查。只要在監視組態中將 **HTTPS** 設定為通訊協定即可。請注意：

- 不會驗證伺服器端憑證
- 不支援 SNI 伺服器端憑證
- 不支援用戶端憑證

### 端點健全狀況檢查使用哪一個主機標頭？

HTTP 和 HTTPS 健全狀況檢查中使用的主機標頭是與每個端點相關聯的 DNS 名稱。在 Azure 入口網站、[PowerShell Cmdlet](https://msdn.microsoft.com/library/mt125941.aspx)、[跨平台 Azure CLI](../xplat-cli-install.md) 和 [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) 中，這公開為端點目標。

這個值是端點組態的一部分。主機標頭中使用的值不能與目標屬性分開指定。


## 後續步驟

了解[流量管理員的運作方式](traffic-manager-how-traffic-manager-works.md)

深入了解流量管理員支援的[流量路由方法](traffic-manager-routing-methods.md)

了解如何[建立流量管理員設定檔](traffic-manager-manage-profiles.md)

[疑難排解流量管理員端點上的已降級狀態](traffic-manager-troubleshooting-degraded.md)

<!---HONumber=AcomDC_0706_2016-->