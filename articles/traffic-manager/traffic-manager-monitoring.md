<properties 
   pageTitle="流量管理員端點監視和容錯移轉 | Microsoft Azure"
   description="本文將協助您了解流量管理員如何使用端點監視和自動端點容錯移轉，讓 Azure 客戶部署高可用性應用程式"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="06/04/2016"
   ms.author="jtuliani" />

# 流量管理員端點監視和容錯移轉

Azure 流量管理員包含內建的端點監視和自動端點容錯移轉。這可讓您提供可從端點故障中恢復的高可用性應用程式，包括 Azure 區域失敗。

做法是定期對每個端點提出要求並驗證回應。如果端點無法提供有效的回應，則標示為「已降級」，且不再納入 DNS 回應中，而改為傳回替代的可用端點。因此，使用者流量會避開失敗端點，而導向可用的端點。

對於「已降級」的端點，將會持續健全狀況檢查，以便在恢復健全狀況時可自動重新加入輪替。

## 設定端點監視

若要設定端點監視，您必須在流量管理員設定檔中指定下列設定︰

- **通訊協定** – 選擇 HTTP 或 HTTPS。請務必注意，HTTPS 監視不會驗證您的 SSL 憑證是否有效，它只會檢查該憑證是否存在。
- **連接埠** – 選擇要求所使用的連接埠。標準 HTTP 和 HTTPS 連接埠皆可。
- **路徑** – 提供監視健全狀況檢查將嘗試存取的網頁或檔案的相對路徑和名稱。請注意，正斜線 "/" 可用於相對路徑，表示檔案位於根目錄中 (預設值)。

流量管理員會使用指定的通訊協定、連接埠和相對路徑，對每個端點提出 GET 要求，以檢查端點的健全狀況。

常見的作法是在應用程式內實作自訂頁面，例如 '/health.aspx'，並將此頁面設定為流量管理員端點監視路徑。在該頁面內，您可以執行任何必要的應用程式特定檢查，例如檢查後端資料庫的可用性，然後才傳回 HTTP 200 (服務是否健全) 或不同的狀態碼。

端點監視是在流量管理員設定檔層級上設定，而非針對個別端點來設定。因此會使用相同的設定來檢查所有端點的健全狀況。如果您需要對不同的端點使用不同的監視設定，請使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md#example-5-per-endpoint-monitoring-settings)。

## 端點和設定檔狀態

使用者可以啟用和停用流量管理員設定檔和端點。端點健全狀況檢查也會引起狀態變更。下列參數詳細描述行為。

### 端點狀態

「端點狀態」是由使用者控制的設定，可輕鬆啟用或停用個別端點。這不會影響基礎服務的狀態 (可能仍在執行中)，而是從流量管理員的觀點來控制此端點的可用性。端點停用時，不會檢查其健全狀況，DNS 回應中也不會傳回它。

### 設定檔狀態

「設定檔狀態」是由使用者控制的設定，可輕鬆啟用或停用設定檔。「端點狀態」只影響單一端點，而「設定檔狀態」會影響整個設定檔，包括所有端點。端點停用時，不會檢查其健全狀況，DNS 回應中也不會傳回任何端點 (DNS 查詢改以收到 'NXDOMAIN' 回應)。

### 端點監視狀態

「端點監視狀態」是流量管理員所產生的設定，使用者無法設定。它會顯示端點的目前狀態，反映持續的端點監視及其他資訊，例如「端點狀態」。下表顯示「端點監視狀態」的可能值。(如需如何計算巢狀端點的「端點監視狀態」的詳細資訊，請參閱[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md)。)

|設定檔狀態|端點狀態|端點監視狀態 (API 和入口網站)|注意事項|
|---|---|---|---|
|已停用|已啟用|非使用中|使用者已停用設定檔。儘管「端點狀態」仍然為「已啟用」，但會優先採用「設定檔狀態」。不會監視「已停用」設定檔中的端點。DNS 回應中不會傳回端點 (而是提供 'NXDOMAIN' 回應)。|
|「任何」|已停用|已停用|使用者已停用端點。不會監視「已停用」的端點。它們無法納入 DNS 回應中，因此不會接收流量。|
|已啟用|已啟用|線上|端點受到監視且狀況良好。它可納入 DNS 回應中，因此可接收流量。|
|已啟用|已啟用|已降級|端點監視健全狀況檢查失敗。端點無法納入 DNS 回應中，因此不會接收流量。|
|已啟用|已啟用|正在檢查端點|端點受到監視，但尚未收到第一次探查的結果。當您在設定檔中剛加入新端點，或者剛啟用端點或設定檔時，才會發生此暫時狀態。此狀態的端點可納入 DNS 回應中，因此可接收流量。|
|已啟用|已啟用|已停止|端點指向的雲端服務或 Web 應用程式並未執行。請檢查雲端服務或 Web 應用程式設定。不會監視「已停止」的端點。它們無法納入 DNS 回應中，因此不會接收流量。|

### 設定檔監視狀態

「設定檔監視狀態」是設定檔中所有端點的端點監視狀態與您設定的設定檔狀態所形成的組合。下表說明可能的值︰

|設定檔狀態 (依設定)|端點監視狀態|設定檔監視狀態 (API 和入口網站)|注意事項|
|---|---|---|---|
|已停用|「任何」或未定義端點的設定檔。|已停用|使用者已停用設定檔。|
|已啟用|至少有一個端點的狀態為「已降級」。|已降級|這是不需要客戶動作的旗標。檢閱個別端點狀態值，以判斷哪些端點需要進一步注意。|
|已啟用|至少有一個端點的狀態為「線上」。沒有任何端點為「已降級」。|線上|服務正在接收流量，不需要客戶動作。|
|已啟用|至少有一個端點的狀態為「正在檢查端點」。沒有端點為「線上」或「已降級」。|正在檢查端點|轉換狀態。這通常發生在剛建立或啟用設定檔，而且第一次檢查端點健全狀況時。|
|已啟用|設定檔中定義的所有端點狀態為「已停用」或「已停止」，或者設定檔有未定義的端點。|非使用中|沒有端點作用中，但設定檔仍然啟用中。|

## 端點容錯移轉和容錯回復

假設先前狀況良好的流量管理員端點失敗，流量管理員偵測到此失敗，且端點脫離輪替。後來端點復原，流量管理員也偵測到此情形，端點又重新加入輪替。

>[AZURE.NOTE] 如果傳回的訊息是 200 OK，流量管理員只會將端點視為線上。如果發生下列任何情況，這將視為檢查失敗︰

>- 收到非 200 回應 (包括不同的 2xx 碼或 301/302 重新導向)
>- 要求用戶端驗證
>- 逾時 (逾時臨界值是 10 秒)
>- 無法連線

>如需疑難排解失敗的檢查的詳細資訊，請參閱[疑難排解 Azure 流量管理員上的已降級狀態](traffic-manager-troubleshooting-degraded.md)。

在下列時間軸詳細說明發生的步驟順序。

![流量管理員端點容錯移轉和容錯回復順序](./media/traffic-manager-monitoring/timeline.png)

1. **GET** – 流量管理員監視系統對您在監視設定中指定的路徑和檔案執行 GET。每個端點會如此重複。
2. **200 OK** – 監視系統預期在 10 秒鐘內應該傳回 HTTP 200 OK 訊息。收到此回應時，就知道服務可用。
3. **每次檢查之間間隔 30 秒** – 每隔 30 秒重複端點健全狀況檢查。
4. **服務無法使用** – 服務變為無法使用。流量管理員要直到下次健全狀況檢查時才會知道。
5. **嘗試存取監視檔案 (嘗試 4 次)** – 監視系統執行 GET，但沒有在 10 秒鐘或更短時間之內收到回應 (反而可能收到非 200 的回應)。接著會每隔 30 秒執行一次，再嘗試三次。如果其中一次嘗試成功，會重設嘗試次數。
6. **標示為已降級** – 連續四次失敗之後，監視系統會將無法使用的端點標示為「已降級」。 
7. **流量轉向其他端點** – 流量管理員 DNS 名稱伺服器已更新，流量管理員在回應 DNS 查詢時不再傳回端點。因此，新的連接會導向至其他可用的端點。不過，先前包含此端點的 DNS 回應仍可能由遞迴 DNS 伺服器和 DNS 用戶端所快取，導致某些用戶端會嘗試連線到此端點。當這些快取過期時，用戶端將提出新的 DNS 查詢，並導向至不同的端點。快取持續時間由流量管理員設定檔中的 TTL 設定所控制，例如 30 秒。 
8. **健全狀況檢查繼續** - 儘管端點處於「已降級」狀態，流量管理員會繼續檢查端點的健全狀況。正因如此，它才能偵測端點何時恢復健全狀況。
9. **服務重新上線** – 服務變為可用。端點在流量管理員中會停留在「已降級」狀態，直到監視系統執行下一次健全狀況檢查為止。
10. **服務的流量恢復** - 流量管理員傳送 GET 並收到 200 OK，表示服務已恢復健全狀態。流量管理員名稱伺服器會再一次更新，並開始在 DNS 回應中送出服務的 DNS 名稱。當傳回其他端點的快取 DNS 回應過期時，以及當其他端點的現有連線終止時，流量將會再次回到端點。

>[AZURE.NOTE] 由於流量管理員是在 DNS 層級上運作，所以無法影響任何端點的現有連線。在引導端點之間的流量時 (透過變更設定檔設定，或是在容錯移轉或容錯回復期間)，流量管理員會將新的連接導向至可用的端點。不過，其他端點可透過現有的連接來繼續接收流量，直到這些工作階段終止為止。若要將現有連接的流量排出，應用程式應該限制每個端點使用的工作階段持續時間。

## 已降級的端點

端點降級後，DNS 查詢的回應中就不會再傳回此端點 (關於這項規則的例外，請參閱下列附註)，而是選擇並傳回替代端點。替代端點的選擇取決於已設定的流量路由方法︰

- **優先順序** – 端點形成優先順序清單。永遠傳回清單上第一個可用的端點。如果它變為「已降級」，則傳回下一個可用的端點。
- **加權** – 根據指派的加權和其他可用端點的加權而隨機選擇，可能傳回任何可用的端點。如果端點變為已降級，則會從其餘那些可用的端點中選擇端點。
- **效能** – 傳回「最靠近」使用者的端點 (不包括已停用/已停止的端點)。如果該端點無法使用，則會從其他所有可用端點中隨機選擇傳回的端點。(這是為了避免下一個最靠近的端點變成超載時可能發生的連鎖失敗。您可以使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md#example-4-controlling-performance-traffic-routing-between-multiple-endpoints-in-the-same-region)來設定效能流量路由的替代容錯移轉計劃。)

如需詳細資訊，請參閱[流量管理員流量路由方法](traffic-manager-routing-methods.md)。

>[AZURE.NOTE] 如果所有流量管理員端點 (不包括「已停用」或「已停止」的端點) 未通過健全狀況檢查，而標示為「已降級」，會發生什麼事？

>這很可能是因為服務的組態發生錯誤 (例如 ACL 封鎖流量管理員健全狀況檢查)，或流量管理員設定檔的組態發生錯誤 (例如監視路徑不正確)。

>在此情況下，流量管理員會「竭盡所能」且「彷彿所有已降級的端點實際在「線上」一樣地回應」。這比在 DNS 回應中不傳回任何端點的另一種作法更好。

>此行為的結果是當流量管理員健全狀況檢查未正確設定時，從流量路由傳送看起來，流量管理員似乎運作正常。不過，如果端點失敗，將不會發生端點容錯移轉，因而影響整體應用程式可用性。為了確保不會發生此情形，必須確定設定檔顯示為「線上」，而不是「已降級」狀態。「線上」狀態表示流量管理員的健全狀況檢查如預期般地運作。

如需健全狀況檢查失敗疑難排解的詳細資訊，請參閱[疑難排解 Azure 流量管理員上的已降級狀態](traffic-manager-troubleshooting-degraded.md)。
 
## 常見問題集

### 流量管理員本身有能力從 Azure 區域失敗中恢復嗎？

Azure 流量管理員是一個重要元件，提供內建的健全狀況檢查和區域之間的自動容錯移轉，能夠在 Azure 中提供高可用性應用程式，包括有能力從區域全面性 Azure 中斷運作中恢復的應用程式。

因此，我們認為流量管理員本身必須提供極高的可用性，包括從區域失敗中恢復。

雖然流量管理員的某些部分在 Azure 中執行，但這些都分散於各區域，且已設計成能夠從任何 Azure 區域的全面失敗中恢復。此恢復功能適用於所有流量管理員元件︰DNS 名稱伺服器、API、儲存層及端點監視服務。

因此，即使在整個 Azure 區域完全停機的罕見情況下，流量管理員也會持續正常運作，而在多個 Azure 區域中部署應用程式的客戶可以依賴流量管理員，將流量導向到其應用程式的可用執行個體。

### 資源群組位置的選擇如何影響流量管理員？

流量管理員是單一全球服務。不是區域性。如何選擇資源群組位置，對於部署在該資源群組中的流量管理員設定檔而言，並沒有差別。

Azure Resource Manager 需要所有資源群組指定「位置」，這會決定部署在該資源群組中的資源的預設位置。當您透過 Azure 入口網站建立流量管理員設定檔時，如果您建立新的資源群組，將會要求您提供此位置。

所有流量管理員設定檔都使用「全球」當作位置。因為這是唯一接受的值，並不會出現在 Azure 入口網站、PowerShell 或 CLI 體驗中。這會覆寫資源群組預設值。

### 如何判斷每個端點目前的健全狀況？

每個端點的目前監視狀態及整體設定檔會顯示在 Azure 管理入口網站中。您也可以透過流量管理員 [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx)、[PowerShell Cmdlet](https://msdn.microsoft.com/library/mt125941.aspx) 和[跨平台 Azure CLI](../xplat-cli-install.md) 取得此資訊。

目前，無法檢視過去端點健全狀況的歷程記錄資訊，也無法針對端點健全狀況的變更來設定警示。

### 我可以監視 HTTPS 端點嗎？

是。流量管理員支援透過 HTTPS 探查。只要在監視設定中將 'HTTPS' 設定為通訊協定即可。請注意：

- 不會驗證伺服器端憑證
- 不支援 SNI 伺服器端憑證
- 不支援用戶端憑證

### 端點健全狀況檢查使用什麼 ‘Host’ 標頭？

HTTP/S 健全狀況檢查中使用的 ‘host’ 標頭是每個端點相關聯的 DNS 名稱。在 Azure 入口網站、[PowerShell Cmdlet](https://msdn.microsoft.com/library/mt125941.aspx)、[跨平台 Azure CLI](../xplat-cli-install.md) 和 [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) 中，這公開為端點 ‘target’。

這個值是端點組態的一部分。Host 標頭中使用的值不能與 'target' 屬性分開指定。


## 後續步驟

了解[流量管理員的運作方式](traffic-manager-how-traffic-manager-works.md)。

深入了解流量管理員支援的[流量路由方法](traffic-manager-routing-methods.md)。

了解如何[建立流量管理員設定檔](traffic-manager-manage-profiles.md)。

[疑難排解 Azure 流量管理員端點上的「已降級」狀態](traffic-manager-troubleshooting-degraded.md)
 

<!---HONumber=AcomDC_0608_2016-->