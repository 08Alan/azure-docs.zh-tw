<properties
   pageTitle="升級 Service Fabric 叢集 |Microsoft Azure"
   description="升級執行 Service Fabric 叢集的 Fabric 程式碼和/或組態時，包括憑證升級、新增應用程式連接埠、OS 修補程式等。執行升級時，您可以期待些什麼？"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/23/2015"
   ms.author="chackdan"/>

# 升級 Service Fabric 叢集

Service Fabric 叢集是您所擁有的資源，但部分由 Microsoft 管理。本文說明自動管理的部分以及您可以自行設定的部分。

## 自動管理的叢集組態

Microsoft 會維護在叢集中執行的 Fabric 程式碼和組態，而我們會視需要執行軟體的自動監視升級。這些升級可能是程式碼、組態或兩者。為了確保您的應用程式不受這些升級影響或將影響降到最低，我們會分三個階段執行升級。

### 階段 1：使用所有叢集健康狀態原則執行升級

在這個階段，升級會一次進行一個升級網域，而已在叢集中執行的應用程式會繼續執行，而不會產生任何停機時間。在升級期間，會遵守叢集健康狀態原則 (它是節點健康狀態和所有在叢集中執行之應用程式的健康狀態的組合)。

如果不符合叢集健康狀態原則，則會復原升級、傳送電子郵件給訂用帳戶的擁有者，表示我們必須復原叢集升級並採取任何補救動作，而且我們將在另一個 n 天 (n 是一個變數) 內執行階段 2。我們會試著執行相同的升級數次，以排除因為以下原因而失敗的升級，而在電子郵件寄送日期的 n 天之後，我們會繼續執行階段 2。

如果符合叢集健康狀態原則，則升級會被視為成功並標示為完成。這種情形可能會發生此階段中的初次升級或任何重新執行升級期間。執行成功不會有任何電子郵件確認。(這是為了避免傳送給您太多電子郵件，接收電子郵件應該視為例外狀況。我們希望大部分的叢集升級不會影響您的應用程式可用性)。

如需有關如何為您的叢集設定自訂健康狀態原則的詳細資訊，請參閱[叢集升級和健康狀態參數](service-fabric-cluster-health-parameters.md)。

### 階段 2：僅使用預設健康狀態原則執行升級

健康狀態原則的設定方式為升級開始時健康良好的應用程式數目在升級程序期間會維持不變。如同階段 1，在這個階段，升級會一次進行一個升級網域，而已在叢集中執行的應用程式會繼續執行，而不會產生任何停機時間。在升級期間，會遵守叢集健康狀態原則 (它是節點健康狀態和所有在叢集中執行之應用程式的健康狀態的組合)。

如果不符合生效的叢集健康狀態原則，則會復原升級、傳送電子郵件給訂用帳戶的擁有者，表示我們必須復原叢集升級並採取任何補救動作，而且我們將在另一個 n 天 (n 是一個變數) 內執行階段 3。

我們試著執行相同的升級數次，以排除因為以下原因而失敗的升級。在 n 天到達的前幾天會傳送提醒電子郵件。在電子郵件寄送日期的 n 天之後，我們會繼續進行階段 3。您必須認真看待我們在階段 2 寄送的電子郵件並採取補救動作。

如果符合叢集健康狀態原則，則升級會被視為成功並標示為完成。這種情形可能會發生此階段中的初次升級或任何重新執行升級期間。執行成功不會有任何電子郵件確認。

### 階段 3：使用積極的叢集健康狀態原則執行升級

這些健康狀態原則的目的是升級完成，而不是應用程式的健康狀態。很少叢集升級會在這個階段結束。如果您的叢集在這個階段結束，您的應用程式有可能會狀況不良或失去可用性。

類似其他兩個階段，階段 3 升級會一次進行一個升級網域。

如果不符合生效的健康狀態原則，則會復原升級。我們會試著執行相同的升級數次，以排除因為以下原因而失敗的升級，而後叢集便已固定，將不再接受支援和 (或) 升級。

系統會傳送具有此資訊的電子郵件 (包含補救動作) 給訂用帳戶擁有者。我們不希望任何叢集會進入階段 3 失敗的狀態。

如果符合叢集健康狀態原則，則升級會被視為成功並標示為完成。這種情形可能會發生此階段中的初次升級或任何重新執行升級期間。執行成功不會有任何電子郵件確認。

## 您控制的叢集組態

以下是您可以在即時叢集上變更的組態。

### 憑證

您可以從入口網站或經由在 servicefabric.cluster 資源上發出 PUT 命令，輕鬆更新主要或次要憑證。

![CertificateUpgrade][CertificateUpgrade]

**注意**：識別您想要用於叢集資源的憑證之前，需要完成下列步驟，否則不會使用新的憑證。1) 上傳新的憑證到金鑰保存庫 - 如需指示請參閱 [Service Fabric 安全性](service-fabric-cluster-security.md) - 從該文件中的步驟 2 開始。2) 更新所有組成叢集的「虛擬機器」，使憑證部署至其上。做法請參閱[這篇部落格文章](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx)。

### 應用程式連接埠

您可以變更與節點類型相關聯的負載平衡器資源屬性來達成目的。您可以直接使用入口網站或 ARM PowerShell。

若要在一個節點類型中的所有 VM 上開啟新的連接埠，您必須執行下列作業。

1. **將新的探查新增至適當的負載平衡器**

    如果您已使用入口網站部署您的叢集，則負載平衡器將命名為 "loadBalancer-0"、"loadBalancer-1" 等 (每個節點類型有一個負載平衡器)。因為負載平衡器名稱只有在資源群組 (RG) 中是唯一的，所以最好在指定的 RG 下搜尋名稱。

    ![AddingProbes][AddingProbes]


2. **將新規則加入至負載平衡器**

    使用您在上一個步驟中建立的探查，對相同的負載平衡器加入新的規則。

    ![AddingLBRules][AddingLBRules]


### 放置屬性

  對於每個節點類型，您可以加入您要在應用程式中使用的自訂放置屬性。NodeType 是您可使用而不需明確新增的預設屬性。

  >[AZURE.NOTE]如需放置屬性用法的詳細資訊，請參閱[放置條件約束文件](service-fabric-placement-constraint.md)。

### 容量計量

對於每個節點類型，您可以加入您要在應用程式中用來報告負載的自訂容量計量。如需使用容量計量來報告負載的詳細資訊，請參閱[動態負載報告概觀](service-fabric-resource-balancer-dynamic-load-reporting.md)。

### 將 OS 修補程式套用至構成叢集的虛擬機器
這是即將推出的功能。您目前需負責修補您的 VM。您必須一次修補一部 VM，如此才不會一次關閉一部以上的 VM。

### 將 OS 升級為構成叢集的虛擬機器上的新 OS
如果您必須升級您所使用的 OS 映像，則必須一次升級一部 VM，而且您需負責這項升級。目前沒有自動化作業。


## 後續步驟

- 了解如何[相應增加和相應減少您的叢集](service-fabric-cluster-scale-up-down.md)
- 了解[應用程式升級](service-fabric-application-upgrade.md)

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

<!-------HONumber=AcomDC_1210_2015--->