---
title: 管理 Azure Stack 的儲存體基礎結構 | Microsoft Docs
description: 管理 Azure Stack 的儲存體基礎結構。
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: ''
ms.topic: ''
ms.date: 03/11/2019
ms.author: mabrigg
ms.lastreviewed: 03/11/2019
ms.reviewer: jiahan
ms.openlocfilehash: 4a8287d7ca4da380ad7c2b1e039ab3058ca07a96
ms.sourcegitcommit: 5fbca3354f47d936e46582e76ff49b77a989f299
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/12/2019
ms.locfileid: "57760268"
---
# <a name="manage-storage-infrastructure-for-azure-stack"></a>管理 Azure Stack 的儲存體基礎結構

*適用於：Azure Stack 整合式系統和 Azure Stack 開發套件*

本文說明 Azure Stack 儲存體基礎結構資源的健全狀態和操作狀態。 這些資源包括儲存體磁碟機和磁碟區。 在嘗試對各種問題 (例如磁碟機無法新增至集區) 進行疑難排解時，本主題中的資訊將有很大的幫助。

## <a name="understand-drives-and-volumes"></a>了解磁碟機和磁碟區

### <a name="drives"></a>磁碟機

Azure Stack 採用 Windows Server 軟體定義儲存體功能，並結合了儲存空間直接存取 (S2D) 和 Windows Server 容錯移轉叢集，可提供高效能、可調整且具彈性的儲存體服務。

Azure Stack 整合系統合作夥伴提供多種不同的解決方案，包括各種層面的儲存體彈性。 目前有三種磁碟機類型的組合可供選取：NVMe (非揮發性記憶體儲存裝置)、SATA/SAS SSD (固態硬碟)、HDD (硬碟)。

儲存空間直接存取具有快取，可讓儲存體發揮最大效能。 在採用單一或多種磁碟機的 Azure Stack 設備中，儲存空間直接存取會自動使用所有「速度最快」的磁碟機類型 (NVMe &gt; SSD &gt; HDD) 進行快取。 其餘磁碟機則作為容量磁碟機。 磁碟機可歸類為「全快閃」或「混合」部署：

![Azure Stack 儲存體基礎結構](media/azure-stack-storage-infrastructure-overview/image1.png)

全快閃部署以盡可能發揮儲存體效能為目標，不包含轉動式硬碟 (HDD)。

![Azure Stack 儲存體基礎結構](media/azure-stack-storage-infrastructure-overview/image2.png)

混合部署的目標則是要平衡效能與容量或將容量最大化，部署中包含轉動式硬碟 (HDD)。

快取的行為會自動取決於所快取的磁碟機類型。 進行固態硬碟的快取時 (例如 NVMe 對 SSD 的快取)，將只會快取寫入。 這可降低容量磁碟機的耗損，進而減少對容量磁碟機的累計流量，並延長其使用壽命。 同時，由於讀取對於快閃記憶體的使用壽命並無太大影響，且固態磁碟機通常可提供低讀取延遲性，因此並不會快取讀取。 進行硬碟的快取時 (例如 SSD 對 HDD 的快取)，讀取和寫入都會快取，使這兩種作業都能有近似於快閃記憶體的延遲性 (通常約快上 10 倍)。

![Azure Stack 儲存體基礎結構](media/azure-stack-storage-infrastructure-overview/image3.png)

若想了解可用的儲存體設定，您可以向 Azure Stack OEM 合作夥伴 (https://azure.microsoft.com/overview/azure-stack/partners/) 洽詢詳細規格。

> [!Note]  
> Azure Stack 設備可設置在同時使用 HDD 和 SSD (或 NVMe) 磁碟機的混合部署中。 但速度較快的磁碟機類型會作為快取磁碟機，其餘磁碟機則全都以集區的形式作為容量磁碟機。 租用戶資料 (Blob、資料表、佇列和磁碟) 會放在容量磁碟機上。 因此，佈建進階磁碟或選取進階儲存體帳戶類型並不保證這些物件會配置在 SSD 或 NVMe 磁碟機上，而獲得更好的效能。

### <a name="volumes"></a>磁碟區

*儲存體服務*會將可用的儲存體分割成個別的磁碟區，繼而經由配置用來保存系統和租用戶資料。 磁碟區會結合存放集區中的磁碟機，而導入儲存空間直接存取的容錯、延展性和效能等效益。

![Azure Stack 儲存體基礎結構](media/azure-stack-storage-infrastructure-overview/image4.png)

在 Azure Stack 儲存體集區上可建立三種類型的磁碟區：

-   基礎結構：裝載 Azure Stack 基礎結構 VM 和核心服務所使用的檔案。

-   VM 暫存：裝載連結至租用戶 VM 的暫存磁碟，而資料會儲存在這些磁碟中。

-   物件存放區：裝載提供給 Blob、資料表、佇列和 VM 磁碟的租用戶資料。

在多節點部署中，您會看到三個基礎結構磁碟區，而 VM 暫存磁碟區和物件存放區磁碟區的數目則會等於 Azure Stack 部署中的節點數目：

-   在四節點的部署中，有四個等同的 VM 暫存磁碟區，和四個等同的物件存放區磁碟區。

-   如果您將新節點新增至叢集，這兩種類型都將有新建立的磁碟區。

-   即使節點發生故障或遭到移除，磁碟區數目仍會保持不變。

-   如果您使用 Azure Stack 開發人員套件，則會有具備多個共用的單一磁碟區。

儲存空間直接存取中的磁碟區可提供復原能力來防範硬體問題 (例如磁碟機或伺服器故障)，以及在整個伺服器維護期間 (例如軟體更新) 支援持續可用性。 Azure Stack 部署會使用三向鏡像來確保資料的復原能力。 租用戶資料會有三個複本寫入至不同的伺服器，繼而進入快取中：

![Azure Stack 儲存體基礎結構](media/azure-stack-storage-infrastructure-overview/image5.png)

鏡像可為所有資料保存多個複本，以提供容錯能力。 這類資料的等量化和放置方式並非一般人所能了解 (若要深入了解請參閱此部落格)，但可確定的是，任何使用鏡像進行儲存的資料，都會以整體的方式寫入多次。 每個複本會寫入至不同的硬體 (不同伺服器中的不同磁碟機)，而理論上其故障只會單獨發生。 三向鏡像在同一時間可容許至少兩個硬體問題 (磁碟機或伺服器)，而安全無虞。 例如，如果您在一個磁碟機或伺服器突然故障時重新啟動另一部伺服器，所有資料都將保有安全性，且持續可供存取。

## <a name="volume-states"></a>磁碟區狀態

若要了解磁碟區所處的狀態，請使用下列 PowerShell 命令：

\$scaleunit\_name = (Get-AzsScaleUnit)\[0\].name

\$subsystem\_name = (Get-AzsStorageSubSystem -ScaleUnit \$scaleunit\_name)\[0\].name

Get-AzsVolume -ScaleUnit \$scaleunit\_name -StorageSubSystem \$subsystem\_name | Select-Object VolumeLabel, HealthStatus, OperationalStatus, RepairStatus, Description, Action, TotalCapacityGB, RemainingCapacityGB

下列輸出範例顯示已中斷連結的磁碟區和已降級/不完整的磁碟區：

| VolumeLabel | HealthStatus | OperationalStatus |
|-------------|--------------|------------------------|
| ObjStore_1 | 不明 | 已中斷連結 |
| ObjStore_2 | 警告 | {已降級、不完整} |

以下各節列出健全狀態和操作狀態。

### <a name="volume-health-state-healthy"></a>磁碟區健全狀態：Healthy

| 操作狀態 | 說明 |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| OK | 磁碟區狀況良好。 |
| 次佳 | 資料未平均寫入各個磁碟機。<br> <br>**動作：** 請連絡支援人員，以最佳化存放集區中的磁碟機使用情形。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 在還原失敗的連線之後，您可能必須從備份還原。 |


### <a name="volume-health-state-warning"></a>磁碟區健全狀態：警告

磁碟區的健全狀態為「警告」時，表示您的資料有一或多個複本無法使用，但 Azure Stack 仍可讀取至少一個資料複本。

| 操作狀態 | 說明 |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 運作中 | Azure Stack 正在修復磁碟區，例如，新增或移除磁碟機之後的修復。 修復完成後，磁碟區應該就會恢復為「正常」健全狀態。<br> <br>**動作：** 等到 Azure Stack 完成磁碟區修復後，再查看其後的狀態。 |
| 不完整 | 磁碟區的復原能力因一或多個磁碟機故障或遺失而下降。 不過，遺失的磁碟機包含您的資料最新的複本。<br> <br>**動作：** 重新連接任何遺失的磁碟機，並更換任何故障的磁碟機，然後使任何離線的伺服器重新上線。 |
| 已降級 | 磁碟區的復原能力因一或多個磁碟機故障或遺失而下降，且這些磁碟機上有已過期的資料複本。<br> <br>**動作：** 重新連接任何遺失的磁碟機，並更換任何故障的磁碟機，然後使任何離線的伺服器重新上線。 |

 

### <a name="volume-health-state-unhealthy"></a>磁碟區健全狀態：狀況不良

磁碟區處於「狀況不良」的健全狀態時，當下將無法存取磁碟區上的部分或所有資料。

| 操作狀態 | 說明 |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 無備援 | 有太多磁碟機故障，因此磁碟區已遺失資料。<br> <br>**動作：** 請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 |


### <a name="volume-health-state-unknown"></a>磁碟區健全狀態：不明

如果虛擬磁碟已中斷連結，磁碟區也可能處於「不明」健全狀態。

| 操作狀態 | 說明 |
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 已中斷連結 | 儲存裝置發生可能導致磁碟區無法存取的故障。 部分資料可能會遺失。<br> <br>**動作：** <br>1.檢查所有儲存裝置的實體和網路連線。<br>2.如果所有裝置皆正確連線，請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 在還原失敗的連線之後，您可能必須從備份還原。 |

## <a name="drive-states"></a>磁碟機狀態

請使用下列 PowerShell 命令監視磁碟機的狀態：

 

\$scaleunit\_name = (Get-AzsScaleUnit)\[0\].name

\$subsystem\_name = (Get-AzsStorageSubSystem -ScaleUnit \$scaleunit\_name)\[0\].name

, SerialNumber

 

Get-AzsDrive -ScaleUnit \$scaleunit\_name -StorageSubSystem \$subsystem\_name | Select-Object StorageNode, PhysicalLocation, HealthStatus, OperationalStatus, Description, Action, Usage, CanPool, CannotPoolReason, SerialNumber, Model, MediaType, CapacityGB

以下各節說明磁碟機可能的健全狀態。

### <a name="drive-health-state-healthy"></a>磁碟機健全狀態：Healthy

| 操作狀態 | 說明 |
|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| OK | 磁碟區狀況良好。 |
| 運作中 | 磁碟機正在執行某些內部內務處理作業。 此動作完成後，磁碟機應該就會恢復為「正常」健全狀態。 |

### <a name="drive-health-state-healthy"></a>磁碟機健全狀態：Healthy

處於「警告」狀態的磁碟機可成功讀取和寫入資料，但會發生問題。

| 操作狀態 | 說明 |
|---------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 中斷通訊 | 磁碟機的連線已中斷。<br> <br>**動作：** 將所有伺服器恢復上線。 若仍無法解決問題，請重新連接磁碟機。 若此問題持續發生，請更換磁碟機以確保完整的復原能力。 |
| 預期性故障 | 預期磁碟機即將發生故障。<br> <br>**動作：** 盡快更換磁碟機以確保完整的復原能力。 |
| IO 錯誤 | 存取磁碟機時會發生暫時性錯誤。<br> <br>**動作：** 若此問題持續發生，請更換磁碟機以確保完整的復原能力。 |
| 暫時性錯誤 | 磁碟機發生暫時性錯誤。 這通常表示磁碟機沒有回應，但也可能表示儲存空間直接存取的保護分割區已從磁碟機中不當移除。 <br> <br>**動作：** 若此問題持續發生，請更換磁碟機以確保完整的復原能力。 |
| 異常延遲 | 磁碟機有時沒有回應，並出現故障的跡象。<br> <br>**動作：** 若此問題持續發生，請更換磁碟機以確保完整的復原能力。 |
| 正在從集區移除 | Azure Stack 正在從存放集區移除磁碟機。<br> <br>**動作：** 等到 Azure Stack 完成磁碟機移除後，再查看其後的狀態。<br>若狀態不變，請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 |
|  |  |
| 正在進入維護模式 | Azure Stack 正在使磁碟機進入維護模式。 這是暫時性的狀態 - 磁碟機應該很快就會處於維護模式狀態。<br> <br>**動作：** 等到 Azure Stack 完成此程序後，再查看其後的狀態。 |
| 處於維護模式 | 磁碟機處於維護模式，暫停磁碟機的讀取和寫入作業。 這通常表示 Azure Stack 正在對磁碟機執行系統管理工作，例如 PNU 或 FRU。 但是，系統管理員也可能將磁碟機置於維護模式。<br> <br>**動作：** 等到 Azure Stack 完成系統管理工作後，再查看其後的狀態。<br>若狀態不變，請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 |
|  |  |
| 正在停止維護模式 | Azure Stack 正在將磁碟機恢復上線。 這是暫時性的狀態 - 磁碟機應該很快就會處於另一個狀態 - 符合預期的「良好」。<br> <br>**動作：** 等到 Azure Stack 完成此程序後，再查看其後的狀態。 |

 

### <a name="drive-health-state-unhealthy"></a>磁碟機健全狀態：狀況不良

處於「狀況不良」狀態的磁碟機目前無法進行寫入或存取。

| 操作狀態 | 說明 |
|-------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Split | 磁碟機已與集區分離。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 如果您必須使用此磁碟，請從系統中移除磁碟，並確定磁碟上沒有任何有用的資料，再清除磁碟，然後重新安裝磁碟。 |
| 無法使用 | 實體磁碟已遭隔離，因為您的解決方案廠商並不支援。 只有通過解決方案核准、且具有正確磁碟韌體的磁碟，才受到支援。<br> <br>**動作：** 更換磁碟機，且其磁碟的製造商和型號必須已通過解決方案核准。 |
| 過時的中繼資料 | 替換磁碟先前已使用過，且可能包含來自不明儲存體系統的資料。 此磁碟已遭隔離。        <br> <br>**動作：** 更換具有新磁碟的磁碟機。 如果您必須使用此磁碟，請從系統中移除磁碟，並確定磁碟上沒有任何有用的資料，再清除磁碟，然後重新安裝磁碟。 |
| 無法辨識的中繼資料 | 若在磁碟機上發現無法辨識的中繼資料，通常表示該磁碟機上有來自不同集區的中繼資料。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 如果您必須使用此磁碟，請從系統中移除磁碟，並確定磁碟上沒有任何有用的資料，再清除磁碟，然後重新安裝磁碟。 |
| 故障的媒體 | 磁碟機故障，且儲存空間不會再加以使用。<br> <br>**動作：** 盡快更換磁碟機以確保完整的復原能力。 |
| 裝置硬體故障 | 此磁碟機發生硬體故障。 <br> <br>**動作：** 盡快更換磁碟機以確保完整的復原能力。 |
| 正在更新韌體 | Azure Stack 正在更新磁碟機上的韌體。 這是暫時性的狀態，持續時間通常少於一分鐘，且在此期間，集區中的其他磁碟機將會處理所有的讀取和寫入。<br> <br>**動作：** 等到 Azure Stack 完成更新後，再查看其後的狀態。 |
| 啟動中 | 磁碟機正在進行作業準備。 這應該是暫時性的狀態 - 完成後，磁碟機應該就會轉換成不同的操作狀態。<br> <br>**動作：** 等到 Azure Stack 完成此作業後，再查看其後的狀態。 |
 

## <a name="reasons-a-drive-cant-be-pooled"></a>磁碟機無法進入集區的原因

有些磁碟機純粹就是因為尚未就緒，而無法放入 Azure Stack 存放集區中。 您可以查看磁碟機的 CannotPoolReason 屬性，以了解磁碟機無法放入集區中的原因。 下表將對各種原因的說明稍作補充。

| 原因 | 說明 |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 硬體不符合規範 | 磁碟機未列於使用健康情況服務指定的合格儲存體模型清單中。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 |
| 韌體不符合規範 | 實體磁碟機上的韌體未列於使用健康情況服務指定的合格韌體修訂版本清單中。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 |
| 由叢集使用中 | 磁碟機目前由容錯移轉叢集使用中。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 |
| 卸除式媒體 | 磁碟機歸類為卸除式磁碟機。 <br> <br>**動作：** 更換具有新磁碟的磁碟機。 |
| 狀況不良 | 磁碟機未處於良好狀態，可能需要更換。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 |
| 容量不足 | 有分割區佔用磁碟機上的可用空間。<br> <br>**動作：** 更換具有新磁碟的磁碟機。 如果您必須使用此磁碟，請從系統中移除磁碟，並確定磁碟上沒有任何有用的資料，再清除磁碟，然後重新安裝磁碟。 |
| 驗證進行中 | 健康情況服務正在檢查磁碟機或磁碟機上的韌體，確認是否已通過使用核准。<br> <br>**動作：** 等到 Azure Stack 完成此程序後，再查看其後的狀態。 |
| 驗證失敗 | 健康情況服務無法檢查磁碟機或磁碟機上的韌體以確認是否已通過使用核准。<br> <br>**動作：** 請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 |
| 離線 | 磁碟機已離線。 <br> <br>**動作：** 請連絡支援人員。 在此之前，請先參考 https://aka.ms/azurestacklogfiles 的指引開始進行記錄檔收集程序。 |

## <a name="next-step"></a>後續步驟

[管理儲存體容量](https://docs.microsoft.com/azure/azure-stack/azure-stack-manage-storage-shares) 