<properties title="Integrate your Azure Website with an Azure Virtual Network" pageTitle="整合 Azure 網站與 Azure VNet" description="Shows you how to connect an Azure Website to a new or existing Azure virtual network" metaKeywords="" services="web-sites,virtual-network" solutions="web,integration,infrastructure" documentationCenter="" authors="cephalin" videoId="" scriptId="" manager="wpickett" />

<tags ms.service="web-sites" ms.workload="web" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="09/24/2014" ms.author="cephalin" />

# 整合 Azure 網站與 Azure 虛擬網路 #
本文件說明虛擬網路整合預覽功能，以及示範如何以 Azure 網站加以設定。如果您不熟悉 Azure 虛擬網路，這是讓您利用 Azure 和內部部署資源建置混合式解決方案的功能。  

這項整合能讓網站存取虛擬網路中的資源，但不授與從虛擬網路到網站的存取權限。一些標準案例包括當網站需要存取在 VNET 中虛擬機器 (或甚至您擁有之資料中心) 內運作的資料庫或 Web 服務時。它不允許您掛接磁碟機。目前也不支援與 VNET 中的驗證系統整合。這項功能目前僅供預覽，不過在 GA 之前，我們仍會持續改良。

如需 Azure 虛擬網路的詳細資料，請參閱「虛擬網路概觀」以取得 Azure 虛擬網路的使用案例和優點。

## 開始使用 ##
在連接網站和虛擬網路之前，請留意以下事項。

1.	唯有以「標準」價格層之 Web 主控方案為基礎運作的網站才能連線到虛擬網路。免費、共用和基本網站無法連線到虛擬網路。
2.	如果目標虛擬網路已存在，您必須先以動態路由閘道啟用其點對站台連線，才能使該虛擬網路與網站連線。如果您以靜態路由設定閘道，便無法啟用點對站台 VPN。
3.	Web 主控方案最多僅供您設定 5 個網路。一個網站一次只能連接一個網路。這 5 個網路可供同一個 Web 主控方案中任意數量的網站使用。  

您可以選擇連線到新的或現有的虛擬網路。如果您建立新網路，系統會為您預先設定閘道。請注意，新虛擬網路的建立和設定需要幾分鐘的時間才能完成。  

如果您的網站不在「標準」層，按一下 UI 後，系統將引導您了解及存取價格層。

![](./media/web-sites-integrate-with-vnet/upgrade-to-standard.png) 

## 系統的運作方式 ##
此功能實際上使用點對站台 VPN 技術來將 Azure 網站和 VNET 連線。Azure 網站系統架構的本質是多租用戶，它無法像虛擬機器一樣在 VNET 中直接佈建網站。藉由以點對站台技術為基礎，我們得以將網路存取限制為僅限主控網站的虛擬機器。在網站主機上，我們更進一步限制網路的存取權限，因此網站只能存取設定為供其存取的網路。  

為了保護網路，只將存取權限授與需要存取網路的網站，我們施行的必要措施將會禁止建立 SMB 連線的能力。雖然您仍然可以存取遠端資源，不過掛接遠端磁碟機並不包括在內。

![](./media/web-sites-integrate-with-vnet/how-it-works.png)
 
如果您尚未設定虛擬網路的 DNS 伺服器，便需要使用 IP 位址。請務必透過防火牆向需要的端點公開連接埠。至於連線測試，目前唯一可行的方法是使用能呼叫所需端點的網站或 WebJob。諸如 ping 或 nslookup 等工具目前無法經由 Kudu 主控台發揮作用。這方面是我們即將要改善的要點。  

## 連線到既存的網路 ##
若要將網站連接到虛擬網路，請前往網站的分頁、在 [網路] 區段中按一下虛擬網路磚，然後選取任一個既存的網路。

![](./media/web-sites-integrate-with-vnet/connect-to-existing-vnet.png)
 
接著，系統會建立憑證以向您的 VNET 驗證，確認該網站是不是訂用帳戶中第一個與該網路建立連線的網站。若要查看憑證，請前往目前的入口網站、瀏覽至 [虛擬網路]、選取網路，然後再選取 [憑證] 索引標籤。  

在上圖中，您可以看見名為 cantConnectVnet 的網路呈現灰色且無法選取。發生這種情況的原因只有兩個。這表示您並未在網路中啟用點對站台 VPN，抑或是尚未在 VNET 中佈建動態路由閘道。一旦滿足以上兩個項目後，您便可以選取用來與網站整合的 VNET。

## 建立及連線到新的 VNET ##
除了連線到既存的 VNET 之外，您還可以從網站 UI 建立新的 VNET，然後再自動與其連線。若要這樣做，請遵循到達虛擬網路 UI 的路徑，然後選取 [建立新的虛擬網路]。開啟的 UI 可讓您為網路命名、指定位址空間，以及設定虛擬網路所用之 DNS 伺服器的位址。

![](./media/web-sites-integrate-with-vnet/create-new-vnet.png)
 
利用已設定之閘道建立新虛擬網路可能需要花費 30 分鐘的時間才能完成。在這段時間內，UI 會告知您系統仍在運作中，並且會顯示以下訊息。

![](./media/web-sites-integrate-with-vnet/new-vnet-progress.png)

一旦連接網路和網站後，網站將能透過 TCP 或 UDP 存取該 VNET 中的資源。對於透過站台對站台 VPN 提供給 VNET 使用的內部部署系統，如果您想要存取該系統內的資源，便需要在自己的企業網路中新增路由，以允許流量從網路流向在 VNET 中設定的點對站台位址。

成功完成整合後，入口網站會顯示有關連線的基本資訊、提供中斷網站和網路連線的方法，以及提供用來驗證連線之憑證的同步處理方法。當憑證到期或遭到撤銷時，您將需要進行同步處理。  

![](./media/web-sites-integrate-with-vnet/vnet-status-portal.png)

管理虛擬網路連線
您可以造訪 Web 主控方案的分頁，查看目前與 Web 主控方案內之站台相關聯的所有虛擬網路清單。您最多可以擁有 5 個與標準 Web 主控方案相關聯的網路。

如果您將 Web 主控方案調整為免費、共用或基本等較低的方案，該方案中網站所用的虛擬網路連線將遭到停用。如果您將方案調整回標準方案，系統將會重新建立先前的網路連線。

此時，您無法在 Azure 中將現有的虛擬機器移動到虛擬網路中。您需要在虛擬機器建立期間將其佈建到該虛擬網路中。  

## 存取內部部署資源 ##
在操作已設定站台對站台 VPN 的 VNET 時，若要提供從 Azure 網站到內部部署資源的存取權限，您需要採取額外步驟。您需要將路由新增至內部部署網路，使流量得以從網路流向在 VNET 中設定的點對站台位址。若要查看點對站台連線的 IP 範圍，請前往目前入口網站的 [網路] 區域，如下圖所示。

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise.png)

## 憑證 ##
為了要與 VNET 建立安全連線，我們需要實施憑證交換。在目前的網路入口網站中，您可以查看 Azure 網站產生的公開憑證指紋，如下圖所示。  

![](./media/web-sites-integrate-with-vnet/vpn-to-onpremise-certificate.png)

如果憑證因任何原因而失去同步 (例如，從網路入口網站意外刪除)，連線將會中斷。若要修正問題，網站虛擬網路 UI 中的 [同步連線] 動作可供您重新建立連線。

當您將 DNS 新增至虛擬網路，抑或是將站台對站台 VPN 新增至網路時，也必須使用此動作。  

![](./media/web-sites-integrate-with-vnet/vnet-sync-connection.png)

## 與混合式連線的比較 ##
Azure 網站另外提供一項稱為「混合式連線」的功能。這項功能在某些方面與虛擬網路整合非常類似。儘管這兩項功能的使用案例有重複之處，但它們無法取代彼此。透過混合式連線，您可以與混合網路中的多個應用程式端點建立連線。虛擬網路功能可讓您的網站與連接內部部署網路的 VNET 連線。如果您將所有資源放置在該網路的範圍內，這項功能將能發揮良好的效果。  

另一個差異在於，您需要安裝轉接代理程式，混合式連線才能正常運作。此代理程式需要在 Windows Server 執行個體上執行。在虛擬網路功能的協助下，您不需要安裝任何項目，且該功能可讓您忽略主控作業系統的限制存取遠端資源。  

現階段，這兩項功能的價格層也不盡相同。就價格最低廉的階層來看，這是因為混合式連線功能格外適合用於開發/測試案例，並且只提供存取權限給少量的端點。虛擬網路功能則可讓您存取 VNET 中的所有項目，或與 VNET 連接的所有項目。  
