---
title: 如何在 Azure IoT 中樞裝置佈建服務中重新佈建裝置 | Microsoft Docs
description: 如何使用裝置佈建服務執行個體重新佈建裝置
author: wesmc7777
ms.author: wesmc
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.openlocfilehash: 92680a453d93c8dc0189c6ae376449a8e7a22076
ms.sourcegitcommit: c174d408a5522b58160e17a87d2b6ef4482a6694
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/18/2019
ms.locfileid: "59799128"
---
# <a name="how-to-reprovision-devices"></a>如何重新佈建裝置

在 IoT 解決方案的生命週期中，在 IoT 中樞之間移動裝置是很常見的。 移動原因可能包括下列案例：

* **地理位置**：当设备在两个位置之间移动时，通过将设备迁移到离每个位置更近的 IoT 中心来改善网络延迟。

* **多租用戶**：可在同一 IoT 解决方案中使用设备，但将其重新分配或租赁给新的客户或客户站点。 系統可能會使用不同的 IoT 中樞為這個新客戶提供服務。

* **解决方案更改**：可将设备移到新版或更新后的 IoT 解决方案中。 此重新指派可能需要裝置與連線至其他後端元件的新 IoT 中樞通訊。 

* **隔离**：类似于解决方案更改。 故障、遭入侵或已過期的裝置可能會重新指派給只能將裝置更新，讓裝置再次符合合規性要求的 IoT 中樞。 在裝置正常運作之後，就會移轉回其主要中樞。

更詳細的概觀重新佈建，請參閱 < [IoT 中樞裝置重新佈建概念](concepts-device-reprovision.md)。


## <a name="configure-the-enrollment-allocation-policy"></a>設定註冊配置原則

配置原則會決定如何在重新佈建裝置之後，將與註冊關聯的裝置配置或指派給 IoT 中樞。

下列步驟會設定裝置註冊的配置原則：

1. 登入 [Azure 入口網站](https://portal.azure.com)，並瀏覽至您的裝置佈建服務執行個體。

2. 按一下 [管理註冊]，然後按一下想要針對重新佈建設定的註冊群組或個別註冊。 

3. 在 [選取要如何將裝置指派到中樞] 下，選取下列其中一個配置原則：

    * **最低延迟**：此策略将设备分配到所链接的 IoT 中心，这可使设备与 IoT 中心之间的通信延迟降至最低。 此選項可讓裝置與位置最接近的 IoT 中樞通訊。 
    
    * **均匀加权分发**：此策略根据分配到所链接的每个 IoT 中心的分配加权跨链接的 IoT 中心分发设备。 此原則可根據在一群連結的中樞中設定的配置權重，跨該連結的中樞群組進行裝置負載平衡。 如果您只要將裝置重新佈建到一個 IoT 中樞，建議使用此設定。 這項設定是預設值。 
    
    * **静态配置**：此策略规定对于要预配的设备，必须在注册项中列出所需的 IoT 中心。 此原則可讓您指定要指派裝置的單一特定 IoT 中樞。

4. 在 [選取可指派此群組的 IoT 中樞] 下，選取要在配置原則中包含之連結的 IoT 中樞。 (選擇性) 使用 [連結新的 IoT 中樞] 按鈕新增新的連結的 IoT 中樞。

    您可以使用 [最低延遲] 配置原則，將選取的中樞包含在延遲評估中，判斷最接近的中樞以指派裝置。

    您可以使用 [權重相等的分佈] 配置原則，根據中樞中設定的配置權重和其目前的裝置負載，跨所有選取的中樞進行裝置負載平衡。

    您可以使用 [靜態設定] 配置原則，選取要指派裝置到其中的 IoT 中樞。

4. 按一下 [儲存]，或繼續下一節以設定重新佈建原則。

    ![選取註冊配置原則](./media/how-to-reprovision/enrollment-allocation-policy.png)



## <a name="set-the-reprovisioning-policy"></a>設定重新佈建原則

1. 登入 [Azure 入口網站](https://portal.azure.com)，並瀏覽至您的裝置佈建服務執行個體。

2. 按一下 [管理註冊]，然後按一下想要針對重新佈建設定的註冊群組或個別註冊。

3. 在 [選取在重新佈建至其他 IoT 中樞時如何處理裝置資料] 下，選擇下列其中一個重新佈建原則：

    * **重新预配并迁移数据**：当与注册项关联的设备提交新的预配请求时，此策略将执行操作。 視註冊項目設定而定，裝置可能會重新指派給其他 IoT 中樞。 如果裝置所屬的 IoT 中樞有所變更，將會移除初始 IoT 中樞中的裝置註冊。 該初始 IoT 中的所有裝置狀態資訊將會移轉到新的 IoT 中樞。 移轉期間，裝置的狀態將回報為**指派中**

    * **重新预配并重置为初始配置**：当与注册项关联的设备提交新的预配请求时，此策略将执行操作。 視註冊項目設定而定，裝置可能會重新指派給其他 IoT 中樞。 如果裝置所屬的 IoT 中樞有所變更，將會移除初始 IoT 中樞中的裝置註冊。 系統會將佈建服務執行個體在佈建裝置時收到的初始設定資料提供給新的 IoT 中樞。 移轉期間，裝置的狀態將回報為**指派中**。

4. 按一下 [儲存] 以根據您所做的變更重新部署裝置。

    ![選取註冊配置原則](./media/how-to-reprovision/reprovisioning-policy.png)



## <a name="send-a-provisioning-request-from-the-device"></a>從裝置傳送佈建要求

若要根據前面幾節中所做的設定變更重新部署裝置，這些裝置必須要求重新部署。 

裝置提交佈建要求的頻率需視情況而定。 但是，建議將裝置設定為在重新開機時傳送佈建要求至佈建服務執行個體，並支援一種視需要手動觸發佈建的[方法](../iot-hub/iot-hub-devguide-direct-methods.md)。 也可以設定[所需屬性](../iot-hub/iot-hub-devguide-device-twins.md#desired-property-example)來觸發佈建。 

註冊項目上的重新佈建原則會決定裝置佈建服務執行個體如何處理這些佈建要求，以及是否應該在重新佈建期間移轉裝置狀態資料。 相同原則可供個別註冊與註冊群組使用：

如需在開機序列期間從裝置傳送佈建要求的範例程式碼，請參閱[自動佈建模擬裝置](quick-create-simulated-device.md)。


## <a name="next-steps"></a>後續步驟

- 若要深入了解更多的 Reprovisioning，請參閱[IoT 中樞裝置重新佈建概念](concepts-device-reprovision.md) 
- 若要了解有关取消设置的详细信息，请参阅[如何取消设置以前自动预配的设备](how-to-unprovision-devices.md) 











