<properties
   pageTitle="Azure 應用程式的高可用性 | Microsoft Azure"
   description="在 Microsoft Azure 上針對高可用性設計和建置應用程式的技術概觀和深度資訊。"
   services=""
   documentationCenter="na"
   authors="adamglick"
   manager="saladki"
   editor=""/>

<tags
   ms.service="resiliency"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="08/18/2016"
   ms.author="aglick"/>

#建置在 Microsoft Azure 上之應用程式的高可用性

具有高可用性的應用程式可以化解相依服務和硬體中，可用性、負載和暫時失敗方面的變動。應用程式會持續以商務需求或應用程式服務等級協定 (SLA) 所定義的可接受使用者和系統回應等級來運作。

##Azure 的高可用性功能

Azure 有許多支援高可用性應用程式的內建平台功能。本節說明其中的一些主要功能。如需更完整的平台分析，請參閱 [Azure 復原技術指導](./resiliency-technical-guidance.md)。

###網狀架構控制器

Azure 網狀架構控制器會佈建和監視 Azure 計算執行個體的狀況。網狀架構控制器會檢查主機和來賓機器執行個體的硬體和軟體狀態。當它偵測到失敗時，就會自動重新放置 VM 執行個體來強制執行 SLA。容錯和升級網域的概念可進一步支援計算 SLA。

在部署多個雲端服務角色執行個體時，Azure 會將這些執行個體部署到不同的容錯網域。容錯網域界限基本上是相同區域中的不同硬體機架。容錯網域會減少局部硬體失敗中斷應用程式服務的機率。您無法管理配置給背景工作角色或 Web 角色的容錯網域數目。網狀架構控制器會使用與 Azure 託管應用程式分開的專用資源。它會做為 Azure 系統的核心，因此具有 100% 的運作時間。它會跨容錯網域監視和管理角色執行個體。

下圖顯示網狀架構控制器跨不同容錯網域所部署和管理的 Azure 共用資源。

![容錯網域隔離的簡化檢視](./media/resiliency-high-availability-azure-applications/fault-domain-isolation.png)

升級網域在功能方面與容錯網域類似，但是它們支援升級而非失敗。升級網域是決定特定服務中的哪些執行個體會在某個時間點升級的執行個體區隔邏輯單位。根據預設，託管服務部署會定義五個升級網域。不過，您可以在服務定義檔中變更該值。例如，假設您有八個 Web 角色執行個體。三個升級網域中會有兩個執行個體，一個升級網域中會有兩個執行個體。Azure 會定義更新序列，但序列是以升級網域數目為基礎。如需升級網域的詳細資訊，請參閱[更新雲端服務](../cloud-services/cloud-services-update-azure-service.md)。

###其他服務中的功能

除了支援高計算可用性的平台功能，Azure 還會在它的其他服務中嵌入高可用性功能。例如，Azure 儲存體會維護所有 Blob、資料表和佇列資料的三個複本。它也允許可在次要地區儲存 Blob 和資料表備份的異地複寫選項。Azure 內容傳遞網路可在全球快取 Blob 以實現備援性和延展性。Azure SQL Database 也會維護多個複本。

除了[復原技術指導](https://aka.ms/bctechguide)系列文章，也請參閱 [Azure 雲端服務上大規模服務設計的最佳做法](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)文件。這些文件會更加深入地探討 Azure 平台的可用性功能。

雖然 Azure 提供多個支援高可用性的功能，但請務必了解其限制：

- 針對計算，Azure 保證角色可供使用且會執行，但它不會知道應用程式是正在執行還是多載。
- 針對 Azure SQL Database，資料會在區域內同步複寫。您可以選擇主動式異地複寫，其最多可在相同區域 (或不同區域) 中允許四個額外的資料庫複本。這些資料庫複本不是時間點備份。SQL Database 會提供時間點備份功能。若要深入了解 SQL Database 時間點功能，請閱讀 [Azure SQL Database 還原時間點](https://azure.microsoft.com/blog/azure-sql-database-point-in-time-restore/)。
- 針對 Azure 儲存體，資料表和 Blob 資料預設會複寫到替代區域。不過，在 Microsoft 選擇容錯移轉至替代網站之前，您無法存取這些複本。區域容錯移轉只會在遇到長時間的全區域服務中斷時發生，而且異地容錯移轉時間沒有 SLA。也請務必注意，任何資料損毀都會快速擴散到複本。

基於這些理由，您必須為平台可用性功能補充應用程式特定的可用性功能。應用程式特有的可用性功能包括用來建立 Blob 資料之時間點備份的 Blob 快照集功能。

###Azure 虛擬機器的可用性設定組

本文的重點大多放在使用平台即服務 (PaaS) 模型的雲端服務。不過，Azure 虛擬機器還有特有的可用性功能，其使用基礎結構即服務 (IaaS) 模型。為了讓虛擬機器達到高可用性，您必須使用可用性設定組。可用性設定組可對容錯和升級網域提供類似的功能。在可用性設定組內，Azure 會以防止局部硬體故障和維護活動關閉該群組中所有電腦的方式，來放置虛擬機器。必須有可用性設定組才能實現 Azure 的虛擬機器可用性 SLA。

下圖呈現兩個分別會群組 Web 和 SQL Server 虛擬機器的可用性設定組。

![Azure 虛擬機器的可用性設定組](./media/resiliency-high-availability-azure-applications/availability-set-for-azure-virtual-machines.png)

>[AZURE.NOTE] 在上圖中，SQL Server 是在虛擬機器上安裝並執行。這點不同於前面討論的 Azure SQL Database，其會提供資料庫來做為受管理的服務。

##應用程式的高可用性策略

大部分應用程式的高可用性策略包括備援或移除應用程式元件之間的硬式相依性。應用程式的設計應該支援在 Azure 或協力廠商服務偶爾停機時執行容錯。下列幾節會說明可增加雲端服務可用性的應用程式模式。

###非同步通訊和耐久性佇列

請考慮在鬆散結合的服務之間進行非同步通訊，以提高 Azure 應用程式中的可用性。在此模式中，需將訊息寫入儲存體佇列或 Azure 服務匯流排佇列以供稍後處理。當您將訊息撰寫至佇列時，控制權會立即回到訊息傳送者手上。應用程式的另一層會處理訊息處理，通常是實作為背景工作角色。如果背景工作角色停止運作，訊息會累積在佇列中，直到處理服務恢復為止。只要佇列可供使用，前端傳送者與訊息處理器之間便沒有直接相依性。這樣就不需要可能會形成分散式應用程式輸送量瓶頸的同步服務呼叫。

這種方式的變化會使用 Azure 儲存體 (Blob、資料表、佇列) 或服務匯流排佇列來做為失敗資料庫呼叫的容錯移轉位置。例如，某個應用程式內對另一個服務 (例如 Azure SQL Database) 的同步呼叫會重複失敗。您或許可以將該資料序列化到耐久性儲存體。稍後當服務或資料庫重新上線時，應用程式就可以從儲存體重新提交要求。此模型的差異在於，中繼位置不是應用程式工作流程的固定部分。它只用於失敗案例。

在這兩種案例中，非同步通訊和中繼儲存體可避免停機的後端服務關閉整個應用程式。佇列會做為邏輯媒介。如需有關選擇正確佇列服務的詳細指引，請參閱 [Azure 佇列和 Azure 服務匯流排佇列--異同比較](../service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)。

###錯誤偵測和重試邏輯

高可用性應用程式的設計重點是，使用程式碼內的重試邏輯來適當地處理暫時關閉的服務。Microsoft Patterns and Practices 小組所開發的[暫時性錯誤處理應用程式區塊](https://msdn.microsoft.com/library/hh680934.aspx)可協助應用程式開發人員建立此程序。「暫時性」一詞是指只持續相當短的時間的暫時狀況。在本文的內容中，處理暫時性失敗是高可用性應用程式開發作業的一部分。暫時性狀況的範例包括間歇性網路錯誤和資料庫連線中斷。

暫時性錯誤處理應用程式區塊可讓您以簡化的方式，適當地處理程式碼內的失敗。您可以使用它，藉由加入健全的暫時性錯誤處理邏輯，提高應用程式的可用性。大部分情況下，重試邏輯會處理短暫中斷，並在一或多次失敗的嘗試之後重新連接傳送者和接收者。重試成功的嘗試通常不會被應用程式使用者注意到。

開發人員有三個重試邏輯管理選項︰累加、固定間隔和指數。累加會以線性增加的方式 (例如 1、2、3 和 4 秒) 在每次重試之前等候更久的時間。固定間隔會在每次重試之間等候相同的時間量 (例如，2 秒)。如需較隨機的選項，指數退避法會在重試之間等候更久的時間。不過，它會使用指數行為 (例如 2、4、8 和 16 秒)。

程式碼內的高階策略是︰

1. 定義重試策略和原則。
1. 嘗試可能會造成暫時性錯誤的作業。
1. 如果發生暫時性錯誤，則叫用重試原則。
1. 如果所有重試都失敗，攔截最後一個例外狀況。

請在模擬的失敗中測試重試邏輯，以確保重試連續作業不會造成意外的冗長延遲。在決定將整體工作判定為失敗之前，請先執行這項操作。

###高可用性的參考資料模式

參考資料是應用程式的唯讀資料。此資料會提供商務內容，應用程式會在商務作業進行期間於其中產生交易資料。交易資料是參考資料的時間點函式。因此，其完整性取決於參考資料在交易時的快照集。這個定義不是很精確，但對我們在這邊的目的而言已經足夠。

必須要有應用程式內容中的參考資料，應用程式才能正常運作。各自的應用程式會建立和維護參考資料；主要資料管理 (MDM) 系統通常會執行此函式。這些系統會負責參考資料的生命週期。參考資料的範例包括產品目錄、員工主檔、組件主檔和設備主檔。參考資料也可以來自組織外部，例如郵遞區號或稅率。用來增加參考資料可用性的策略，通常不會比交易資料的策略困難。參考資料的優點在於它多半不可變。

您可以透過與應用程式一起部署參考資料，讓使用參考資料的 Azure Web 角色和背景工作角色在執行階段變成自發性。如果本機儲存體的大小允許這類部署，這將會是理想的狀態。部署到本機檔案系統的內嵌資料庫 (SQL、NoSQL) 或 XML 檔案，有助於 Azure 計算調整單位的自發性。不過，您應該具有不需重新部署就能更新每個角色中的資料的機制。若要這樣做，請在雲端儲存體端點 (例如，Azure Blob 儲存體或 SQL Database) 放置參考資料的任何更新。在每個會在角色啟動時將資料更新下載到計算節點的角色中新增程式碼。或者，新增可讓系統管理員執行強制下載到角色執行個體的程式碼。

若要增加可用性，角色也應該包含一組參考資料，以免儲存體關閉。這可讓角色使用一組基本的參考資料來啟動，直到儲存體資源可供更新使用為止。

![透過自發性計算節點的應用程式高可用性](./media/resiliency-high-availability-azure-applications/application-high-availability-through-autonomous-compute-nodes.png)

這種模式有一個考量，那就是角色的部署和啟動速度。如果您要在啟動時部署或下載大量參考資料，這種模式會增加啟動新部署或角色執行個體所需花費的時間量。這是可接受的取捨結果，因為此模式會自發性地讓每個角色立即可以取得參考資料，而不是需取決於外部儲存體服務。

###高可用性的交易資料模式

交易資料是應用程式在商務內容中產生的資料。交易資料是應用程式所實作的一組商務程序以及支援這些程序的參考資料的組合。交易資料範例可包括訂單、預先出貨通知、發票和客戶關係管理 (CRM) 商機。因此所產生的交易資料會送到外部系統，以做記錄或進行進一步的處理。

請記住，在負責處理這項資料的系統內，參考資料可能會變更。基於這個原因，交易資料必須儲存時間點參考資料內容，使其具有最少的外部相依性，以達到其語意一致性。例如，請設想在訂單完成幾個月之後，從目錄中移除產品的情形。最佳作法是盡可能在交易中嵌入最多的參考資料內容。這會保留與交易相關聯的語意，即使在擷取交易之後參考資料就會變更也是一樣。

如先前所述，使用鬆散結合和非同步之通訊的架構會擁有更高層級的可用性。交易資料也是如此，但其實作更加複雜。傳統的交易概念通常依賴資料庫來保證交易。當您引入中繼層時，應用程式的程式碼必須正確處理各層的資料，以確保有足夠的一致性和耐久性。

下列順序說明將交易資料的擷取和處理分開進行的工作流程︰

1. Web 計算節點︰目前的參考資料。
1. 外部儲存體︰儲存中繼交易資料。
1. Web 計算節點︰完成使用者交易。
1. Web 計算節點︰將完成的交易資料及參考資料內容傳送到保證提供可預測回應的暫時耐久性儲存體。
1. Web 計算節點︰向使用者發出交易完成的訊號。
1. 背景計算節點︰擷取交易資料、對資料進行後期處理 (如有必要)，並將資料傳送至其在目前系統中的最終儲存體位置。

下圖說明這種設計在 Azure 託管雲端服務中的一個可能的實作。

![透過鬆散結合的高可用性](./media/resiliency-disaster-recovery-high-availability-azure-applications/application-high-availability-through-loose-coupling.png)

上圖中的虛線箭頭表示非同步處理。前端 Web 角色並不知道這個非同步處理。這會造成交易儲存在有關目前系統的最終目的地。由於這種非同步模型會帶來延遲，交易資料無法立即可供查詢。因此，每個交易資料單位都必須儲存在快取或使用者工作階段中，才能滿足立即 UI 的需要。

Web 角色會不同於基礎結構的其餘部分而變成是自發性的。其可用性設定檔是 Web 角色和 Azure 佇列的組合，而不是整個基礎結構。除了高可用性，這種方法還可讓 Web 角色水平調整，不受後端儲存體所控制。這個高可用性模型會影響作業的經濟效益。Azure 佇列和背景工作角色等其他元件會影響每月使用量成本。

請注意，上圖說明的只是交易資料的這種分離方法的其中一個實作。還有其他許多可能的實作。下列清單會提供一些替代實作：

 * 背景工作角色或許可以放在 Web 角色和儲存體佇列之間。
 * 可以使用服務匯流排佇列，而不使用 Azure 儲存體佇列。
 * 最終目的地可以是 Azure 儲存體或不同的資料庫提供者。
 * 可在 Web 層使用 Azure 快取，以在交易後提供立即的快取需求。

###延展性模式

請務必注意，雲端服務的延展性會直接影響可用性。如果負載增加會造成服務沒有回應，使用者的印象會是應用程式已停止運作。請根據您預期的應用程式負載和未來的預期，來遵循延展性的最佳作法。最大的規模涉及許多考量，例如使用單一或多個儲存體帳戶、跨多個資料庫共用，以及快取策略。如需深入了解這些模式，請參閱 [Azure 雲端服務上大規模服務設計的最佳做法](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)。

##後續步驟

本文屬於著重[在 Microsoft Azure 上建置的應用程式的災害復原和高可用性](./resiliency-disaster-recovery-high-availability-azure-applications.md)的系列文章。這一系列中的下一篇文章是[在 Microsoft Azure 上建置的應用程式的災害復原](./resiliency-disaster-recovery-azure-applications.md)。

<!---HONumber=AcomDC_0928_2016-->