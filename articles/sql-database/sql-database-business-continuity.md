<properties
   pageTitle="雲端商務持續性 - 資料庫復原 - SQL Database | Microsoft Azure"
   description="了解 Azure SQL Database 如何支援雲端商務持續性和資料庫復原，以及如何協助維持任務關鍵性雲端應用程式持續執行。"
   keywords="business continuity,cloud business continuity,database disaster recovery,database recovery,商務持續性,雲端商務持續性,資料庫災害復原,資料庫復原"
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="07/20/2016"
   ms.author="carlrab"/>

# 使用 Azure SQL Database 的商務持續性概觀

本概觀說明 Azure SQL Database 針對商務持續性和災害復原所提供的功能。它提供從可能導致資料遺失或造成資料庫和應用程式無法使用的干擾性事件復原的選項、建議和教學課程。討論包含當使用者或應用程式錯誤影響資料完整性、Azure 區域中斷，或您的應用程式需要維護時該如何處理。

## 您可用來提供商務持續性的 SQL Database 功能

SQL Database 提供幾種商務持續性功能，包括自動備份和選用的資料庫複寫。每個功能對於預估的復原時間 (ERT) 都有不同的特性，最近的交易都有可能遺失資料。一旦您了解這些選項，就可以在其中選擇，而在大部分情況下，可以針對不同情況一起搭配使用。當您開發商務持續性方案時，您必須了解應用程式在干擾性事件之後完全復原的最大可接受時間 - 這是您的復原時間目標 (RTO)。您也必須了解在干擾性事件之後復原時，應用程式可忍受遺失的最近資料更新 (時間間隔) 最大數量 - 復原點目標 (RPO)。

### 使用資料庫備份來復原資料庫

SQL Database 每週自動執行完整資料庫備份，每小時自動執行差異資料庫備份，以及每 5 分鐘自動執行交易記錄備份，以保護您的企業不會遺失資料。這些備份會儲存在本地備援儲存體 35 天 (標準和進階服務層的資料庫) 或 7 天 (基本服務層的資料庫) - 請參閱[服務層](sql-database-service-tiers.md)深入了解服務層的詳細資料。如果服務層的保留期限不符合您的企業需求，可以[變更服務層](sql-database-scale-up.md)增加保留期限。完整和差異資料庫備份也會複寫到[配對的資料中心](../best-practices-availability-paired-regions.md)以防止資料中心中斷情況 - 請參閱[自動資料庫備份](sql-database-automated-backups.md)深入了解詳細資訊。

您可以使用這些自動資料庫備份，將資料庫從各式各樣的干擾性事件復原到您的資料中心內，並且/或者復原到另一個資料中心。使用自動資料庫備份，復原的預估時間將取決於許多因素，包括相同區域中同時進行復原的資料庫總數、資料庫大小、交易記錄大小，以及網路頻寬。大部分情況下，復原時間會小於 12 小時。復原到另一個資料區域時，每小時差異資料庫備份的異地備援儲存體就限制為可能遺失 1 小時的資料。

> [AZURE.IMPORTANT] 若要使用自動備份復原，您必須是 SQL Server 參與者角色的成員或訂用帳戶擁有者 - 請參閱 [RBAC︰內建角色](../active-directory/role-based-access-built-in-roles.md)。您可以使用 Azure 入口網站、PowerShell 或 REST API 復原。您無法使用 Transact-SQL。

如果您的應用程式有下列狀況，可以使用自動備份做為您的商務持續性和復原機制︰

- 非關鍵性應用程式。
- 沒有繫結 SLA，因此停機 24 小時或更長的時間不會衍生財務責任。
- 具有較低的資料變更率 (亦即每小時的交易數)，可接受遺失多達一小時的資料變更。
- 成本有限。

如果您需要更快速的復原，請使用[主動式異地複寫](sql-database-geo-replication-overview.md) (討論如下)。如果您需要能夠復原超過 35 天的資料，請考慮將您的資料庫定期封存成 BACPAC 檔案 (包含您資料庫結構描述和相關資料的壓縮檔案)，儲存在 Azure Blob 儲存體或在您選擇的另一個位置。如需有關如何建立交易一致資料庫封存的詳細資訊，請參閱[建立資料庫複本](sql-database-copy.md)和[匯出資料庫複本](sql-database-export.md)。

### 使用主動式異地複寫減少復原時間，並限制與復原相關聯的資料遺失

除了在發生業務中斷時使用資料庫備份進行資料庫復原之外，您還可以使用[主動式異地複寫](sql-database-geo-replication-overview.md)設定資料庫，在您選擇的區域中最多可擁有 4 個可讀取的次要資料庫。這些次要資料庫會使用非同步複寫機制與主要資料庫保持同步。此功能可用來防範資料中心中斷或應用程式升級期間的業務中斷。主動式異地複寫也可用來對地理位置分散的使用者，對唯讀查詢提供更佳的查詢效能。

如果主要資料庫意外離線，或者您需要離線進行維護活動，可以快速將次要升級成主要 (也稱為容錯移轉)，並且設定應用程式連線到新升級的主要資料庫。有計劃的容錯移轉，就不會遺失資料。非計劃的容錯移轉，最近的交易就會因為非同步複寫的性質而有一些少量的資料遺失。容錯移轉之後，無論是根據計畫或當資料中心再次上線時，就可以容錯回復。在所有情況下，使用者將會經歷少量的停機時間，而且必須重新連線。

> [AZURE.IMPORTANT] 若要使用主動式異地複寫，您必須是訂用帳戶擁有者，或是在 SQL Server 中擁有系統管理權限。您可以使用 Azure 入口網站、PowerShell 或 REST API，透過訂用帳戶的權限，或使用 Transact-SQL 透過 SQL Server 中的權限，來設定和容錯移轉。

如果您的應用程式符合下列任何準則，就使用主動式異地複寫：

- 是關鍵性應用程式。
- 具有服務等級協定 (SLA)，不允許 24 小時以上的停機時間。
- 停機時間會衍生財務責任。
- 具有很高的資料變更率，而且不接受遺失一個小時的資料。
- 與潛在的財務責任和相關企業損失相較下，使用主動式異地複寫的額外成本較低。

## 在使用者或應用程式錯誤之後復原資料庫

* 沒有人是完美的！ 使用者可能會不小心刪除某些資料、不小心卸除重要的資料表，或甚至是卸除整個資料庫。或者，應用程式可能會因為應用程式缺陷而不小心以不正確的資料覆寫正確的資料。

在此案例中，以下是您的復原選項。

### 執行還原時間點

您可以使用自動備份，將資料庫的複本復原到已知是在資料庫保留期限內的時間點。資料庫還原之後，您可以將原始資料庫取代為還原的資料庫，或從還原的資料將所需的資料複製到原始資料庫。如果資料庫使用主動式異地複寫，我們建議從還原的複本將所需的資料複製到原始資料庫。如果您將原始資料庫取代為還原的資料庫，則必須重新設定並重新同步處理主動式異地複寫 (大型資料庫可能要花費很久的時間)。

如需詳細資訊以及使用 Azure 入口網站或 PowerShell 將資料庫還原至某個時間點的詳細步驟，請參閱[還原時間點](sql-database-recovery-using-backups.md#point-in-time-restore)。您無法使用 Transact-SQL 進行復原。

### 還原已刪除的資料庫

如果資料庫已刪除，但邏輯伺服器尚未刪除，您可以將已刪除的資料庫還原到它被刪除時的時間點。這會將資料庫備份還原到資料庫被刪除的相同邏輯 SQL 伺服器。您可以使用原始名稱還原，或是為還原的資料庫提供新的名稱。

如需詳細資訊以及使用 Azure 入口網站或 PowerShell 還原已刪除資料庫的詳細步驟，請參閱[還原已刪除的資料庫](sql-database-recovery-using-backups.md#deleted-database-restore)。您無法使用 Transact-SQL 進行還原。

> [AZURE.IMPORTANT] 如果邏輯伺服器已刪除，您就無法復原已刪除的資料庫。

### 從資料庫封存匯入

如果自動備份在目前的保留期限外發生資料遺失，而且您已封存資料庫，您可以[匯入封存的 BACPAC 檔案](sql-database-import.md)到新的資料庫。此時您可以將原始資料庫取代為匯入的資料庫，或從匯入的資料將所需的資料複製到原始資料庫。

## 將資料庫從 Azure 區域資料中心中斷復原到另一個區域

<!-- Explain this scenario -->

雖然很罕見，但是 Azure 資料中心有可能會中斷。發生中斷時，可能只會讓業務中斷幾分鐘，也可能會持續幾小時。

- 其中一個選項是在資料中心中斷結束時等待您的資料庫重新上線。這適用於可以容忍資料庫離線的應用程式。例如，您不需要不斷處理的開發專案或免費試用版。當資料中心中斷時，您不會知道中斷會持續多久，因此這個選項僅適用於您可以一段時間暫時不需要資料庫。
- 另一個選項是容錯移轉到另一個資料區域 (如果您使用主動式異地複寫) 或使用異地備援資料庫備份進行復原 (異地還原)。容錯移轉只需要幾秒鐘的時間，而從備份復原將需要幾個小時。

當您採取行動時，復原所需的時間，以及資料中心中斷而導致多少資料遺失，取決於您如何決定在應用程式中使用上述討論的商務持續性功能。事實上，您可以根據應用程式需求，選擇使用資料庫備份和主動式異地複寫的組合。如需使用這些商務持續性功能的獨立資料庫和彈性集區的應用程式設計考量，請參閱[設計雲端災害復原的應用程式](sql-database-designing-cloud-solutions-for-disaster-recovery.md)和[彈性集區災害復原策略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)。

下列各節概述使用資料庫備份或主動式異地複寫來進行復原的步驟。如需包括規劃需求的詳細步驟、復原後步驟以及如何模擬中斷以執行災害復原演練的資訊，請參閱[從中斷復原 SQL Database](sql-database-disaster-recovery.md)。

### 準備中斷

無論您要使用何種商務持續性功能，您都必須︰

- 識別並準備目標伺服器，包括伺服器層級防火牆規則、登入和 master 資料庫層級權限。
- 決定您要如何重新導向用戶端與用戶端應用程式到新的伺服器
- 記錄其他相依性，例如稽核設定和警示
 
如果您沒有適當地計劃和準備，容錯移轉或復原之後將您的應用程式連線會需要更長時間，也可能會需要在有壓力的情況下進行疑難排解 - 這會是不良的組合。

### 容錯移轉至異地複寫的次要資料庫 

如果您使用主動式異地複寫做為復原機制，請[強制容錯移轉至異地複寫的次要資料庫](sql-database-disaster-recovery.md#failover-to-geo-replicated-secondary-database)。在幾秒鐘內，次要資料庫就會升級成為新的主要資料庫，而且準備好記錄新的交易，並回應任何查詢 - 只會遺失幾秒尚未複寫的資料。如需自動化容錯移轉程序的資訊，請參閱[設計雲端災害復原的應用程式](sql-database-designing-cloud-solutions-for-disaster-recovery.md)。

> [AZURE.NOTE] 當資料中心再次上線時，您就可以選擇容錯回復到原始的主要資料庫。

### 執行異地還原 

如果您使用自動備份與異地備援儲存體複寫做為復原機制，請[使用異地還原起始資料庫復原](sql-database-disaster-recovery.md#recover-using-geo-restore)。在大部分情況下，復原將會在 12 小時內進行，並且遺失最多 1 小時的資料，取決於最後一個每小時差異備份是何時進行和複寫。在復原完成之前，資料庫將無法記錄任何交易或回應任何查詢。

> [AZURE.NOTE] 如果資料中心在您的應用程式切換到復原的資料庫之前就再次上線，您只要取消復原即可。

### 執行容錯移轉後/復原後工作 

從任何一種復原機制復原之後，您都必須執行下列額外的工作，您的使用者和應用程式才能回復啟動並執行︰

- 重新導向用戶端與用戶端應用程式到新的伺服器與還原的資料庫
- 請確定有適當的伺服器層級防火牆規則供使用者連線 (或使用[資料庫層級防火牆](sql-database-firewall-configure.md#creating-database-level-firewall-rules))
- 請確定有適當的登入和 master 資料庫層級權限 (或使用[自主的使用者](https://msdn.microsoft.com/library/ff929188.aspx))
- 依適當情況設定稽核
- 依適當情況設定警示

## 在最少停機時間的情況下升級應用程式

有時候應用程式因為計劃性維護 (例如應用程式升級) 而必須離線。[管理應用程式升級](sql-database-manage-application-rolling-upgrade.md)說明如何使用主動式異地複寫來輪流升級雲端應用程式，將升級期間的停機時間降至最低，並提供萬一發生錯誤時的復原路徑。本文將探討兩種不同的升級程序協調方法，並討論每個選項的優缺點。

## 後續步驟

如需獨立資料庫和彈性集區的應用程式設計考量，請參閱[設計雲端災害復原的應用程式](sql-database-designing-cloud-solutions-for-disaster-recovery.md)和[彈性集區災害復原策略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)。

<!---HONumber=AcomDC_0727_2016-->