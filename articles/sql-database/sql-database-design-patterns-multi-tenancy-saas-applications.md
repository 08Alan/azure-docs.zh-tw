<properties
   pageTitle="多租用戶 SaaS 應用程式與 Azure SQL Database 的設計模式"
   description="本文討論雲端環境中執行的多租用戶資料庫應用程式需要考慮的需求和通用資料架構模式，以及這些模式相關的各種利弊取捨。其中也說明 Azure SQL Database 服務搭配其彈性資料庫集區和彈性工具，如何在無需妥協的情況下滿足這些需求。"
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management"
   ms.date="03/22/2016"
   ms.author="carlrab"/>

# 多租用戶 SaaS 應用程式與 Azure SQL Database 的設計模式

在本文中，您將了解雲端環境中執行的多租用戶軟體即服務 (SaaS) 資料庫應用程式需要考慮的需求和通用資料架構模式，以及這些模式相關的各種利弊取捨。其中也說明 Azure SQL Database 服務搭配其彈性資料庫集區和彈性工具，如何在無需妥協的情況下滿足這些需求。

## 簡介

從最近幾年來與 SaaS 應用程式提供者的合作中，我們發現，開發人員在設計多租用戶應用程式資料層的租用模型時，他們所做的選擇經常違背最佳的長期利益。至少在一開始，認為輕鬆開發和較低的雲端提供者成本，比應用程式的租用戶隔離或延展性更重要。這通常會在日後導致客戶滿意度出現問題，並為了修正方向而付出代價。

在本文中，多租用戶應用程式是指雲端環境中裝載的應用程式，提供一組相同服務給不共用或看不到彼此資料的多個 (數百或數千) 租用戶。SaaS 應用程式就是這種服務的典型例子，能夠提供服務給雲端託管環境中的租用戶。

## 多租用戶應用程式

在可輕易分割資料和工作負載的應用程式類型中，多租用戶應用程式算是很明顯的例子。比方說，在多租用戶應用程式中，資料和工作負載通常可以沿著租用戶界限分割，因為大部分要求都在租用戶的界限之內。這是資料和工作負載與生俱來的屬性，支援本文的整個其餘部分將討論的應用程式模式。

在整個雲端式應用程式範疇內，這類應用程式隨處可見，包括
- 轉換成雲端即 SaaS 應用程式的 ISV 資料庫應用程式
- 從無到有針對雲端而建置的 SaaS 應用程式
- 直接面向取用者/使用者的應用程式 
- 面向員工的企業應用程式

從雲端產生的 SaaS 應用程式和根植於 ISV 資料庫應用程式的 SaaS 應用程式，通常會演化成多租用戶應用程式。這些 SaaS 應用程式提供特殊的軟體應用程式即服務給其租用戶。租用戶可以存取應用程式服務，對於隨應用程式一起儲存的相關資料，也具有完整的擁有權。但為了享受 SaaS 的優點，租用戶在其本身的資料上必須讓出一定程度的控制權，信任 SaaS 廠商會妥善保管資料，並與其他租用戶的資料隔離。常見的例子包括 MyOB、SnelStart、Salesforce 等。所有這些應用程式都允許沿著租用戶界限來分割，因此，支援本文下列各節所討論的應用程式模式。

提供直接服務給取用者或組織內員工 (通常稱為使用者，而不是租用戶) 的應用程式，在多租用戶應用程式範疇內形成另一種類別。客戶只訂閱服務，並不擁有服務提供者所收集和儲存的資料。除非基於政府強制規定的隱私權法規，服務提供者不會嚴格要求隔離客戶彼此的資料。典型的例子是媒體內容提供者，例如 Netflix、Spotify、Xbox-live 等。還有其他可輕鬆分割的應用程式例子，包括面向客戶的網際網路等級應用程式，或物聯網 (IoT) 應用程式，其中，每個客戶或裝置都可能成為分割區，在不同的使用者或裝置之間就可以畫出分割區界限。

不過，我們也了解並非所有應用程式都可輕易地沿著單一屬性來分割，例如租用戶、客戶、使用者或裝置。比方說，以涉及產品、訂單、客戶的複雜 ERP (企業資源規劃) 應用程式為例子。它們通常使用複雜的結構描述，具有數千個緊密相互連結的資料表。單一分割策略不可能適用於所有資料表和運用於整個工作負載。因此，在本文其餘的整個討論中，我們明確排除這種應用程式。

在下列各節中，我們探索的多租用戶設計模式適用於上述所有應用程式模式，它們具有可輕鬆分割的資料和工作負載。不過，為了簡化說明，我們直接以多租用戶 SaaS 應用程式來代表它們全體。

## 多租用戶應用程式設計取捨

對於在雲端中建置多租用戶應用程式的開發人員，有下列總體考量︰

-	***隔離租用戶***︰開發人員必須確保租用戶不可能越權存取其他租用戶的資料。此隔離需求會延伸出其他屬性，例如避開吵雜的芳鄰、能夠還原特定租用戶的資料、租用戶特定的自訂等。 
-	***雲端資源成本***：SaaS 應用程式需要具有成本競爭力。有鑑於此，SaaS 應用程式的開發人員在設計多租用戶應用程式時，將力求降低雲端資源使用量的成本 (計算、儲存體等)。
-	***簡化 DevOps***︰多租用戶應用程式提供者需要建置隔離保護、維護其應用程式、資料庫結構描述、監視其健全狀況，以及對租用戶的問題進行疑難排解。應用程式開發和作業的複雜性會直接導致成本增加和租用戶滿意度降低。
-	***延展性***︰逐漸增加更多租用戶，同時為需要更多資源的個別租用戶增加更多容量，乃是 SaaS 作業成功的不二法門。

這些方面有其利弊取捨。成本最低的雲端產品不見得提供最方便的開發經驗。在上述四方面交織而成的問題上，常見開發人員做出不明智的選擇。

對於供應給其他企業的 SaaS 多租用戶應用程式，租用戶隔離經常是基本需求。常見開發人員在簡單性和成本考量方面短視近利，而不重視隔離和延展性。隨著服務不斷發展，以及租用戶隔離需求變得更加重要，這項取捨會使情況更趨於複雜且代價昂貴，需要在應用程式層次解決。

對於提供直接面向取用者的服務給使用者的多租用戶應用程式，很可能為了讓雲端資源成本發揮最高效益，而較不重視租用戶隔離。

常見的開發模式是將多個租用戶裝入一個或幾個資料庫中。這種方法的 (表面上) 好處是成本較低，只需付出少數幾個資料庫的成本，並儘可能只處理越少的資料庫，讓事情變得更簡單。對於 SaaS 多租用戶應用程式，經過一段時間，這種決定會在租用戶隔離和延展性方面開始暴露重大的缺點。如果需要租用戶隔離，將需要投入更多心力，以防止未經授權存取或吵雜的芳鄰干擾共用儲存體中的租用戶資料，因而造成應用程式開發工作和隔離維護成本急遽暴增。同樣地，當加入新的租用戶時，為了適當調整這類應用程式的資料層，通常需要憑藉開發專長，將租用戶資料重新分散於資料庫之間。

## 多租用戶資料模型 

放置租用戶資料的常見設計做法都遵循這三種不同的模型。


  ![多租用戶資料模型](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-multi-tenant-data-models.png) 圖 1︰多租用戶資料模型的常見設計做法
  
1.	***租用戶各有資料庫***︰這種方法將每個租用戶放在它自己的資料庫中。租用戶特定的所有資料都封閉在其資料庫內，與其他租用戶及其資料隔離。
2.	***共用資料庫分區化***︰這種方法使用多個資料庫，由多個租用戶共用一個資料庫，也就是運用分割策略 (例如雜湊、範圍或清單分割)，將一組不同的租用戶指派至每個資料庫此資料分散策略通常稱為分區化。
3.	***共用資料庫單一***︰這種方法使用單一資料庫 (有時很大)，其中包含以租用戶識別碼來區分的所有租用戶的資料。 
  
> [AZURE.NOTE] 有時，不同的租用戶也會放在不同的資料庫結構描述中，並以結構描述名稱來區分不同的租用戶。這種方法通常需要使用動態 SQL，也無法有效利用計畫快取，不建議採用。因此，本文的其餘部分著重於此類別中的共用資料表方法。
 
## 常用多租用戶資料模型的特性

評估使用這些多租用戶資料模型時，必須根據我們在上一節討論的應用程式設計取捨來做決定。

-	***隔離***︰以租用戶之間的隔離程度，衡量資料模型可達成的租用戶隔離效果，以及
-	***雲端資源成本***︰為了讓雲端資源成本發揮最高效益，而在租用戶之間發生的資源共用規模。資源可定義為計算和儲存體成本。 
-	***DevOps 成本***︰簡化應用程式開發、部署和管理性可降低整體的 SaaS 作業成本。  

根據這幾方面，我們可以透過象限空間，描繪先前所述的多租用戶資料模型及其資料庫使用量，如下圖 2 所示。租用戶隔離程度和資源共用規模描述空間的 Y 和 X 軸維度。中間的大型對角線箭號表示 DevOps 成本。

![popular patterns](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-popular-application-patterns.png) 圖 2︰常用多租用戶資料模型的特性

上圖 2 右下方的象限顯示使用可能很大的單一共用資料庫，並搭配共用資料表 (或另一個結構描述)，做為其中一個應用程式模式。因為所有租用戶都使用單一資料庫上相同的資料庫資源 (CPU、記憶體和 IO...)，資源共用程度很高。不過，租用戶隔離有限。需要採取額外的步驟，在應用程式層級上隔離租用戶彼此，這在應用程式開發和管理方面，可能會大幅增加 DevOps 成本。此外，延展性受限於用來裝載資料庫的硬體尺度。

中間區段說明在多個不同資料庫之間分區化的多個租用戶 (通常是不同的硬體縮放單位)，每個資料庫裝載一部分租用戶，這就解決前一個模式的延展性考量。如果需要新的容量來因應更多租用戶，只要將租用戶放在配置給新硬體縮放單位的新資料庫即可，很簡單。不過，資源共用規模會縮小，因為只有放在相同縮放單位的租用戶才會共用資源。此外，這種方法也無助於改善租用戶隔離，因為仍有許多租用戶共置於相同的位置，自然無法免於彼此動作的干擾。應用程式複雜度仍然很高。這種方法通常稱為「分區化」。

上圖 2 左上方的象限是第三種方法。它將每個租用戶放在自己的資料庫中。這種方法的租用戶隔離特性很顯著，但是當每個資料庫提供它自己專用的資源時，資源共用效益就很低。如果所有租用戶都展現可預測的工作負載，這會是個好方法。不過，一旦租用戶工作負載變得較難預測 (常見於 SaaS)，資源共用就無法最佳化，導致提供者為了因應需求而過度佈建，或因為資源減少而導致成本增加或租用戶滿意度降低。因此，租用戶之間的資源共用程度越高，才能使解決方案越符合成本效益。增加資料庫數目也會在應用程式部署和維護方面增加 DevOps 成本。在下一節，我們將回頭討論這些問題，但務必記住，相較於其他方法，此方法為租用戶提供最佳又最簡單的隔離。

以下其他因素也會影響客戶選擇設計模式︰

-	***租用戶資料的擁有權***︰如果租用戶保留資料的擁有權，應該選擇個別租用戶單一資料庫模式
-	***規模***︰如果應用程式以數十萬或數百萬個租用戶為目標，應該選擇資料庫共用方法，例如分區化，但仍可能要解決隔離需求。
-	***價值和商務模型***︰如果個別租用戶營收很少 (少於一美元)，隔離需求會變得較不重要，而共用資料庫會較有意義。如果有幾美元或更多，則個別租用戶資料庫會變得較為可行，也能降低應用程式開發作業成本。

根據上圖 2 所示的取捨，理想的多租用戶模型必須兼顧卓越的租用戶隔離特性，讓租用戶之間資源共用達到最佳化，也就是符合右上方象限的模型。

## Azure SQL Database 的多重租用支援

Azure SQL Database 支援圖 2 所示的所有多租用戶應用程式模式。搭配彈性資料庫集區，現在更支援一種新的應用程式模式，結合「租用戶各有資料庫」方法 (下圖 3 右上方的綠色象限) 絕佳的資源共用和隔離優點。Azure SQL Database 中的彈性資料庫工具和功能，有助於降低 DevOps 成本來開發和操作具有許多資料庫的應用程式 (下圖 3 的陰影區)。這些工具有助於採用任何多資料庫模式來建置和管理應用程式。下列小節更詳細討論 SQL Database 功能，以及 SQL Database 如何協助這些多租用戶模型。

![pattern SQL DB](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-patterns-sqldb.png) 圖 3：多租用戶應用程式模型與 Azure SQL Database

## 租用戶各有資料庫模型與彈性集區和工具

Azure SQL Database 提供「彈性資料庫集區」來加強支援「租用戶各有資料庫」方法，結合租用戶隔離與租用戶資料庫之間的資源共用。這設計成資料層方案供 SaaS 提供者建置多租用戶應用程式。結合彈性資料庫工具供應項目時，多重租用會變成內建的，而租用戶之間的資源共用重擔會從應用程式下移到資料庫服務層。彈性作業、查詢、交易和彈性資料庫用戶端程式庫可簡化跨資料庫大規模管理/查詢的複雜性。

| 應用程式需求 | SQL Database 功能 |
| ------------------------ | ------------------------- |
| 租用戶隔離與資源共用 | [彈性資料庫集區︰](sql-database-elastic-pool.md)這項功能可以配置 SQLDB 資源集區，讓多個資料庫共用這些資源。此外，個別資料庫可以依需要從集區汲取資源，以因應租用戶工作負載變化而造成的容量需求遽增，而彈性集區本身也可以視需要而相應放大或縮小。彈性集區也支援在集區層級上輕鬆地管理、監視和疑難排解。 |
| 跨資料庫簡化 DevOps | [彈性資料庫集區︰](sql-database-elastic-pool.md)如上所示。|
||[彈性查詢︰](sql-database-elastic-query-horizontal-partitioning.md)能夠跨資料庫查詢以進行報告或跨租用戶分析。|
||[彈性作業︰](sql-database-elastic-jobs-overview.md)能夠封裝資料庫維護作業或資料庫結構描述變更，然後可靠地部署到多個資料庫。|
||[彈性交易︰](sql-database-elastic-scale.md)能夠以不可部分完成和隔離的方式，處理多個資料庫的變更。當應用程式在數個資料庫作業之間需要保證「全有或全無」時，就需要此功能。 |
||[彈性資料庫用戶端程式庫︰](sql-database-elastic-database-client-library.md)這項功能支援管理資料分佈並將租用戶對應到資料庫。 |
||||

## 共用的模型

如先前所述，大多數 SaaS 提供者的「共用模型」方法可能會引起租用戶隔離問題，以及應用程式開發和維護的複雜性。然而，對於直接提供服務給最終取用者的多租用戶應用程式，租用戶隔離需求的優先性可能敵不過成本最佳化的渴望。他們能夠以非常高的密度，將租用戶封裝在一或多個資料庫中，以降低成本。使用單一資料庫或多個分區化資料庫的共用資料庫模型，可以提高資源共用的效率，並降低整體成本。Azure SQL Database 提供一些功能，幫助這些取用者在資料層大規模建置隔離，以強化安全性和管理。

| 應用程式需求 | SQL Database 功能 |
| ------------------------ | ------------------------- |
| 安全性隔離功能 | [資料列層級安全性](https://msdn.microsoft.com/library/dn765131.aspx) |
|| [資料庫結構描述](https://msdn.microsoft.com/library/dd207005.aspx) |
| 跨資料庫簡化 DevOps | [彈性查詢](sql-database-elastic-query-horizontal-partitioning.md) |
|| [彈性工作](sql-database-elastic-jobs-overview.md) |
|| [彈性交易](sql-database-elastic-transactions-overview.md) |
|| [彈性資料庫用戶端程式庫](sql-database-elastic-database-client-library.md) |
|| [彈性資料庫分割/合併](sql-database-elastic-scale-overview-split-and-merge.md) |
||||

## 結論

對於大多數 SaaS 多租用戶應用程式，租用戶隔離需求非常重要。提供隔離的最佳選項幾乎仰賴於「租用戶各有資料庫」方法。其他兩種方法需要在應用程式層投入複雜的心力，需要有熟練的開發人員來提供隔離。這可能會大幅增加成本和風險。如果在服務開發初期不重視隔離需求，在前兩個模型中改造時會付出更大的代價。「租用戶各有資料庫」模型帶來的缺點在於，因為共用和維護不足，以及管理大量資料庫，導致雲端資源成本增加。SaaS 應用程式開發人員經常掙扎於這些取捨之中。

雖然這些取捨可能是大部分雲端資料庫服務提供者的主要障礙，但 Azure SQL Database 服務能夠以「彈性資料庫集區」和「彈性資料庫功能」，排除這些阻礙。SaaS 開發人員可以結合「租用戶各有資料庫」模型的隔離特性，同時最佳化資源共用，並利用彈性集區和相關的工具，改善大量資料庫的管理效率。

如果多租用戶應用程式提供者沒有租用戶隔離需求，還能夠以極高密度將租用戶封裝在資料庫中以降低成本，則「共用」資料模型可以提高資源共用的效率，並降低整體成本。Azure SQL Database 彈性資料庫工具、分區化程式庫和安全性功能，可協助 SaaS 提供者建置和管理這種多租用戶應用程式。

## 後續步驟

如需示範用戶端程式庫的範例應用程式，請參閱[開始使用彈性資料庫工具](sql-database-elastic-scale-get-started.md)。

若要將現有的資料庫轉換為使用該工具，請參閱[移轉現有的資料庫以相應放大](sql-database-elastic-convert-to-use-elastic-tools.md)。

透過[教學課程](sql-database-elastic-pool-create-portal.md)建立新的集區。

## 詳細資訊

[什麼是 Azure 彈性資料庫集區？](sql-database-elastic-pool.md)

[使用 Azure SQL Database 相應放大](sql-database-elastic-scale-introduction.md)

## 問題和功能要求

如有問題，請在 [SQL Database 論壇](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted)上與我們連絡，如需要求增加功能，請將這些功能新增至 [SQLSQL Database 意見反應論壇](https://feedback.azure.com/forums/217321-sql-database/)。









	

<!---HONumber=AcomDC_0525_2016-->