<properties 
   pageTitle="Azure SQL Database 資源限制"
   description="此頁面描述一些 Azure SQL Database 常見的資源限制。"
   services="sql-database"
   documentationCenter="na"
   authors="rothja"
   manager="jeffreyg"
   editor="monicar" />
<tags 
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="07/24/2015"
   ms.author="jroth" />

# Azure SQL Database 資源限制

Azure SQL Database 會監視共用資源的使用情況，例如交易記錄、I/O 和許多其他資源。這樣可讓 Azure SQL Database 將資料庫保留在設定的資源界限之內。此資源界限或臨界值稱為資源限制。當用戶端的資源使用量超出這些限制時，無論是在租用戶或實體節點層級，Azure SQL Database 都會藉由管理資源使用情況來回應，導致連接遺失或要求被拒絕。

> [AZURE.NOTE]當資源限制防止查詢分析資料庫效能問題時，您可能需要使用專用管理員連接 (DAC)，從 Azure SQL Database V12 起可供使用。如需有關使用 DAC 的詳細資訊，請參閱[資料庫管理員的診斷連接](https://msdn.microsoft.com/library/ms189595.aspx)。

## 資源限制摘要表

下表提供每個資源的限制摘要，超過這些限制時，Azure SQL Database 會拒絕要求或終止受影響資源的連接，並且傳回錯誤程式碼。在某些情況下，服務層 (基本、標準、進階) 和效能層級可決定實際的限制。在這些情況下，請參閱 [Azure SQL Database 服務層和效能層級](https://msdn.microsoft.com/library/azure/dn741336.aspx)。

[AZURE.INCLUDE [azure-sql-database-limits](../../includes/azure-sql-database-limits.md)]

## 了解錯誤代碼

有時候會因為一個資源的多個限制條件而傳回相同的錯誤程式碼。這些條件會在錯誤訊息中識別為狀態。例如，因為交易記錄長度資源而顯示下列兩個錯誤訊息。雖然訊息的文字相同，但是根據不同的限制條件有不同的狀態值 (分別為 1 和 2)。

錯誤訊息 1：

	Msg 40552, Level 17, State 1, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

錯誤訊息 2：

	Msg 40552, Level 17, State 2, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

同樣的情況適用於在某些訊息中出現的資源識別碼。資源識別碼會轉譯成經歷限制的系統資源。

此主題的其餘部分說明可能的錯誤代碼的詳細資料，包括執行個體，狀態值和資源識別碼會在其中提供有關錯誤的其他資訊。

## 資料庫大小

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 配置給使用者資料庫的資料庫空間已滿時，使用者會取得資料庫已滿的錯誤。 |
| **錯誤碼** | **40544**：資料庫已達到大小配額。資料分割或刪除資料、卸除索引，或參閱可能解決方式的文件。 |
| **限制** | 取決於[服務層和效能層級](https://msdn.microsoft.com/library/azure/dn741336.aspx)。 |
| **被拒絕的要求類型** | 非 Select DML (Insert、Update、插入或更新的 Merge)。 |
| **建議** | 使用 DELETE/DROP 陳述式，從資料庫移除資料，直到資料庫的大小在限制之內為止。 |

## 登入

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | SQL Database 掌管可建立於資料庫之並行登入的數目限制。到達資料庫的並行登入限制時，會拒絕對資料庫的新登入要求，並傳回錯誤碼 10928。 |
| **錯誤碼** | **10928**：資源識別碼：3。資料庫的 %s 限制是 %d，且已達到。請參閱 http://go.microsoft.com/fwlink/?LinkId=267637 尋求協助。 |
| **限制** | 取決於[服務層和效能層級](https://msdn.microsoft.com/library/azure/dn741336.aspx)。 |
| **建議** | 檢查 dm\_exec\_connections 以檢視哪些使用者連線目前為作用中。<br><br>10 秒後退避及重試登入。 |

> [AZURE.NOTE]錯誤訊息中的資源識別碼值會指出已達到限制的資源。對於登入，資源識別碼 = 3。

## 記憶體使用量

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 當工作階段等候記憶體授權超過 20 秒時，使用超過 16 MB 記憶體授權超過 20 秒的工作階段會依照保留資源的時間遞減順序終止，所以最舊的工作階段會先終止。所需的記憶體可供使用時，就會停止工作階段的終止。 |
| **錯誤碼** | **40553**：已終止工作階段，因為過度使用記憶體。請嘗試修改查詢以處理較少的資料列。 |
| **限制** | 超過 16 MB 的記憶體授權超過 20 秒。 |
| **被拒絕的要求類型** | 使用記憶體授權的查詢，包括使用排序和雜湊聯結的查詢。 |
| **建議** | 針對需要排序及/或雜湊聯結的查詢執行查詢微調。 |

## 工作階段

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | SQL Database 會掌管可建立於資料庫之並行工作階段的數目限制。到達資料庫的並行工作階段限制時，資料庫的新連接會遭到拒絕，使用者將會收到錯誤碼 10928。不過，資料庫的現有工作階段不會終止。 |
| **錯誤碼** | **10928**：資源識別碼：2。資料庫的 %s 限制是 %d，且已達到。請參閱 http://go.microsoft.com/fwlink/?LinkId=267637 尋求協助。 |
| **限制** | 取決於[服務層和效能層級](https://msdn.microsoft.com/library/azure/dn741336.aspx)。 |
| **建議** | 檢查 dm\_exec\_requests 來檢視目前正在執行哪些使用者要求。 |

> [AZURE.NOTE]錯誤訊息中的資源識別碼值會指出已達到限制的資源。對於工作階段，資源識別碼 = 2。

## Tempdb

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 您對 tempdb 的要求可能會因為下列三個條件的任何一個而遭到拒絕：<br><br>\*\*狀態 1：\*\*當工作階段使用超過 5 GB 的 tempdb 空間時，就會終止工作階段。<br><br>\*\*狀態 2：\*\*tempdb 中記錄檔超過 2 GB 大小的交易將會被截斷。在 tempdb 中使用記錄檔空間的範例作業：插入、更新、刪除、合併、建立索引。<br><br>\*\*狀態 3：\*\*tempdb 中未認可的交易可以封鎖記錄檔的截斷。若要避免這個問題，從最舊的使用中交易記錄序號 (LSN) 到 tempdb 中記錄的結尾 (最新的 LSN) 之間的距離不能超過記錄檔大小的 20%。違反此規定時，tempdb 中違反規定的交易會終止並且復原，以便截斷記錄。 |
| **錯誤碼** | **40551**：已終止工作階段，因為過度使用 tempdb。請嘗試修改查詢，以減少使用暫存資料表空間。 |
| **限制** | **狀態 1：**5 GB 的 tempdb 空間<br><br>**狀態 2：**在 tempdb 中每筆交易為 2 GB<br><br>\*\*狀態 3：\*\*tempdb 中總記錄檔空間的 20% |
| **被拒絕的要求類型** | 在 tempdb 上的任何 DDL 或 DML 陳述式。 |
| **建議** | 修改查詢來減少暫存資料表空間的使用量、在不需要暫存物件之後將其卸除、截斷資料表，或移除未使用的資料表。藉由減少資料列數目或是將作業分割成多筆交易，可讓您在 tempdb 中縮減交易中的資料大小。 |

## 交易持續時間

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 交易要求鎖定其所依賴的的資源，例如資料列、頁面或資料表，然後在交易不再依賴鎖定資源時釋放鎖定。您的要求可能會因為下列兩個條件的任何一個而遭到拒絕：狀態 1：如果交易已經執行超過 24 小時，它就會終止。狀態 2：如果交易鎖定基礎系統工作所需的資源超過 20 秒，它就會終止。 |
| **錯誤碼** | **40549**：工作階段已終止，因為您有長時間執行的交易。請嘗試縮短您的交易時間。 |
| **限制** | **狀態 1：**24 小時<br><br>\*\*狀態 2：\*\*20 秒，如果交易鎖定基礎系統工作所需的資源 |
| **被拒絕的要求類型** | 任何已經執行超過 24 小時的交易，或任何取得鎖定的 DDL 或 DML 陳述式，都會導致封鎖系統工作。 |
| **建議** | 針對 SQL Database 的作業不應該封鎖使用者輸入，或有其他會導致長時間執行交易的相依性。 |

## 交易鎖定計數

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 使用了超過一百萬個鎖定的工作階段會終止。 |
| **錯誤碼** | **40550**：工作階段已終止，因為它取得太多鎖定。嘗試在單一交易中讀取或修改較少的資料列。 |
| **限制** | 每筆交易 1 百萬個鎖定 |
| **被拒絕的要求類型** | 任何 DDL 或 DML 陳述式。 |
| **建議** | 以下 DMV 可用來監視交易：**sys.dm\_tran\_active\_transactions**、**sys.dm\_tran\_database\_transactions**、**sys.dm\_tran\_locks** 和 **sys.dm\_tran\_session\_transactions**。根據應用程式類型，可以使用粒度更粗的鎖定提示，例如 **PAGLOCK** 或 **TABLOCK**，以減少指定陳述式/交易中取得鎖定的數目。請注意，這樣會對應用程式並行存取產生負面影響。 |

## 交易記錄檔長度

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | 您的要求可能會因為下列兩個條件的任何一個而遭到拒絕：<br><br>\*\*狀態 1：\*\*SQL Database 支援交易產生大小上限為 2 GB 的記錄檔。記錄檔超出此限制的交易會被截斷。可在此磁碟區中使用記錄檔空間的範例作業：插入、更新、刪除、合併、建立索引。<br><br>\*\*狀態 2：\*\*未認可的交易可以封鎖記錄檔的截斷。若要避免這個問題，從最舊的使用中交易記錄序號 (LSN) 到記錄的結尾 (最新的 LSN) 之間的距離不能超過記錄檔大小的 20%。違反此規定時，違反規定的交易會終止並且復原，以便截斷記錄。 |
| **錯誤碼** | **40552**：已終止工作階段，因為過度使用交易記錄檔空間。請嘗試在單一交易中修改較少的資料列。 |
| **限制** | **狀態 1：**每筆交易 2 GB<br><br>\*\*狀態 2：\*\*總記錄空間的 20% |
| **被拒絕的要求類型** | 任何 DDL 或 DML 陳述式。 |
| **建議** | 對於資料列作業，減少交易中的資料大小，例如減少資料列數目或是將作業分割成多筆交易。對於需要單一交易的資料表/索引作業，請確認遵循以下公式：資料表中受影響的資料列數目 \* (更新位元組 + 80 之欄位的平均大小) < 2 GB (如果是索引重建，更新之欄位的平均大小應該取代為平均索引大小)。 |

## 背景工作執行緒 (最大並行要求)

| &nbsp; | 相關資訊 |
| :--- | :--- |
| **條件** | SQL Database 會掌管資料庫的背景工作執行緒 (並行要求) 數目限制。並行要求數目超出允許限制的任何資料庫都會收到錯誤 10928，且對該資料庫提出的進一步要求都可能遭到拒絕。 |
| **錯誤碼** | **10928**：資源識別碼：1。資料庫的 %s 限制是 %d，且已達到。請參閱 http://go.microsoft.com/fwlink/?LinkId=267637 尋求協助。<br><br>\*\*10929\*\*：資源識別碼：1。%s 最小保證是 %d，最大限制是 %d，而資料庫的目前使用量是 %d。但伺服器目前太忙碌，無法針對此資料庫支援大於 %d 的要求。請參閱 http://go.microsoft.com/fwlink/?LinkId=267637 尋求協助。或者，請稍後再試一次。 |
| **限制** | 對於基本、標準和進階層，它會取決於[效能層級](https://msdn.microsoft.com/library/azure/dn741336.aspx)。對於較舊的 Web/Business edition 資料庫，並行要求的最大限制為 180，而且可能比較不會取決於系統活動。 |
| **建議** | 檢查 dm\_exec\_requests 來檢視目前正在執行哪些使用者要求。<br><br>在 10 秒後退避和重試要求。 |

> [AZURE.NOTE]錯誤訊息中的資源識別碼值會指出已達到限制的資源。對於背景工作執行緒，資源識別碼 = 1。

因為掌管背景工作執行緒而發生的錯誤 (10928/10929) 會取代背景工作執行緒的原始引擎節流錯誤 (40501)。在正常情況下，使用者應該不會再收到背景工作執行緒的引擎節流錯誤。

在某些類似使用同盟資料庫功能的案例中，可以在登入資料庫時叫用背景工作執行緒上限錯誤 (10928)，因為這項作業會利用 Connection.Open 呼叫下的背景工作執行緒。這樣可能會將應用程式置於背景工作執行緒上限臨界值之上。應用程式應該有內建的邏輯，以適當處理這個錯誤，才能處理這種情況。

## 另請參閱

[Azure SQL Database 資源管理](https://msdn.microsoft.com/library/azure/dn338083.aspx)

[SQL Database 用戶端程式的錯誤訊息](sql-database-develop-error-messages.md)

[避免拒絕要求或連接終止的 Azure SQL Database 最佳作法](https://msdn.microsoft.com/library/azure/dn338082.aspx)

<!---HONumber=July15_HO5-->