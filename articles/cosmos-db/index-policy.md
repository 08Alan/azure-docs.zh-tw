---
title: Azure Cosmos DB 索引編製原則
description: 了解 Azure Cosmos DB 中編製索引的運作方式。 了解如何設定編製索引原則，以自動編製索引並追求更高的效能。
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 3/1/2019
ms.author: mjbrown
ms.openlocfilehash: 0ba5cdd4f92390634d6d2bea8add8309cb1f4d3e
ms.sourcegitcommit: 2d0fb4f3fc8086d61e2d8e506d5c2b930ba525a7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/18/2019
ms.locfileid: "58014480"
---
# <a name="index-policy-in-azure-cosmos-db"></a>Azure Cosmos DB 中的索引原則

您可以藉由設定下列參數，在 Azure Cosmos 容器上覆寫預設的編製索引原則：

* **在索引中包含或排除項目和路徑**：當您在容器中插入或取代項目時，可以在索引中排除或包含特定項目。 您也可以包含或排除要在容器之間編製索引的特定路徑/屬性。 路徑可能包含萬用字元模式，例如 *。

* **設定索引類型**：除了已編製範圍索引的路徑，您還可以新增其他類型的索引 (例如空間)。

* **設定索引模式**：藉由在容器上使用編製索引原則，您就能設定不同的編製索引模式，例如「一致」或「無」。

## <a name="indexing-modes"></a>編製索引模式

Azure Cosmos DB 支援兩種您可在 Azure Cosmos 容器上設定的編製索引模式。 您可以透過編製索引原則來設定下列兩個編製索引模式：

* **一致**：如果將 Azure Cosmos 容器的原則設為「一致」，特定容器上的查詢就會遵循與針對讀數指定的相同一致性層級 (例如，強式、限定過期、工作階段或最終)。 

  當您更新項目時，即會同步更新索引。 例如，項目上的插入、取代、更新和刪除作業將導致索引更新。 一致的編製索引支援一致的查詢，但代價是會影響寫入輸送量。 減少寫入輸送量取決於「已在編製索引時包含路徑」和「一致性層級」。 一致的編製索引模式是針對快速寫入和立即查詢的工作負載而設計的。

* **無**：含有「無」索引模式的容器沒有任何與其相關聯的索引。 如果使用 Azure Cosmos 資料庫作為索引鍵值儲存體，且只能依據項目的識別碼屬性來存取它們，通常會使用此模式。

  > [!NOTE]
  > 將編製索引模式設為「無」，即會產生卸除所有現有索引的副作用。 如果您的存取模式只需要識別碼或自我連結，則應使用此選項。

查詢一致性層級的維護方式類似於一般讀取作業。 如果您查詢含有「無」編製索引模式的容器，Azure Cosmos 資料庫就會傳回錯誤。 您可以透過 REST API 中明確的  **x-ms-documentdb-enable-scan**  標頭，或透過使用 .NET SDK 的  **EnableScanInQuery** 要求選項，以掃描形式執行查詢。 **EnableScanInQuery** 目前不支援某些查詢功能 (例如 ORDER BY)，因為它們會授權對應的索引。

## <a name="modifying-the-indexing-policy"></a>修改編製索引原則

在 Azure Cosmos DB 中，您隨時都可更新容器的編製索引原則。 變更 Azure Cosmos 容器上的編製索引原則可能導致索引形式的變更。 此變更會影響可編製索引的路徑、其精確度，以及索引本身的一致性模型。 變更編製索引原則時，需要將舊的索引有效率地轉換成新的索引。

### <a name="index-transformations"></a>索引轉換

所有的索引轉換都會在線上執行。 每個舊原則上已編製索引的項目都會根據每個新原則有效率地轉換，而不會影響容器的寫入可用性或佈建的輸送量。 藉由使用 REST API、SDK 或從預存程序和觸發程序來執行的讀取和寫入作業一致性，在索引轉換期間並不會受到影響。

變更編製索引原則是一個非同步作業，而完成此作業的時間取決於項目數、佈建的輸送量和項目大小。 正在重新編製索引時，如果查詢碰巧用到正在修改的索引，則查詢可能不會傳回所有相符的結果，且查詢將不會傳回任何錯誤/失敗。 正在重新編製索引時，不論編製索引模式設定為何，查詢最終都會一致。 在索引轉換完成後，您將繼續看見一致的結果。 這適用於透過 REST API、SDK 之類的介面，或預存程序和觸發程序所發出的查詢。 索引轉換是以非同步方式，使用適用於特定複本的備用資源，在複本的背景中執行。

所有的索引轉換均會就地執行。 Azure Cosmos DB 不會維護兩份索引。 因此，進行索引轉換時，您的容器中不需要也不會取用任何額外的磁碟空間。

當您變更編製索引原則時，主要會依據編製索引模式設定來套用變更，以便從舊索引移至新索引。 相較於包含/排除的路徑、索引種類及精確度之類的其他屬性，編製索引模式設定扮演了主要角色。

如果舊的和新的編製索引原則都使用**一致**的編製索引，Azure Cosmos 資料庫就會線上執行索引轉換。 您無法在轉換進行時，使用一致的編製索引模式套用另一個編製索引原則變更。 當您移至「無」編製索引模式時，就會立即卸除索引。 當您想要取消進行中的轉換，並重新開始其他編製索引原則時，移至「無」相當實用。

為了使索引轉換能順利完成，請確認容器具備足夠的儲存空間。 如果容器已達其儲存體配額，就會暫停索引轉換。 一旦有可用的儲存空間 (例如，當您刪除某些項目時)，索引轉換即會自動繼續。

## <a name="modifying-the-indexing-policy---examples"></a>修改編製索引原則 - 範例

以下是您可在其中更新編製索引原則的最常見使用案例：

* 如果您想要在正常作業期間提供一致的結果，但在大量資料匯入期間，切換回**無**編製索引模式。

* 如果您想要在目前的 Azure Cosmos 容器上開始使用編製索引功能。 例如，您可以使用地理空間查詢或 ORDER BY/字串範圍查詢，這兩種查詢分別需要空間索引種類及字串範圍索引種類。

* 如果您想要以手動方式選取要編製索引的屬性，並隨著時間變更它們來適應您的工作負載。

* 如果您想要調整編製索引精確度，以改善查詢效能或減少所取用的儲存體。

## <a name="next-steps"></a>後續步驟

在下列文章中深入了解編製索引：

* [編製索引概觀](index-overview.md)
* [索引類型](index-types.md)
* [索引路徑](index-paths.md)
* [如何管理編製索引原則](how-to-manage-indexing-policy.md)
