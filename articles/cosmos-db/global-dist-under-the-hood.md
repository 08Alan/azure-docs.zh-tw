---
title: 透過 Azure Cosmos DB 全域散發 - 運作原理
description: 此文章提供有關 Azure Cosmos DB 全域散發的技術詳細資料
author: dharmas-cosmos
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 03/31/2019
ms.author: dharmas
ms.reviewer: sngun
ms.openlocfilehash: 8c916a2fcff606a99e5c567318c1818ff7d5d273
ms.sourcegitcommit: 0ae3139c7e2f9d27e8200ae02e6eed6f52aca476
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/06/2019
ms.locfileid: "65071953"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>透過 Azure Cosmos DB 全域資料散發 - 運作原理

Azure Cosmos DB 是，Azure 中的基本服務，因此它會部署在所有 Azure 區域全球包括公開、 主權、 國防部 (DoD) 和政府雲端。 在資料中心內，我們會在大規模戳記的機器上部署及管理 Azure Cosmos DB，每部都有專屬的本機儲存體。 在資料中心內，Azure Cosmos DB 會跨許多叢集進行部署，每個可能都會執行多個世代的硬體。 群集中的计算机通常分散在 10 到 20 个容错域之间，以便在一个区域中实现高可用性。 下圖顯示 Cosmos DB 全域散發系統拓撲：

![系統拓撲](./media/global-dist-under-the-hood/distributed-system-topology.png)

**在 Azure Cosmos DB 全域散發是周全的：** 随时可以点击几下鼠标或者使用单个 API 调用以编程方式来添加或删除与 Cosmos 数据库关联的地理区域。 而 Cosmos 数据库包含一组 Cosmos 容器。 在 Cosmos DB 中，容器可用來作為散發和延展性的邏輯單元。 您所建立的集合、資料表和圖形 (在內部) 只是 Cosmos 容器。 容器对架构完全不可知，它提供查询范围。 Cosmos 容器中的資料都會在擷取時自動編製索引。 自動編製索引，可讓使用者查詢的資料，而無須操心結構描述或索引的管理，尤其是在世界各地安裝分散。  

- 在给定的区域中，可以使用分区键来分布容器中的数据。分区键由你提供，并由基础物理分区以透明方式进行管理（本地分布）。  

- 每個實體分割區也會跨地理區域複寫 (*全域散發*)。 

当使用 Cosmos DB 的应用以弹性方式在 Cosmos 容器中缩放吞吐量或使用其他存储时，Cosmos DB 将以透明方式处理所有区域中的分区管理操作（拆分、克隆、删除）。 不論是調整、散發或發生錯誤，Cosmos DB 都會繼續在容器內提供資料的單一系統映像，這些容器會跨任意數目的容器進行全域散發。  

如下圖所示，在容器內的資料會沿著兩個維度-單一區域內和跨區域，全球散發：  

![實體分割區](./media/global-dist-under-the-hood/distribution-of-resource-partitions.png)

物理分区是通过一组副本（称作副本集）实现的。 每台计算机托管数百个副本，这些副本对应于一组固定进程中的各个物理分区，如上图所示。 對應到實體分割區的複本均會動態放置，並在區域中叢集和資料中心內的機器間進行負載平衡。  

一個複本只會屬於一個 Azure Cosmos DB 租用戶。 每個複本都會裝載 Cosmos DB [資料庫引擎](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) \(英文\) 的執行個體，其會管理資源以及相關聯的索引。 Cosmos DB 資料庫引擎會在 Atom-記錄-序列 (ARS) 型的類型系統上運作。 该引擎对架构概念不可知，并将记录的结构与实例值之间的边界模糊化。 Cosmos DB 會以有效率的方式，在擷取時自動為每個項目編製索引，藉以達到完全不會區分結構描述的論點，讓使用者能夠查詢他們的全域散發資料，而不需處理結構描述或索引管理。

Cosmos 数据库引擎包含的组件可以实现多个协调基元、语言运行时、查询处理器，并包括分别负责事务存储和数据索引的存储子系统与索引子系统。 為了提供持久性和高可用性，資料庫引擎會在 SSD 上保存它的資料和索引，並且分別在複本集內的資料庫引擎執行個體之間複寫它。 大型租户的吞吐量和存储规模较高，并且数据和索引的副本数也较多。 系統的每個元件都是完全非同步的，沒有任何執行緒會遭到封鎖，而且每個執行緒都會進行短暫存留的工作，而不會產生任何不必要的執行緒切換。 速率限制和背壓會在整個堆疊上，從許可控制連接到所有 I/O 路徑。 Cosmos 数据库引擎旨在利用精细并发性和提供高吞吐量，同时可在有限的系统资源中运行。

Cosmos DB 的全域散發依賴兩個索引鍵的抽象概念 –*複本集*並*分割區集合*。 複本集是可用於協調的模組化 Lego 區塊，而分割集是一或多個地理位置分散之實體分割區的動態重疊。 若要了解全域散發的運作方式，我們需要了解這兩個關鍵抽象概念。 

## <a name="replica-sets"></a>複本集

實體分割區會具體化為自我管理和動態負載平衡的複本群組，這些複本會分散到多個容錯網域，稱為複本集。 此集合會共同實作複寫的狀態機器通訊協定，以使實體分割區中的資料高度可用、耐久且一致。 複本集成員資格*N*是動態的 – 它會保留之間變動*NMin*並*NMax*失敗，根據失敗、 系統管理作業，以及時間若要重新產生復原的複本。 根據成員資格變更，複寫通訊協定也會重新設定讀取和寫入仲裁的大小。 为了均匀分布分配给指定物理分区的吞吐量，我们采用了两种思路： 

- 首先，处理领先者写入请求的开销高于对后继者应用更新的开销。 同樣地，前端項目預算的系統資源會比實行項目還要多。 

- 其次，盡可能地使指定一致性層級的讀取仲裁僅由實行項目複本所組成。 除非必要，否則我們會避免為前端項目提供讀取。 在基于仲裁的系统中针对 Cosmos DB 支持的[五个一致性模型](consistency-levels.md)执行[负载和容量](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf)关系研究后，我们采用了多种思路。  

## <a name="partition-sets"></a>分割集

一组物理分区，其中的每个分区配置了 Cosmos 数据库区域，旨在管理跨所有已配置分区复制的相同键集。 这种更高的协调基元称为分区集 - 管理给定键集的物理分区的地理分布式动态叠加层。 给定的物理分区（副本集）限定在群集范围内，而分区集可跨群集、数据中心和地理区域，如下图所示：  

![分割集](./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png)

您可以將分割集想像為地理位置分散的「進階複本集」，其會由擁有相同索引鍵的多個複本集所組成。 類似於在複本集，資料分割集的成員資格也是動態 – 它波動根據新增/移除新的資料分割為指定的資料分割集之間的隱含的實體分割區管理作業 (例如，當您相應放大輸送量上容器，新增/移除的區域與 Cosmos 資料庫，或發生失敗時）。 由于（分区集的）每个分区可在其自身的副本集中管理分区集成员身份，因此，成员身份是完全分散且高度可用的。 重新設定分割集期間，也會建立在實體分割區之間重疊的拓撲。 该拓扑是根据源与目标物理分区之间的一致性级别、地理距离和可用网络带宽动态选择的。  

此服務可讓您使用單一寫入區域或多個寫入區域來設定 Cosmos 資料庫，並根據選項，將分割集設定為只接受一個或接受所有區域中的寫入。 系統採用兩個層級的巢狀共識通訊協定，一個層級會在接受寫入之實體分割區複本集的複本內運作，而另一個層級會在分割集的層級上運作，以針對分割集內所有認可的寫入提供完整的順序保證。 這個多層式巢狀共識是實作嚴格 SLA 以提供高可用性，以及實作 Cosmos DB 提供給其客戶之一致性模型的關鍵。  

## <a name="conflict-resolution"></a>衝突解決

我們對於更新傳播、衝突解決和因果追蹤的設計靈感來自先前在 [epidemic 演算法](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) \(英文\) 和 [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf) \(英文\) 系統上的工作。 儘管構想的核心已存留並提供方便參考的架構來與 Cosmos DB 系統設計溝通，但隨著我們將它們套用到 Cosmos DB 系統，它們也經歷了明顯的轉變。 之所以需要这样做，是因为以前的系统既没有设计资源调控，也不具备运行 Cosmos DB 所需的规模，无法提供 Cosmos DB 向其客户承诺的功能（例如有限过期一致性）和严格且全面的 SLA。  

回想一下，分割集會散發到多個區域，並遵循 Cosmos DB (多重主機) 複寫通訊協定，以便在組成指定分割集的實體分割區之間複寫資料。 每個實體分割區 (屬於分割集) 都會接受寫入，而且通常可為該區域的區域用戶端提供讀取。 區域內實體分割區所接受的寫入會被永久認可，並在將它們認可到用戶端之前，使其可在實體分割區內高度可用。 這些都是暫時性寫入，並會使用反熵通道傳播到分割集內的其他實體分割區。 用戶端可以藉由傳遞要求標頭來要求暫時性或認可的寫入。 反熵傳播 (包括傳播頻率) 是動態的，會以分割集的拓撲、實體分割區的區域性近接，以及所設定的一致性層級為根據。 在分割集內，Cosmos DB 會遵循主要的認可配置，其中具有動態選取的仲裁程式分割區。 選取仲裁程式是動態的，而且是根據重疊拓撲重新設定分割集時不可或缺的一部分。 保證會將認可的寫入 (包括多列/批次更新) 進行排序。 

我們採用已編碼的向量時鐘 (包含區域識別碼，以及分別對應到複本集和分割集上每個共識層級的邏輯時鐘)，以進行因果追蹤和版本向量來偵測及解決更新衝突。 拓撲和對等選取演算法旨在確保固定且最基本的儲存體，以及版本向量的最小網路額外負荷。 此演算法會保證嚴格的聚合屬性。  

針對使用多個寫入區域設定的 Cosmos 資料庫，系統提供許多彈性自動衝突解決原則，讓開發人員可從中選擇，包括： 

- **最后写入优先 (LWW)**：默认使用系统定义的时间戳属性（基于时间同步时钟协议）。 Cosmos DB 也可讓您指定任何其他自訂數值屬性以用來解決衝突。  
- **应用程序定义的自定义冲突解决策略**（通过合并过程表示）：旨在使用应用程序定义的语义来调解冲突。 在伺服器端偵測到資料庫交易的支援下有寫入-寫入衝突時，就會叫用這些程序。 在执行提交协议过程中，该系统可保证正好执行合并过程一次。 我们提供了[多个冲突解决方法示例](how-to-manage-conflicts.md)供你演练。  

## <a name="consistency-models"></a>一致性模型

不管为 Cosmos 数据库配置了一个还是多个写入区域，都可以从五个妥善定义的一致性模型中进行选择。 借助多个写入区域，一致性级别获得了以下明显改善：  

有限过期一致性可保证所有读取操作将保留在任意区域中最新写入操作的 *K* 前缀或 *T* 秒范围内。 此外，可保证具有有限过期一致性的读取操作是单调的，且附带一致前缀保证。 反熵通訊協定會以速率限制的方式運作，並確保前置詞不會累積，而且不必在寫入上套用背壓。 單調的工作階段一致性保證讀取、 單純寫入、 讀取您自己的寫入，寫入會遵循全球的讀取，且一致的前置詞保證。 对于配置了非常一致性的数据库，由于跨区域的同步复制，多个写入区域的优势（低写入延迟、高写入可用性）不适用。

[此处](consistency-levels.md)介绍了 Cosmos DB 中五个一致性模型的语义，[此处](https://github.com/Azure/azure-cosmos-tla)使用高级 TLA+ 规范对其数学原理做了描述。

## <a name="next-steps"></a>後續步驟

接下來，了解如何使用下列文章來設定全域散發：

* [在資料庫帳戶中新增/移除區域](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [如何設定多路連接的用戶端](how-to-manage-database-account.md#configure-multiple-write-regions)
* [如何创建自定义冲突解决策略](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
