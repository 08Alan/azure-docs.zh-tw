<properties
 pageTitle="Azure IoT 中心指引 | Microsoft Azure"
 description="使用 Azure IoT 中心之解決方案的指引主題集合。"
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="kevinmil"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="09/29/2015"
 ms.author="elioda"/>

# Azure IoT 中心 - 指引

## 比較：IoT 中心和事件中樞
Azure IoT 中心的主要使用案例之一是從裝置收集遙測。基於這個源因，IoT 中心常常拿來與[事件中樞]比較，事件中樞是事件處理服務，它能提供大規模進入雲端的事件和遙測入口，並具備低延遲和高可靠性等特性。

不過，這些服務有許多差異，將在以下章節詳述。

| 領域 | IoT 中心 | 事件中樞 |
| ---- | ------- | ---------- |
| 通訊模式 | 裝置到雲端事件輸入和雲端到裝置傳訊。 | 僅限於事件輸入 (通常視為裝置到雲端案例)。 |
| 安全性 | 每個裝置的身分識別與可撤銷的存取控制。請參閱 [IoT 中心開發人員指南 - 安全性]。 | 全事件中樞的[共用存取原則][Event Hub - security]，以及使用[發行者原則][Event Hub publisher policies]的有限撤銷支援。在 IoT 解決方案的內容中，通常需要實作自訂解決方案來支援每個裝置的認證以及防詐騙措施。 |
| 調整 | IoT 中心會最佳化以支援數百萬同時連接的裝置。 | 事件中樞可支援更多同時連接的限制數目：每個[服務匯流排配額]高達 5.000 AMQP 連接。另一方面，事件中樞可讓使用者指定每個傳送訊息的分割。 |
| 裝置 SDK | IoT 中心提供[裝置 SDK][Azure IoT Hub SDKs] 給各種平台和語言 | .NET、C 都支援事件中樞，且事件中樞提供 AMQP 和 HTTP 傳送介面。 |

總而言之，即使唯一的使用案例是裝置到雲端遙測輸入，IoT 中心仍會提供專為 IoT 裝置連線所設計的服務，並持續擴充具備 IoT 功能之案例的價值主張。事件中樞的設計對象是資料中心案例之間及其內部的大規模事件輸入。合併使用 IoT 中心和事件中樞的情況並不常見，除非前者處理裝置到雲端通訊，而後者處理後期事件輸入至及時處理引擎。

## 裝置佈建 <a id="provisioning"></a>
IoT 解決方案會在許多不同系統和存放區中維護裝置資訊，其中包括 [IoT 中心的身分識別登錄][IoT Hub Developer Guide - identity registry]，位於其他維護應用程式特定裝置資訊的儲存區中。我們將在所有系統中建立必要裝置資訊的程序稱為*佈建*。

裝置佈建有許多需求和策略 (如需詳細資訊，請參閱 [IoT 中心裝置管理指引])。[IoT 中心身分識別登錄][IoT Hub Developer Guide - identity registry]提供您在佈建程序中整合 IoT 中心所需的 API。

## 欄位閘道器 <a id="fieldgateways"></a>
欄位閘道器是特殊化的裝置-應用裝置，或做為通訊啟用器的一般用途軟體，甚至可能是本機裝置控制系統和裝置資料處理中心。欄位閘道器可以執行本機處理並控制針對裝置的函式。另一方面，它可以篩選或彙總裝置遙測，並藉此減少傳輸至後端的資料量。

欄位閘道器的範圍包括欄位閘道器本身以及連接到它的所有裝置。正如其名，閘道欄位器可做為外部專用的資料處理設備，且通常會和位置繫結。欄位閘道器和純粹流量路由器的不同之處在於，它在管理存取及資訊流量方面扮演主動的角色。這表示它是由應用程式處理的實體和網路連接或工作階段終點 (例如，在此內容中的閘道器可以協助裝置佈建、資料轉換、通訊協定轉譯和事件規則處理)。相對地，NAT 裝置或防火牆不會限定為欄位閘道器，因為它們並不是明確的連接或工作階段終點，而是路由 (或拒絕) 連接或工作階段經過之處。

### 透明 vs 不透明欄位閘道器
關於裝置身分識別，如果欄位閘道器範圍中的其他裝置在 IoT 中心的身分識別登錄中具有裝置身分識別時體，則該欄位閘道器可稱為*透明*。如果 IoT 中心的身分識別登錄中唯一的身分識別就是欄位閘道器的身分識別，則可稱為*不透明*。

請務必注意，使用*不透明*閘道器可防止 IoT 中心提供[裝置身分識別反詐騙][IoT Hub Developer Guide - Anti-spoofing]。此外，因為欄位閘道器範圍中的所有裝置都會表示為 IoT 中心內的單一裝置，它們將受限於單一裝置的節流與配額。

### 其他考量

實作欄位閘道器時，您可以使用 Azure IoT 裝置 SDK。某些 SDK 提供欄位閘道器特定功能，例如相同 IoT 中心連接上多工的多裝置通訊功能。如同 [IoT 中心開發人員指南 - 選擇通訊協定]中所述，您應該避免使用 HTTP/1 做為欄位閘道器的傳輸通訊協定。

## 使用自訂裝置驗證配置/服務。<a id="customauth"></a>
Azure IoT 中心可讓使用者透過使用[裝置身分識別登錄][IoT Hub Developer Guide - identity registry]設定每個裝置的安全性認證和存取控制。如果 IoT 解決方案已經大幅投資自訂裝置身分識別登錄及/或驗證配置，它仍然可以藉由建立 IoT 中心的*權杖服務*以利用其他 IoT 中心的功能。

權杖服務是自我部署的雲端服務，它會使用 IoT 中心共用存取原則與 **DeviceConnect** 權限來建立*裝置範圍*權杖。

  ![][img-tokenservice]

以下是權杖服務模式的主要步驟。

1. 建立 IoT 中心的 [IoT 中心共用存取原則][IoT Hub Developer Guide - Security] 與 **DeviceConnect** 權限。權杖服務將使用此原則簽署權杖。
2. 當裝置想要存取 IoT 中心時，它會向您的權杖服務要求已簽署的權杖。裝置可以使用您的自訂裝置身分識別登錄/驗證配置。
3. 權杖服務會傳回為每個 [IoT 中心開發人員指南 - 安全性]建立的權杖，使用 `/devices/{deviceId}` 做為 `resourceURI`，`deviceId` 做為進行驗證的裝置。
4. 裝置直接透過 IoT 中心使用權杖。

權杖服務可以視需要設定權杖到期日。到期時，IoT 中心將中斷連接，裝置必須向權杖服務要求新權杖。很明顯地，過短的到期時間會增加裝置與權杖服務的負載。

值得一提的是，若要讓裝置能夠連接，仍需要在 IoT 中心中建立裝置身分識別。這也表示即使裝置利用權杖驗證，每個裝置的存取控制仍會有功能 (藉由停用裝置身分識別做為每個 [IoT 中心開發人員指南 - 身分識別登錄])。如此可減少長期存在的權杖。

### 和自訂閘道器的比較
權杖服務模式為使用 IoT 中心實作自訂身分識別登錄/驗證配置的建議方式，因為它可讓 IoT 中心處理大部份的解決方案流量。不過在一些情況下，自訂驗證配置和通訊協定 (例如 [TLS-PSK]) 過度糾結，因此需要可處理所有流量 (*自訂閘道器*) 的服務。如需詳細資訊，請參閱[通訊協定閘道器]一文。

## 調整 IoT 中心
藉由將 IoT 中心 S1 或 S2 單位的數目增加至 2.000，IoT 中心最多可以同時支援一百萬個連接的裝置。如需詳細資訊，請參閱 [IoT 中心價格][lnk-pricing]。

每個 IoT 中心單位可在登錄中允許某數目的裝置身分識別，讓這些裝置可以同時連接，此外也允許一些每日訊息。

為了適當調整您的解決方案，您必須考慮 IoT 中心的特定使用方式。尤其要考慮以下類別的作業所需的尖峰輸送量：

* 裝置到雲端訊息
* 雲端到裝置訊息
* 身分識別登錄作業

除了此輸送量資訊，請記得參考 [IoT 中心配額與節流]並據其設計您的解決方案。

### 裝置到雲端及雲端到裝置訊息輸送量
若要評估每個裝置的流量，最佳方式為調整 IoT 中心解決方案的大小。

裝置到雲端訊息會遵循這些持續的輸送量指導方針。

| 層 | 持續的輸送量 | 持續的傳送速率 |
| ---- | -------------------- | ------------------- |
| S1 | 每個裝置最多 8 KB/小時 | 每個裝置平均 4 個訊息/小時 |
| S2 | 每個裝置最多 4 KB/分鐘 | 每個裝置平均 2 個訊息/分鐘 |

接收裝置到雲端訊息時，應用程式後端可以預期下列最大輸送量 (在所有的讀取器中)。

| 層 | 持續的輸送量 |
| ---- | -------------------- |
| S1 | 每個單位最多 120 KB/分鐘，最少 2 MB/秒。 |
| S2 | 每個單位最多 4 KB/分鐘，最少 2 MB/秒 |

雲端到裝置訊息的效能會隨每個裝置調整，每個裝置最多每分鐘接收 5 個訊息。

### 身分識別登錄作業輸送量
因為大部分的 IoT 中心識別登錄作業都與裝置佈建相關，所以不支援這些作業做為執行階段作業。如需特定高載效能數據，請參閱 [IoT 中心配額與節流]。

### 分區化
雖然單一 IoT 中心可以擴充到數百萬個裝置，但有時候您的解決方案需要單一 IoT 中心無法保證的特定效能特性。在此情況下，建議將您的裝置分割至多個 IoT 中心，才能順利應付流量高載，並取得所需的輸送量或必要的作業速率。

## 高可用性和災害復原
作為 Azure 服務，IoT 中心提供高可用性 (HA)，在 Azure 區域層級使用備援，且解決方案不需任何額外的工作。此外，Azure 會提供一些可協助建立解決方案的功能，必要時也提供災害復原 (DR) 功能或跨區域的可用性。若要提供全域、跨區域的高可用性給裝置或使用者，必須設計及準備解決方案以善用這些功能。[Azure 業務持續性技術指引]一文描述業務持續性和 DR 的 Azure 內建功能。[Azure 應用程式的災害復原與高可用性]一文針對 Azure 應用程式的策略提供架構指引以達到 HADR。

## 使用 IoT 中心的區域容錯移轉
IoT 解決方案中部署拓撲的完整處理已超出本節的範圍，但是為了高可用性和災害復原，我們要考慮*區域容錯移轉*部署模型。

在區域容錯移轉模型中，解決方案後端主要是在一個資料中心位置執行，但其他 IoT 中心和後端將會部署在其他資料中心區域以進行容錯移轉，以防主要資料中心中的 IoT 中心發生中斷，或者從裝置到主要資料中心的網路連線因某種理由而中斷。每當無法連接主要閘道器時，裝置會使用次要服務端點。使用跨區域容錯移轉功能時，可改善解決方案的可用性，勝過單一區域的高可用性。

在較高層級，為了使用 IoT 中心實作區域容錯移轉模型，您需要下列內容。

* **次要 IoT 中心和裝置路由邏輯** - 萬一主要區域的服務中斷，裝置必須開始與您的次要地區連接。由於大部分服務的情況都涉及在內，解決方案的系統管理員通常會觸發區域間的容錯移轉程序。要讓新端點與裝置通訊，同時保有程序的控制權，最佳方式是讓它們定期檢查*指引*服務是否有目前作用中的端點。這裡的指引服務可以是簡單的 web 應用程式，其可藉由使用 DNS 重新導向技術複寫並保持連接 (例如使用 [Azure 流量管理員])。
* **身分識別登錄複寫** - 為了成為可用狀態，次要 IoT 中心必須包含能夠連接到解決方案的所有裝置身分識別。解決方案應該保留裝置身分識別的異地複寫備份，並在切換裝置的作用中端點之前將其上傳至次要 IoT 中心。IoT 中心的裝置身分識別匯出功能在 [IoT 中心開發人員指南 - 身分識別登錄]的情況下非常實用。
* **合併邏輯** - 當主要區域再次可供使用時，所有在次要站台中建立的狀態和資料都必須移轉回主要區域。這大多與裝置身分識別和應用程式中繼資料相關，必須與主要 IoT 中心合併，也可能要與主要區域中的其他應用程式專屬存放區合併。若要簡化這個步驟，通常建議使用等冪作業。這樣可以將副作用降到最低，不只包括來自最終一致的事件分佈的副作用，也包括來自事件的重複項目或失序傳遞的副作用。此外，應用程式邏輯應該設計為能夠容忍潛在的不一致或「稍微」過期的狀態，原因包括系統需要額外的時間來「療癒」，以及根據復原點目標 (RPO)。下文提供有關此主題的詳細指引：[Failsafe：具有恢復功能之雲端架構的指引]。




[img-tokenservice]: media/iot-hub-guidance/tokenservice.png

[IoT Hub Developer Guide - identity registry]: iot-hub-devguide.md#identityregistry
[IoT 中心開發人員指南 - 身分識別登錄]: iot-hub-devguide.md#identityregistry
[IoT 中心開發人員指南 - 選擇通訊協定]: iot-hub-devguide.md#amqpvshttp
[IoT Hub Developer Guide - Security]: iot-hub-devguide.md#security
[IoT 中心開發人員指南 - 安全性]: iot-hub-devguide.md#security
[IoT Hub Developer Guide - Anti-spoofing]: iot-hub-devguide.md#antispoofing
[通訊協定閘道器]: iot-hub-protocol-gateway.md
[IoT 中心配額與節流]: iot-hub-devguide.md#throttling

[IoT 中心裝置管理指引]: iot-hub-device-management.md
[事件中樞]: ../event-hubs/event-hubs-what-is-event-hubs/
[Azure 流量管理員]: https://azure.microsoft.com/documentation/services/traffic-manager/
[Event Hub - security]: ../event-hubs/event-hubs-authentication-and-security-model-overview/
[Event Hub publisher policies]: ../event-hubs-overview/#common-publisher-tasks
[服務匯流排配額]: ../service-bus/service-bus-quotas/
[Azure IoT Hub SDKs]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md

[TLS-PSK]: https://tools.ietf.org/html/rfc4279

[Azure 業務持續性技術指引]: https://msdn.microsoft.com/library/azure/hh873027.aspx
[Azure 應用程式的災害復原與高可用性]: https://msdn.microsoft.com/library/azure/dn251004.aspx
[Failsafe：具有恢復功能之雲端架構的指引]: https://msdn.microsoft.com/library/azure/jj853352.aspx

[lnk-pricing]: https://azure.microsoft.com/pricing/details/iot-hub

<!---HONumber=Oct15_HO1-->