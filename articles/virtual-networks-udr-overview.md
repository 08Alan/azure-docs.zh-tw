<properties 
   pageTitle="使用者定義的路由和 IP 轉送概觀"
   description="使用者定義的路由 (UDR) 和 IP 轉送概觀"
   services="virtual-networks"
   documentationCenter="na"
   authors="telmosampaio"
   manager="adinah"
   editor="tysonn" />

 <tags 
   ms.service="virtual-networks"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/22/2015"
   ms.author="telmos" />

# 使用者定義的路由和 IP 轉送
Azure 使用路由表決定如何根據每個封包的目的地轉送 IP 流量。雖然 Azure 根據您的虛擬網路設定提供預設路由表，但是您可能需要將自訂的路由新增至該路由表。路由表中最常見的自訂項目需求是在 Azure 環境中使用虛擬應用裝置。請將下圖所示的情況列入考量。假設您想要確保導向至中介層的所有流量，以及從前端子網路起始的備份子網路會通過虛擬防火牆應用裝置。如果只將應用裝置新增至您的虛擬網路，並將其連接到不同的子網路，並不會提供這項功能。您也必須變更套用至您子網路的路由表，以確保封包轉送到虛擬防火牆應用裝置。

如果您在 Azure 虛擬網路與網際網路之間實作虛擬 NAT 應用裝置以控制流量，也會達到相同的效果。為確保使用虛擬應用裝置，您必須建立一個路由，指定指向網際網路的所有流量都必須轉送到虛擬應用裝置。

## 路由
根據在實體網路上的每個節點定義的路由表，封包是透過 TCP/IP 網路路由傳送。路由表是個別路由的集合，用於決定根據目的地 IP 位址，在何處轉送封包。路由是由下列項目所組成：

- **位址前置詞**：路由所套用的目的地 CIDR，例如 10.1.0.0/16。
- **下一個躍點類型**：要接收封包的 Azure 躍點的類型。可能的值包括：
	- **本機**：代表本機虛擬網路。例如，如果您在相同的虛擬網路中有兩個子網路 \(分別是 10.1.0.0/16 和 10.2.0.0/16\)，路由表中每個子網路的路由的下一個躍點值為 \[本機\]**。
	- **VPN 閘道**：代表 Azure S2S VPN 閘道。 
	- **網際網路**：代表 Azure 基礎結構所提供的預設網際網路閘道 
	- **虛擬應用裝置**：代表您新增至 Azure 虛擬網路的虛擬應用裝置。
	- **NULL**：代表黑洞。轉送至黑洞的封包將完全不會被轉送。
- **Nexthop 值**：下一個躍點值包含應該要將封包轉送到哪個 IP 位址。只有在下一個躍點類型為*虛擬應用裝置*所在的路由中，才允許下一個躍點值。

## 預設路由
在虛擬網路中建立的每個子網路都會自動與包含下列預設路由規則的路由表產生關聯：- **本機 Vnet 規則**：此規則會針對虛擬網路中的每個子網路自動建立。它會指定在 VNet 中的 VM 之間有直接連結，而且沒有中繼的下一個躍點。- **內部部署規則**：此規則會套用至指向內部部署位址範圍的所有流量，並使用 VPN 閘道做為下一個躍點目的地。- **網際網路規則**：此規則會處理指向公用網際網路的所有流量，並使用基礎結構網際網路閘道做為指向網際網路的所有流量的下一個躍點。

## BGP 路由
如果您在內部部署網路與 Azure 之間有 ExpressRoute 連線，可以啟用 BGP，將路由從內部部署網路傳播至 Azure。這些 BGP 路由的使用方式與預設路由相同，也與每個 Azure 子網路中的使用者定義路由相同。如需詳細資訊，請參閱 [ExpressRoute 簡介](../expressroute-introduction)。

[AZURE.IMPORTANT]您可以設定 Azure 環境透過內部部署網路使用強制通道，方法是，為使用 VPN 閘道做為下一個躍點的子網路 0.0.0.0/0 建立使用者定義的路由。不過，這只有在您使用的是 VPN 閘道，而不是 ExpressRoute 時，才有作用。若是 Expressroute，強制通道是透過 BGP 設定。

## 使用者定義的路由
您無法檢視以上在 Azure 環境中指定的預設路由，而且對於大部分的環境而言，這些是您將需要的唯一路由。不過，您可能需要在特定情況下建立路由表，並新增一個或多個路由，例如：

- 透過內部部署網路到網際網路的強制通道。
- 在 Azure 環境中使用虛擬應用裝置。
- 
在上述情況下，您必須建立一個路由表，並將使用者定義的路由新增到該路由表。您可以擁有多個路由表，而且相同的路由表可以與一個或多個子網路產生關聯。此外，每個子網路只能與單一路由資料表產生關聯。子網路中的所有 VM 和雲端服務都使用與該子網路相關聯的路由表。

子網路會依賴預設路由，直到路由表與子網路產生關聯為止。一旦關聯存在之後，在使用者定義的路由和預設路由路由之間，就會根據最長前置詞比對 \(LPM\) 完成。如果有多個符合相同 LPM 的路由，則會根據其來源，以下列順序選取路由：

1. 使用者定義的路由
1. BGP 路由 \(使用 ExpressRoute 時\)
1. 預設路由

[AZURE.IMPORTANT]使用者定義的路由僅會套用至 Azure VM 和雲端服務。例如，如果您想要在內部部署網路與 Azure 之間新增防火牆虛擬應用裝置，您必須為您的 Azure 路由表建立一個使用者定義的路由，此路由會將前往內部部署位址空間的所有流量轉送到虛擬應用裝置。不過，來自內部部署位址空間的連入流量將會流經您的 VPN 閘道或直接到 Azure 環境的 ExpressRoute 電路，略過虛擬應用裝置。

## IP 轉送
如上所述，建立使用者定義的路由的主要原因之一是將流量轉送到虛擬應用裝置。虛擬應用裝置無非就是一個 VM，可執行用來以某種方式處理網路流量的應用程式，例如防火牆或 NAT 裝置。

此虛擬應用裝置 VM 必須能夠接收未定址到本身的連入流量。若要讓 VM 接收定址到其他目的地的流量，您必須在 VM 中啟用 IP 轉送。

## 另請參閱

[如何在 Azure 中建立路由並啟用 IP 轉送](../virtual-networks-udr-how-to)

[執行個體層級公用 IP \(ILIP\)](../virtual-networks-instance-level-public-ip)

[虛擬網路概觀](https://msdn.microsoft.com/library/azure/jj156007.aspx)

<!--HONumber=52-->
