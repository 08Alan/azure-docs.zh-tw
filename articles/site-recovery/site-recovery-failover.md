---
title: "Site Recovery 中的容錯移轉 | Microsoft Docs"
description: "Azure Site Recovery 可協調虛擬機器和實體伺服器的複寫、容錯移轉及復原作業。 了解如何容錯移轉到 Azure 或次要資料中心。"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 1/04/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: b70d2d709d0940964c4220b798207adaf3551d36
ms.openlocfilehash: d31e987e636b178b5aa05722ff08707a6e53c3cf


---
# <a name="failover-in-site-recovery"></a>Site Recovery 中的容錯移轉
Azure Site Recovery 服務可藉由協調虛擬機器與實體伺服器的複寫、容錯移轉及復原 (BCDR) 策略，為您的商務持續性與災害復原做出貢獻。 機器可以複寫至 Azure，或次要的內部部署資料中心。 如需快速概觀，請參閱 [什麼是 Azure Site Recovery？](site-recovery-overview.md)

## <a name="overview"></a>概觀
本文提供復原 (容錯移轉和容錯回復) 使用 Site Recovery 保護的虛擬機器與實體伺服器的相關資訊和指示。

在這篇文章下方或 [Azure 復原服務論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)中張貼意見或問題。

## <a name="types-of-failover"></a>容錯移轉的類型
針對虛擬機器和實體伺服器啟用保護並進行複寫之後，您就可以視需要執行容錯移轉。 Site Recovery 支援數種類型的容錯移轉。

| **容錯移轉** | **執行的時機** | **詳細資料** | **處理程序** |
| --- | --- | --- | --- |
| **測試容錯移轉** |執行以驗證您的複寫策略，或執行災害復原訓練 |沒有資料遺失或停機時間。<br/><br/>不會影響複寫<br/><br/>不會影響生產環境 |開始容錯移轉<br/><br/>指定測試機器在容錯移轉後連線到網路的方式<br/><br/>在 [作業] 索引標籤上追蹤進度。 建立測試機器並在次要位置啟動<br/><br/>Azure - 在 Azure 入口網站中連線到機器<br/><br/>次要站台 - 在相同的主機和雲端上存取機器<br/><br/>完成測試並自動清除測試容錯移轉設定。 |
| **計劃性容錯移轉** |執行以符合法規需求<br/><br/>執行預定進行的維修作業<br/><br/>執行以容錯移轉資料來針對已知的中斷 (例如預期的電源失敗或嚴重氣象報告) 保持工作負載持續執行<br/><br/>在從主要位置移轉到次要位置後執行以進行容錯回復 |沒有資料遺失<br/><br/>停機是從在主要位置關閉虛擬機器開始算起，直到在次要位置將虛擬機器重新啟動所花費的時間。<br/><br/>虛擬機器會在目標機器於容錯移轉後成為來源機器時受到影響。 |開始容錯移轉<br/><br/>在 [作業] 索引標籤上追蹤進度。 來源電腦均已關閉<br/><br/>複本機器是從次要位置開始<br/><br/>Azure - 在 Azure 入口網站中連線到複本機器<br/><br/>次要站台 - 在相同的主機和相同的雲端上存取機器<br/><br/>認可容錯移轉 |
| **非計劃性容錯移轉** |當主要站台因為發生非預期的事件 (例如，停電或病毒攻擊) 而變成無法存取時，以反應的方式執行這種類型的容錯移轉 <br/><br/> 您可以執行非計劃性容錯移轉，即使主要站台無法使用，還是可以完成。 |資料遺失取決於複寫頻率設定<br/><br/>資料將根據其最後一次同步處理的時間保持最新狀態 |開始容錯移轉<br/><br/>在 [作業] 索引標籤上追蹤進度。 選擇性地嘗試關閉虛擬機器並同步處理最新資料<br/><br/>複本機器是從次要位置開始<br/><br/>Azure - 在 Azure 入口網站中連線到複本機器<br/><br/>次要站台在相同的主機和相同的雲端上存取機器<br/><br/>認可容錯移轉 |

支援的容錯移轉類型取決於您的部署案例。

| **容錯移轉方向** | **測試容錯移轉** | **計劃性容錯移轉** | **非計劃性容錯移轉** |
| --- | --- | --- | --- |
| 從主要 VMM 站台到次要 VMM 站台 |支援 |支援 |支援 |
| 從次要 VMM 站台到主要 VMM 站台 |支援 |支援 |支援 |
| 雲端到雲端 (單一 VMM 伺服器) |支援 |支援 |支援 |
| 從 VMM 站台到 Azure |支援 |支援 |支援 |
| 從 Azure 到 VMM 站台 |不支援 |支援 |不支援 |
| 從 Hyper-V 站台到 Azure |支援 |支援 |支援 |
| 從 Azure 到 Hyper-V 站台 |不支援 |支援 |不支援 |
| 從 VMware 站台到 Azure |支援 (增強版案例)<br/><br/> 不支援 (舊版案例) |不支援 |支援 |
| 從實體伺服器到 Azure |支援 (增強版案例)<br/><br/> 不支援 (舊版案例) |不支援 |支援 |

## <a name="failover-and-failback"></a>容錯移轉和容錯回復
根據您的部署而定，您可以將虛擬機器容錯移轉到次要的內部部署站台或 Azure。 容錯移轉到 Azure 的機器會建立來做為 Azure 虛擬機器。 您可以容錯移轉單一虛擬機器或實體伺服器，或是復原方案。 復原方案包含一或多個排序的群組，其中含有受保護的虛擬機器或實體伺服器。 它們可用來協調多部機器的容錯移轉，這類機器會根據它們所屬的群組來進行容錯移轉。 [閱讀更多](site-recovery-create-recovery-plans.md) 復原方案的相關資訊。

當容錯移轉完成且您的機器已在次要位置啟動並執行之後，請注意：

* 如果您已容錯移轉到 Azure，則在容錯移轉之後，系統將不會保護或複寫主要或次要位置中的機器。 在 Azure 中，虛擬機器是儲存於異地複寫儲存體中，其可提供彈性，但不會複寫。
* 如果您進行非計劃性容錯移轉到次要站台，則在容錯移轉之後，將不會保護或複寫次要位置中的機器。
* 如果您進行計劃性容錯移轉到次要站台，則在容錯移轉之後，將會保護或複寫次要位置中的機器。

### <a name="failback-from-secondary-site"></a>從次要站台進行容錯回復
從次要站台容錯回復到主要站台所使用的程序，與從主要站台容錯移轉到次要站台的程序相同。 認可並完成從主要站台容錯移轉到次要資料中心之後，您就能在主要站台成為可用時，起始反向複寫。 反向複寫會藉由同步處理差異資料，來起始次要站台和主要站台之間的複寫。 反向複寫會讓虛擬機器進入受保護的狀態，但是次要資料中心仍是使用中位置。 為了讓主要站台成為使用中位置，您可以起始從次要位置到主要位置的計劃性容錯移轉，後面接著另一個反向複寫。

### <a name="failback-from-azure"></a>從 Azure 容錯回復
如果您已容錯移轉到 Azure，虛擬機器就會受到虛擬機器的 Azure 復原功能所保護。 若要使原始的主要站台變成使用中位置，您可以執行計劃性容錯移轉。 您可以容錯回復到原始位置，或者，如果您的原始站台無法使用，則可回復到其他位置。 若要在容錯回復到主要位置後再次啟動複寫，您可以起始反向複寫。

### <a name="failover-considerations"></a>容錯移轉考量
* **容錯移轉之後的 IP 位址**- 根據預設，已容錯移轉的機器 IP 位址會與來源電腦的 IP 位址不同。 如果您想要保留同一個 IP 位址，請參閱：
  * **次要站台**- 如果您要容錯移轉到次要站台且想要保留 IP 位址，請 [閱讀](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx) 這篇文章。 請注意，如果您的 ISP 支援公用 IP 位址，則您可以保留它。
  * **Azure** - 如果您要容錯移轉到 Azure，您可以指定要在虛擬機器屬性的 [設定] 索引標籤中指派的 IP 位址 。 您無法在容錯移轉到 Azure 後保留公用 IP 位址。 您可以保留非 RFC 1918 位址空間來做為內部位址。
* **部分容錯移轉**- 如果您想要容錯移轉部分站台，而非整個站台，請注意：

  * **次要站台**- 如果您將部分的主要站台容錯移轉到次要站台，且想要連回主要站台，請使用站台對站台 VPN 連線，將次要站台上已容錯移轉的應用程式連接到在主要站台上執行的基礎結構元件。 如果整個子網路都會進行容錯移轉，您就能保留虛擬機器的 IP 位址。 如果您容錯移轉部分子網路，就無法保留虛擬機器的 IP 位址，因為無法在站台間分割子網路。
  * **Azure**- 如果您將部分站台容錯移轉到 Azure，且想要連回主要站台，您可以使用站台對站台 VPN，將 Azure 中已容錯移轉的應用程式連接到在主要站台上執行的基礎結構元件。 請注意，如果整個子網路都會進行容錯移轉，您就能保留虛擬機器的 IP 位址。 如果您容錯移轉部分子網路，就無法保留虛擬機器的 IP 位址，因為無法在站台間分割子網路。
* **磁碟機代號** - 如果想要在容錯移轉後保留虛擬機器上的磁碟機代號，您可以將虛擬機器的 SAN 原則設定為 [開啟]。 虛擬機器磁碟會自動上線。 [閱讀更多資訊](https://technet.microsoft.com/library/gg252636.aspx)。
* **路由傳送用戶端要求**- Site Recovery 可搭配 Azure 流量管理員使用，在容錯移轉之後，將用戶端要求路由傳送到您的應用程式。

## <a name="run-a-test-failover"></a>執行測試容錯移轉
如果您要執行測試容錯移轉來移轉至 Azure，請參閱[移轉至 Azure 的測試容錯移轉](site-recovery-test-failover-to-azure.md)文件。 如果您要執行測試容錯移轉來移轉至由「VMM 伺服器」管理的另一個內部部署站台，請參閱[移轉至 VMM 的測試容錯移轉](site-recovery-test-failover-vmm-to-vmm.md)文件。  

## <a name="run-a-planned-failover-primary-to-secondary"></a>執行計劃性容錯移轉 (主要到次要)
 此程序說明如何針對復原方案執行計劃性容錯移轉。 或者，您可以在 [虛擬機器]  索引標籤上針對單一虛擬機器執行容錯移轉。

1. 開始之前，請確定您想要容錯移轉的所有虛擬機器已都完成初始複寫。
2. 選取 [復原方案]  >  *recoveryplan_name*。 按一下 [容錯移轉] **容錯移轉** > **Planned 容錯移轉**中張貼意見或問題。
3. 在 [確認計劃性容錯移轉] 頁面上，選擇來源與目標位置。 記下容錯移轉方向。

   * 如果先前的容錯移轉已如預期般運作，而且所有虛擬機器伺服器都位於來源或目標位置上，則容錯移轉方向詳細資料僅供參考。
   * 如果虛擬機器在來源和目標位置上均為使用中狀態，即會顯示 [變更方向]  按鈕。 使用此按鈕，來變更及指定應進行容錯移轉的方向。
4. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰]  中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
5. 開始計劃性容錯移轉的第一個步驟是關閉虛擬機器，以確保資料不會遺失。 您可以在 [工作]  索引標籤上追蹤容錯移轉進度。 如果容錯移轉中發生錯誤 (無論是在虛擬機器上或在復原方案中包含的指令碼中)，復原方案的計劃性容錯移轉即會停止。 您可以再次起始容錯移轉。
6. 建立複本虛擬機器之後，它們即會處於認可擱置中的狀態。 按一下 [認可]  以認可容錯移轉。
7. 完成複寫之後，即會在次要位置上啟動虛擬機器。

## <a name="run-an-unplanned-failover"></a>執行非計劃性容錯移轉
此程序說明如何針對復原方案執行非計劃性容錯移轉。 或者，您可以在 [虛擬機器]  索引標籤上，針對單一虛擬機器或實體伺服器執行容錯移轉。

1. 選取 [復原方案]  >  *recoveryplan_name*。 按一下 [容錯移轉] **容錯移轉** > **Unplanned 容錯移轉**中張貼意見或問題。
2. 在 [確認非計劃性容錯移轉] 頁面上，選擇來源與目標位置。 記下容錯移轉方向。

   * 如果先前的容錯移轉已如預期般運作，而且所有虛擬機器伺服器都位於來源或目標位置上，則容錯移轉方向詳細資料僅供參考。
   * 如果虛擬機器在來源和目標位置上均為使用中狀態，即會顯示 [變更方向]  按鈕。 使用此按鈕，來變更及指定應進行容錯移轉的方向。
3. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰]  中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
4. 選取 [關閉虛擬機器並同步處理最新資料]  ，來指定 Site Recovery 應嘗試關閉受保護的虛擬機器並同步處理資料，以便為最新的資料版本進行容錯移轉。 如果您未選取此選項或嘗試失敗，容錯移轉將會來自虛擬機器的最新可用復原點。
5. 您可以在 [工作]  索引標籤上追蹤容錯移轉進度。 請注意，即使在非計劃性容錯移轉期間發生錯誤，復原方案還是會執行，直到它完成為止。
6. 容錯移轉之後，虛擬機器就會處於 [認可擱置中]  狀態。 按一下 [認可]  以認可容錯移轉。
7. 如果您設定複寫以使用多個復原點，則可在 [變更復原點] 中選擇使用不是最新的復原點 (預設會使用最新的復原點)。 當您認可之後，將移除其他復原點。
8. 完成複寫之後，虛擬機器即會在次要位置上啟動並執行。 不過，它們不會受到保護或進行複寫。 再次使用相同的基礎結構來使用主要站台時，請按一下 [反向複寫]  ，開始進行反向複寫。 這可確保所有資料都會複寫回到主要站台，而且虛擬機器已準備好再次進行容錯移轉。 非計劃性容錯移轉之後的反向複寫會導致在資料傳輸中產生額外負荷。 傳輸所使用的方式與針對適用於雲端之初始複寫設定所設定的方法相同。

## <a name="failback-from-secondary-to-primary"></a>從次要位置容錯回復到主要位置
 從主要位置容錯移轉到次要位置之後，複寫的虛擬機器就不會受到 Site Recovery 所保護，而次要位置現在會成為主要位置。 請遵循這些程序，以容錯回復到原始的主要站台。 此程序說明如何針對復原方案執行計劃性容錯移轉。 或者，您可以在 [虛擬機器]  索引標籤上針對單一虛擬機器執行容錯移轉。

1. 選取 [復原方案]  >  *recoveryplan_name*。 按一下 [容錯移轉] **容錯移轉** > **Planned 容錯移轉**中張貼意見或問題。
2. 在 [確認計劃性容錯移轉] 頁面上，選擇來源與目標位置。 記下容錯移轉方向。 如果來自主要位置的容錯移轉會如預期般運作，且所有虛擬機器均位於次要位置，則這僅供參考。
3. 如果您正從 Azure 進行容錯回復，請選取 [資料同步處理] 中的設定：

   * **在容錯移轉前同步處理資料 (僅同步處理差異變更)**—這個選項可將虛擬機器的停機時間縮到最短，因為不需關閉虛擬機器即可進行同步處理。 它具有下列功能：
     * 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。 機器會繼續在 Azure 中執行。
     * 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。 最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。

    - **僅在容錯移轉期間同步處理資料 (完整下載)**—如果您已經在 Azure 上長時間執行，請使用這個選項。 這個選項速度比較快，因為我們預期大部分的磁碟已經變更，而且我們不想花時間計算總和檢查碼。 它會下載磁碟。 當內部部署虛擬機器已遭刪除時，它也很有用。

    > [!NOTE] 
    > 如果您已經執行 Azure 一段時間 (一個月以上) 或已刪除內部部署 VM，則建議您使用這個選項。這個選項不會執行任何總和檢查碼計算。
    >
    >


1. 如果您正在容錯移轉到 Azure 且已針對雲端啟用資料加密，請在 [加密金鑰]  中，選取當您在提供者安裝期間於 VMM 伺服器上啟用資料加密時所發出的憑證。
2. 預設會使用最新的復原點，但您可以在 [變更復原點]  中指定不同的復原點。
3. 按一下勾號以開始容錯回復。  您可以在 [工作]  索引標籤上追蹤容錯移轉進度。
4. 如果您選取要在容錯移轉前同步處理資料的選項，則在完成初始資料同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業]  > <planned failover job name>中張貼意見或問題。 這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。
5. 您現在可以登入虛擬機器，來驗證它是否會如預期般出現。
6. 虛擬機器目前處於認可擱置中的狀態。 按一下 [認可]  以認可容錯移轉。
7. 現在為了完成容錯回復，請按一下 [反向複寫]  ，開始保護主要站台中的虛擬機器。

## <a name="failback-to-an-alternate-location"></a>容錯回復到其他位置
如果您已經在 [HYPER-V 站台和 Azure](site-recovery-hyper-v-site-to-azure.md) 之間部署保護，就能夠從 Azure 容錯回復到替代的內部部署位置。 如果您需要設定新的內部部署硬體，這相當實用。 以下是執行此動作的方式。

1. 如果您正在設定新硬體，請在伺服器上安裝 Windows Server 2012 R2 和 Hyper-V 角色。
2. 使用您在原始伺服器上所擁有的相同名稱來建立虛擬網路交換器。
3. 選取 [受保護的項目]  ->  [保護群組]  ->  <ProtectionGroupName>  ->  您想要進行容錯回復的 <VirtualMachineName>，然後選取 [計畫性容錯移轉]。
4. 在 [記事]  select 中張貼意見或問題。
5. 在 [主機名稱]  中，選取要放置虛擬機器的新 Hyper-V 主機伺服器。
6. 在 [資料同步處理] 中，建議您選取 [容錯移轉之前同步處理資料] 的選項。 這個選項可以將虛擬機器的停機時間降至最低，因為不需關閉虛擬機器即可進行同步處理。 它具有下列功能：

   * 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。 機器會繼續在 Azure 中執行。
   * 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。 最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。
7. 按一下勾號以開始容錯移轉 (容錯回復)。
8. 在完成初始同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業]  > <planned failover job> > 中張貼意見或問題。 這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。
9. 您可以登入內部部署虛擬機器，確認一切均可正常運作。 然後按一下 [認可]  以完成容錯移轉。
10. 按一下 [反向複寫]  ，開始保護內部部署虛擬機器。

    > [!NOTE]
    > 如果您在資料同步處理步驟中取消容錯回復作業，內部部署 VM 會進入損毀狀態。 這是因為資料同步處理會將 Azure VM 磁碟中最新的資料複製到內部部署資料磁碟，而在同步處理完成之前，資料可能會處於不一致狀態。 如果內部部署 VM 在取消資料同步處理後開機，則可能無法開機。 重新觸發容錯移轉以完成資料同步處理。
    >
    >



<!--HONumber=Jan17_HO2-->


