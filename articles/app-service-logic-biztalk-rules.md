<properties 
   pageTitle="BizTalk 規則" 
   description="本主題涵蓋 BizTalk 規則的功能，並提供其使用方式的指示" 
   services="app-service\logic" 
   documentationCenter=".net,nodejs,java" 
   authors="anuragdalmia" 
   manager="dwrede" 
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration" 
   ms.date="02/27/2015"
   ms.author="andalmia"/>

# BizTalk 規則 

商務規則會封裝可控制商務程序的原則和決策。這些原則可能會正式定義於程序手冊、合約或協議中，也可能以員工具備的知識或專業技術存在。這些原則是動態的，而且會因為商務計劃、法規變更或其他原因而變更。

在傳統程式設計語言中實作這些原則需要相當的時間和協調，而且無法讓非程式設計人員參與商務原則的建立和維護。BizTalk 商務規則提供快速實作這些原則及分離商務程序的其餘部分的方式。如此即可對商務原則進行必要的變更，而不會影響商務程序的其餘部分。

## 為何使用規則

在商務程序中使用 BizTalk 商務規則的主要原因有 3 個：

* 將商務邏輯從應用程式程式碼中分離
- 讓商務分析師更充分掌控商務邏輯管理
+ 更快實際執行商務邏輯變更

# 規則概念

## 詞彙

用來定義規則條件和動作的字彙通常會以網域或業界特有術語來表示。例如，電子郵件使用者會根據訊息「接收自」和訊息「接收之後」撰寫規則，而保險商業分析師則根據「風險因素」與「保險金額」撰寫規則。
此網域特定術語的基礎是可實作規則條件和規則動作的技術成品 (物件、資料庫資料表和 XML 文件)。詞彙已設計用來銜接商業語意與實作之間的差距。

例如，核准狀態的資料繫結可能指向某個資料庫中特定資料列中的特定資料行 (以 SQL 查詢表示)。不需在規則中插入這類的複雜表示法，您可能會改為使用易記名稱「狀態」建立詞彙定義 (與該資料繫結相關聯)。接下來，您可以在任何數目的規則中包含「狀態」，而規則引擎可以從資料表擷取對應的資料。
_Vocabulary_ 是定義集合，由在規則條件和動作中使用的運算物件的易記名稱所組成。詞彙定義讓規則更易於閱讀、瞭解，並由特定商務網域中的人員共用。

## 規則

商務規則是控管商務程序進行的宣告式陳述式。規則是由條件與動作所組成。條件會進行評估，而如果評估為 true，規則引擎就會起始一或多個動作。
使用下列格式可以定義商務規則架構中的規則：

_IF_ _condition_ _THEN_ _action_

請考量下列範例：

*IF amount is less than or equal to available funds*  
*THEN conduct transaction and print receipt*

此規則會判斷是否要藉由套用商務邏輯 (以比較兩個貨幣值的形式、以比較交易金額與可用資金的形式) 來進行交易。
您可以使用商務規則來建立、修改和部署商務規則。或者，您可以透過程式設計方式執行前面的工作。

### 條件

條件是 true/false (布林) 運算式，其中包含一或多個述詞。
在我們的範例中，述詞 less than 或 equal to 會套用至金額與可用資金。這個條件一律會評估為 true 或 false。
述詞可以結合邏輯運算子 AND、OR 和 NOT，以形成可能相當大的邏輯運算式，但一律會評估為 true 或 false。

### 動作

動作是條件評估的功能結果。如果符合規則條件，便會起始對應的動作。
在我們的範例中，"conduct transaction" 及 "print receipt" 是只會在條件為 true (在此情況下，"IF amount is less than or equal to available funds") 時執行的動作。
動作是藉由在 XML 文件上執行設定作業來重現在商務規則架構中。

## 原則

原則是規則的邏輯群組。您可撰寫原則、加以儲存、測試，而當您滿意結果時，則可在實際執行環境中加以使用。

### 原則撰寫

您可以在原則入口網站中撰寫規則。原則可以包含任意大組規則，但您通常會根據屬於將使用此原則的應用程式環境中特定商務網域的規則來撰寫規則。

### 測試原則
您可以先有效地執行一回合的原則測試，再將原則使用於實際執行環境。規則入口網站可讓您提供原則的輸入、執行原則，以及檢視其輸出。輸出包括記錄檔、規則執行、條件評估及結果產生的輸出。

## 範例案例 - 保險理賠
讓我們採用範例案例，並在我們撰寫相同商務邏輯的同時逐步說明此案例。

![Alt text][1]

在非常簡單的保險理賠案例中，Claimant 送出他的保險理賠 (透過諸如網站、電話應用程式等任何用戶端)。此理賠要求會傳送至企業的理賠處理單位，而根據處理的結果，理賠可以處於「 已核准」、「已拒絕」狀態或送出進一步手動處理。
我們案例中的理賠處理單位會是包含系統商務邏輯的單位。仔細看一下這個單位，我們可以看到下列項目：

![Alt text][2]
 
讓我們現在使用商務規則來實作此商務邏輯。


## 建立規則 API 應用程式


1. 登入 Azure 入口網站並到達首頁。 
1. 按一下 [新增] -> [Azure Marketplace] -> [API 應用程式] -> [BizTalk 規則] -> [建立]
![Alt text][3]
1. 在開啟的新刀鋒視窗中，輸入下列資訊：  
	1. 名稱 - 提供規則 API 應用程式的名稱
	1. 應用程式主控方案 - 選取或建立 Web 主控方案
	1. 定價層 - 選擇您希望此應用程式所屬的定價層
	1. 資源群組 - 選取或建立應用程式所屬的資源群組
	1. 位置 - 選擇您要部署應用程式的地理位置。
4.	按一下 [建立]。在幾分鐘內，就會建立 BizTalk 規則 API 應用程式。

## 建立詞彙
建立 BizTalk 規則 API 應用程式之後, 下一個步驟就是建立詞彙。期望就是開發人員是進行此練習的較常見人物。若要達到此目的，請遵循下列步驟： 


1. 透過 [瀏覽] -> [API 應用程式] -> [<您的規則 API 應用程式>]，瀏覽至建立的 API 應用程式。這應該會使您到達如下的規則 API 應用程式儀表板：
 
   ![Alt text][4]

2. 接著 按一下 [詞彙定義]。這會顯示 [詞彙撰寫畫面]。按一下 [新增]，開始加入新的詞彙定義。
目前支援的詞彙定義有兩種 - 常值和 XML。

## 常值定義
1.	按一下 [新增] 之後，新的 [新增定義] 刀鋒視窗隨即開啟。輸入下列值
  1.	名稱 - 預期只有英數字元 (沒有任何特殊字元)。對您現有的詞彙定義清單而言，這也應該是唯一的。
  2.	描述 - 選擇性欄位。
  3.	類型 - 支援的類型有兩種。在此範例中選擇常值
  4.	輸入類型 - 這可讓使用者選取定義的資料類型。目前可選取 4 種資料類型：
    i.	字串 - 這些值必須輸入在雙引號中 ("範例字串")  
    ii.	布林值 - 這可以是 true 或 false  
    iii.	數字 - 可以是任何十進位數字  
    iv.	日期時間 - 這表示定義為日期類型。必須使用此格式輸入資料 - mm/dd/yyyy hh:mm:ss AM\PM  
    v.	輸入 - 這是您輸入定義值的位置。在此輸入的值必須符合所選的資料類型。使用者可以輸入一個值、一組以逗號分隔的值，或使用關鍵字的某個範圍的值。例如，使用者可以輸入唯一的值 1、一組 1、2、3，或範圍 1 到 5。請注意，只有數字支援範圍。

![Alt text][5]
## XML 定義
如果選擇的詞彙類型為 XML，必須指定下列輸入  
  a.	結構描述 - 按一下此項就會開啟新的刀鋒視窗，允許使用者從已上傳的結構描述清單進行選擇，或允許上傳新的清單。   
  b.	XPATH - 只有在上一個步驟中選擇結構描述之後，此輸入才會解除鎖定。按一下此項將顯示已選取的結構描述，並允許使用者選取需要建立詞彙定義的節點。  
  c.	FACT - 此輸入可識別哪個資料物件會送至規則引擎進行處理。這是進階屬性，依預設會設定為所選 XPATH 的父代。對鏈結和集合案例而言，FACT 會變得特別重要。

![Alt text][6]

### 大量新增
上述步驟已擷取建立詞彙定義的經驗。一旦建立，所建立的詞彙定義就會出現在清單表單中。必須能夠從相同的結構描述產生多個定義，而不是每一次都重複上述的步驟。因此，「大量新增」功能就很有用。 
按一下  [大量新增] 將會前往新的刀鋒視窗。第一個步驟是選取要建立多個定義的結構描述。按一下此項就會開啟新的刀鋒視窗，允許使用者從已上傳的結構描述清單進行選擇，或允許上傳新的清單。
現在會鎖定 XPATH 屬性。按一下此項將會開啟 [結構描述檢視器]，以便選取多個節點。
建立之多個定義的名稱將會預設為選取之節點的名稱。這些屬性一律會在建立後修改。

![Alt text][7]

## 建立原則
一旦開發人員建立所需的詞彙，預期就是商務分析師會是透過 Azure 入口網站建立商務原則的人。  
	1.	建立的規則應用程式上有一個原則濾鏡，按一下該濾鏡使用者將會進入原則建立頁面。  
	2.	此頁面會顯示此特定規則應用程式具有的原則清單。只需輸入原則名稱並按 Tab 鍵，使用者即可加入新的原則。單一規則 API 應用程式中可以有多個原則。  
	3.	按一下所建立的原則，將會讓使用者進入 [原則詳細資料] 頁面，以便查看原則中的規則。  
	![Alt text][8]
	4.	按一下 [新增] 以加入新的規則。這會將您帶到新的刀鋒視窗。

## 建立規則
規則是條件和動作陳述式的集合。如果條件評估為 true，則會執行動作。在 [建立規則] 刀鋒視窗中，提供唯一的規則名稱 (適用於該原則) 和描述 (選擇性)。
[條件] 方塊可用來建立複雜的條件陳述式。支援下列關鍵字：  
1. 	And - 條件運算子  
2. 	Or - 條件運算子  
3. 	does\_not\_exist  
4. 	exists  
5. 	false  
6. 	is\_equal\_to  
7. 	is\_greater\_than  
8. 	is\_greater\_than\_equal\_to  
9. 	is\_in  
10. is\_less\_than  
11. is\_less\_than\_equal\_to  
12. is\_not\_in  
13. is\_not\_equal\_to  
14. mod  
15. true  

[Action(Then)] 方塊可包含多個陳述式 (每行一個陳述式)，以建立要執行的動作。支援下列關鍵字：  
1.	equals  
2.	false  
3.	true  
4.	halt  
5.	mod  
6.	null  
7.	update  

條件和動作方塊提供 Intellisense 來協助使用者快速撰寫規則。按 ctrl + 空格或只要開始輸入，即可觸發。比對具型別字元的關鍵字將會自動向下篩選及顯示。Intellisense 視窗會顯示所有的關鍵字和詞彙定義。
![Alt text][9]

## 明確向前鏈結
BizTalk 規則支援明確向前鏈結。意思就是如果使用者想要重新評估規則，以回應特定動作，他們可以使用某些關鍵字加以觸發。以下是支援的關鍵字：  
   1.	update < 詞彙定義> - 這個關鍵字會重新評估在其條件中使用指定之詞彙定義的所有規則。  
   2.	Halt - 這個關鍵字會停止所有規則執行

## 啟用\停用規則
可以啟用或停用原則中的每個規則。預設會啟用所有規則。在原則執行期間不會執行已停用的規則。可以直接從規則刀鋒視窗啟用\停用規則 - 命令可在刀鋒視窗頂端的命令列中取得或從原則取得，內容功能表 (在規則上按一下滑鼠右鍵) 具有啟用 \ 停用的選項。

## 規則優先順序
原則的所有規則會依序執行。執行的優先順序取決於規則出現在原則中的順序。拖放規則即可變更此優先順序。 

## 測試原則
撰寫原則之後，將它用於實際執行環境之前，必須先測試原則。使用 "Test Policy" 命令，使用者即可進入 [測試原則] 刀鋒視窗。在這個刀鋒視窗中，您可以看到使用於需要使用者輸入之原則中的詞彙定義清單。使用者可以針對測試案例手動新增這些輸入的值。或者，使用者也可以選擇匯入測試 XML 做為輸入。一旦備妥所有輸入，即可執行測試，而每個詞彙定義的輸出將會顯示在輸出資料行中以便簡單。若要檢視商務分析師易用的記錄檔，請按一下 [檢視記錄檔 ] 以檢視執行記錄檔。若要儲存記錄檔，[儲存輸出] 選項可用來儲存所有測試相關資料，以便進行獨立分析。

## 在邏輯應用程式中使用規則
撰寫並測試原則之後，現在即可供取用。使用者可以透過 [新增] -> [邏輯應用程式]，建立新的邏輯應用程式。在設計工具中，BizTalk 規則  位於右側的組件庫中。現在即可將其拖放到設計工具介面。完成後，將會有一個選項可選擇規則 API 應用程式 (動作) 的目標。動作包括要執行的原則清單。選擇特定原則，其後需要輸入原則所需的輸入。使用者可以使用規則 API 應用程式下游的輸出，進一步進行決策。

## 透過 API 使用規則
使用一組豐富的可用 API，也可以叫用規則 API 應用程式。如此一來，使用者就不受限於只能使用流程，發出 REST 呼叫即可在任何應用程式中使用規則。按一下 [規則] 儀表板中的 [API 定義] 透鏡，即可檢視確切可用的 REST API。
![Alt text][10]

## 編輯詞彙和原則
使用商務規則的主要優點之一，就是可以更快速地將商務邏輯的變更發送至實際執行環境。對詞彙和原則所做的變更會立即套用在實際執行環境中。使用者只需瀏覽至各自的詞彙定義或原則，並且讓變更開始生效。

<!--Image references-->
[1]: ./media/app-service-logic-biztalk-rules/InsuranceScenario.PNG	
[2]: ./media/app-service-logic-biztalk-rules/InsuranceBusinessLogic.png
[3]: ./media/app-service-logic-biztalk-rules/CreateRuleApiApp.png
[4]: ./media/app-service-logic-biztalk-rules/RulesDashboard.png
[5]: ./media/app-service-logic-biztalk-rules/LiteralVocab.PNG
[6]: ./media/app-service-logic-biztalk-rules/XMLVocab.PNG
[7]: ./media/app-service-logic-biztalk-rules/BulkAdd.PNG
[8]: ./media/app-service-logic-biztalk-rules/PolicyList.PNG
[9]: ./media/app-service-logic-biztalk-rules/RuleCreate.PNG
[10]: ./media/app-service-logic-biztalk-rules/APIDef.PNG


<!--HONumber=49-->