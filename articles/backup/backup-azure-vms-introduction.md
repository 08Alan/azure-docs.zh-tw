---
title: 關於 Azure VM 備份
description: 深入了解 Azure VM 備份，並記下一些最佳做法。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/17/2019
ms.author: raynew
ms.openlocfilehash: c38c457bbf428d7252cf57168685201a2ca227ba
ms.sourcegitcommit: 6cab3c44aaccbcc86ed5a2011761fa52aa5ee5fa
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/20/2019
ms.locfileid: "56446795"
---
# <a name="about-azure-vm-backup"></a>關於 Azure VM 備份

本文說明 [Azure 備份服務](backup-introduction-to-azure-backup.md)如何備份 Azure VM。

## <a name="backup-process"></a>備份程序

以下是 Azure 備份完成 Azure VM 備份的方式。

1. 對於已選取要備份的 Azure VM，Azure 備份服務會根據您指定的備份排程開始備份工作。
2. 第一次備份時，會在執行中的 VM 上安裝備份擴充功能。
    - 如果是 Windows VM，會安裝 VMSnapshot 擴充功能。
    - 如果是 Linux VM，則會安裝 VMSnapshot Linux 擴充功能。
3. 對於執行中的 Windows VM，「備份」會與 VSS 協調，以建立 VM 的應用程式一致快照集。
    - 根據預設，「備份」會建立完整的 VSS 備份。
    - 如果備份無法擷取應用程式一致快照集，則會擷取基礎儲存體的檔案一致快照集 (因為 VM 停止時不會發生任何應用程式寫入)。
4. 對於 Linux VM，「備份」會建立檔案一致備份。 若要建立應用程式一致快照集，您必須手動自訂前置/後置指令碼。
5. 建立快照集之後，資料會傳輸至保存庫。 
    - 藉由平行備份每個 VM 磁碟，可將備份作業最佳化。
    - 針對每個要備份的磁碟，Azure 備份會讀取磁碟上的區塊，並只識別及傳輸自上一次備份以來有變更的資料區塊 (也就是差異部分)。
    - 建立快照集之後，資料會傳輸至保存庫。
    - 快照集資料可能不會立即複製到保存庫。 這在尖峰時間可能需耗費數小時。 根據每日備份原則，VM 的總備份時間會小於 24 小時。

6. 資料傳輸完畢後，系統會移除快照集並建立復原點。

![Azure 虛擬機器備份架構](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encrypting-azure-vm-backups"></a>加密 Azure VM 備份

當您使用 Azure 備份來備份 Azure VM 時，VM 會透過儲存體服務加密 (SSE) 來執行待用加密。 此外，Azure 備份可備份使用 Azure 磁碟加密 (ADE) 進行加密的 Azure VM。


**加密** | **詳細資料** | **支援**
--- | --- | ---
**ADE** | ADE 可對 Azure VM 的 OS 和資料磁碟進行加密。<br/><br/> ADE 會與 BitLocker 加密金鑰 (BEK) 整合 (以祕密形式放在金鑰保存庫中保護)，或與 Azure Key Vault 金鑰加密金鑰 (KEK) 整合。 | Azure 備份僅支援使用 BEK 或 BEK 搭配 KEK 加密的受控和非受控 Azure VM。<br/><br/> BEK 和備份都會加密。<br/><br/> 由於會備份 KEK 與 BEK，如有需要，具有權限的使用者可以將金鑰和祕密還原至金鑰保存庫，並復原加密的 VM。<br/><br/> 未經授權的使用者或 Azure 都無法讀取加密的金鑰和祕密。
**SSE** | 透過 SSE，Azure 儲存體會提供待用加密，在儲存資料之前先自動將資料加密，並會在擷取資料前將資料解密。 | Azure 備份會在 Azure VM 的待用加密上使用 SSE。

- 對於受控和非受控 Azure VM，支援備份使用 BitLocker 加密金鑰 (BEK) 加密的 VM，以及使用金鑰加密金鑰 (KEK) 搭配 BEK 加密的 VM。
- 備份的 BEK (秘密) 和 KEK (金鑰) 都會加密。 只有當已授權的使用者將這些項目還原至金鑰保存庫時，才能讀取和使用這些項目。 未經授權的使用者和 Azure 都不可以讀取或使用備份金鑰或祕密。
- 由於 BEK 也經過備份，因此，BEK 遺失時，經過授權的使用者可以將 BEK 還原至 KeyVault 並復原加密的 VM。 
- 只有具備適當權限等級的使用者，才能備份和還原已加密的 VM，以及金鑰和密碼。



## <a name="taking-snapshots"></a>擷取快照集

Azure 備份快照集會根據備份排程執行。 

- **Windows VM**：對於 Windows VM，備份服務會與磁碟區陰影複製服務 (VSS) 協調，以擷取 VM 磁碟的應用程式一致快照集。
    - 根據預設，Azure 備份會建立完整的 VSS 備份。 [深入了解](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
    - 如果您想要變更設定，以便 Azure 備份建立 VSS 複製備份，請從命令提示字元設定下列登錄機碼：**REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**。
- **Linux VM**：如果您想要擷取 Linux VM 的應用程式一致快照集，請使用 Linux 前置指令碼和後置指令碼架構來撰寫您自己自訂指令碼，以確保一致性。
    -  Azure 備份只會叫用您撰寫的前置指令碼/後置指令碼。
    - 如果前置指令碼和後置指令碼順利執行，Azure 備份會將復原點標記為應用程式一致。 但是，您要對使用自訂指令碼時的應用一致性負最終責任。
    - [進一步了解](backup-azure-linux-app-consistent.md)關於設定指令碼。


### <a name="snapshot-consistency"></a>快照集一致性

下表說明不同類型的一致性。

**快照集** | **詳細資料** | **復原** | **考量**
--- | --- | --- | ---
**應用程式一致** | 應用程式一致的備份會擷取記憶體內容和擱置 I/O 作業。 應用程式一致快照會使用 VSS 寫入器 (或 Linux 的前置/後置指令碼)，以確保應用程式資料的一致性，再進行備份。 | 使用應用程式一致快照集復原時，虛擬機器會啟動。 沒有任何資料損毀或遺失。 應用程式會以一致的狀態開始。 | Windows:所有 VSS 寫入器都已成功<br/><br/> Linux：前置/後置指令碼已設定並成功
**檔案系統一致** | 檔案一致備份會同時建立所有檔案的快照集，以便提供磁碟檔案的一致備份。<br/><br/> | 使用檔案一致快照集復原時，虛擬機器會啟動。 沒有任何資料損毀或遺失。 應用程式必須實作自己的「修正」機制，以確保還原的資料一致。 | Windows:部分 VSS 寫入器失敗 <br/><br/> Linux：預設值 (如果前置/後置指令碼未設定或失敗)
**絕對一致** | 絕對一致性通常會發生在 Azure VM 在備份期間關閉時。  只會擷取備份時已存在磁碟上的資料，並加以備份。<br/><br/> 絕對一致性復原點並不保證作業系統或應用程式的資料一致性。 | 雖然不保證，不過，通常在虛擬機器開機時，後續的磁碟檢查會修正損毀錯誤。 任何記憶體中的資料或未傳送到磁碟的寫入都會遺失。 應用程式會實作本身的資料驗證。 例如，對於資料庫應用程式，如果交易記錄中有項目不存在資料庫中，則資料庫軟體會執行復原，直到資料變成一致為止。 | VM 處於關機狀態


## <a name="restore-considerations"></a>還原考量 



**考量** | **詳細資料**
--- | ---
**磁碟** | VM 磁碟的備份會平行進行。 例如，如果 VM 有四個磁碟，服務便會嘗試平行備份全部四個磁碟。 備份是累進的 (僅備份已變更的資料)。
**排程** |  若要減少備份流量，請在同一天的不同時段備份不同的 VM，時間不要重疊。 同時間備份多個 VM 會導致流量壅塞。
**準備備份** | 請考慮備份的準備時間，其中包含安裝或更新備份擴充功能，以及根據備份排程觸發快照。
**資料傳輸** | 備份服務計算上次備份以來所增變更的所需時間。<br/><br/> 在增量備份中，服務會計算區塊的總和檢查碼，以判斷有哪些變更。 系統會識別已變更的區塊並將其傳送到保存庫。 服務會深入探詢已識別到的區塊，以嘗試進一步減少要傳輸的資料。 評估所有變更的區塊之後，這些變更就會傳輸至保存庫中。<br/><br/> 擷取快照集和將其複製到保存庫之間可能會有延遲。<br/><br/> 在尖峰時間，備份程序可能需要最多八小時。 若每日備份，則 VM 的備份時間會小於 24 小時。
**初始備份** | 雖然小於 24 小時的備份時間總計適用於增量備份，但可能不適合第一次備份。 所需的時間取決於進行備份時的資料大小。
**還原佇列** | Azure 備份會同時處理來自多個儲存體帳戶的還原作業，並將還原要求放入佇列中。
**還原複本** | 進行還原時，資料會從保存庫複製到儲存體帳戶。<br/><br/> 還原時間取決於儲存體帳戶的 IOPS 和輸送量。<br/><br/> 若要減少複製時間，請選取未使用其他應用程式寫入或讀取載入的儲存體帳戶。


### <a name="backup-performance"></a>備份效能

這些常見的案例可能會影響備份時間：

- 將新的磁碟新增至受保護的 Azure VM 中：如果 VM 正在進行增量備份，同時新增了新磁碟，則備份時間可能會超過 24 小時，因為需進行新磁碟的初始複寫，以及現有磁碟的差異複寫。
- 分散的磁碟：若磁碟的變更很集中，則備份作業會比較快。 如果變更分散在磁碟中，則備份會必較慢。 
- 磁碟變換：如果正在進行增量備份的受保護磁碟每天有 200 GB 以上的變換，則備份可能需要很長的時間 (超過八個小時) 來完成。 
- 備份版本：如果您使用最新版的備份 (稱為「立即還原」版本)，該備份會使用更為最佳化的程序來比對變更，而不是使用總和檢查碼。 如果您使用最新版本，但已刪除備份快照集，則備份會轉換為使用總和檢查碼比對，而備份作業將會超過 24 小時 (或失敗)。

## <a name="best-practices"></a>最佳作法 
設定虛擬機器備份時，建議您遵循下列做法：

- 考慮修改原則中設定的預設排程時間。 例如，如果原則中的預設時間是凌晨 12:00，請考慮增加幾分鐘，以最佳化資源的使用。
- 針對「進階 VM」，非「立即 RP」功能的備份會配置 ~50% 的總儲存體帳戶空間。 備份服務需要此空間以將快照集複製到相同的儲存體帳戶，以及將其傳輸至保存庫。
- 針對從單一保存庫還原 VM 的情況，強烈建議您使用不同的 [v2 儲存體帳戶](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)以確保不會對目標儲存體帳戶進行節流。 例如，每個 VM 都必須有不同的儲存體帳戶 (如果還原 10 個 VM，請考慮使用 10 個不同的儲存體帳戶)。
- 從第 1 層儲存層 (快照集) 還原會在幾分鐘內完成 (因為是相同儲存體帳戶)，對比之下，第 2 層儲存層 (保存庫) 則需要數小時。 針對可在第 1 層取得資料的情況，建議您使用[立即還原](backup-instant-restore-capability.md)功能 (如果必須從保存庫還原資料，則將需要一些時間)。
- 對每一儲存體帳戶的磁碟數目限制，與在 IaaS VM 上執行的應用程式對磁碟的存取次數多寡有關。 請確認是否在單一儲存體帳戶上裝載了多個磁碟。 一般做法是，如果單一儲存體帳戶上有 5 到 10 個磁碟或更多磁碟，請將部分磁碟移至個別的儲存體帳戶來平衡負載。

## <a name="backup-costs"></a>備份成本

使用 Azure 備份所備份的 Azure VM 適用 [Azure 備份定價](https://azure.microsoft.com/pricing/details/backup/)。

- 第一次成功備份完成後才會開始計費。 儲存體和受保護的 VM 也會在此同時開始計費。
- 只要 VM 有任何備份資料儲存在保存庫，就會繼續計費。 如果您停止保護 VM，但 VM 的備份資料仍在保存庫中，則還是會繼續計費。
- 只有在停止保護且刪除全部備份資料時，才會對指定的虛擬機器停止計費。
- 當保護停止且沒有任何作用中的備份作業時，最後一個成功 VM 備份的大小會成為每月帳單所使用的受保護執行個體大小。
- 受保護的執行個體是根據 VM 的「實際」大小來計算，也就是 VM 中暫存空間除外的所有資料總和。
- 而是根據儲存在資料磁碟中的實際資料來定價。
- 連結到 VM 的每個資料磁碟上所能支援的大小上限，並非備份 VM 定價的依據。
- 同樣地，備份儲存體帳單也是根據 Azure 備份所儲存的資料計費，也就是每個復原點所儲存的實際資料總和。

例如，A2 標準大小的 VM 擁有兩個額外資料磁碟，每個大小上限為 4 TB。 下表提供上述每個磁碟實際儲存的資料：

**磁碟** | **大小上限** | **實際儲存的資料**
--- | --- | ---
作業系統磁碟 | 4095 GB | 17 GB 
本機/暫存磁碟 | 135 GB | 5 GB (未包含備份) 
資料磁碟 1 | 4095 GB | 30 GB 
資料磁碟 2 | 4095 GB | 0 GB 

- 在此案例中，VM 的實際容量為 17 GB + 30 GB + 0 GB = 47 GB。
- 這個受保護的執行個體大小 (47 GB) 會成為每月計費的依據。
- 當 VM 的資料量增加時，用於計費的受保護執行個體大小也會隨之變更。


## <a name="next-steps"></a>後續步驟

現在，請為 Azure VM 備份[做好準備](backup-azure-arm-vms-prepare.md)。
